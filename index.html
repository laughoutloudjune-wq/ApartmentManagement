<!--
  ========================== README (UI Scaffold) ==========================
  Apartment Management Web App (UI-Only, No Backend) ‚Äî PART 1
  - Open locally: Save all PARTs as .html.txt fragments or .part files. You can
    preview this single PART directly to see the running Dashboard scaffold.
  - Host on GitHub Pages (later after stitching):
      1) Concatenate parts into one file (see stitcher below) -> index.html
      2) Push to a public GitHub repo (main branch) at root
      3) Settings ‚Üí Pages ‚Üí Build from branch ‚Üí root (index.html)
  - Print to PDF:
      - Use the Print buttons in the app (opens print layout modal, @media print)
  - Tech rules:
      - Single-file goal (HTML+CSS+JS inline). No external libs. Mock data only.
      - WCAG AA contrast, keyboard support (Tab/Enter/Esc), ARIA labels.
      - Desktop-first; mobile stacks. Light/Dark toggle. System font stack.
  - TODO markers:
      // TODO: Google Sheets, // TODO: Backend Storage (future wiring points)
  ========================================================================
-->

<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 1 START =================================================== -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Apartment Management (UI-Only) ‚Äî Desktop-First Scaffold</title>

<style>
  /* ========================= CSS VARIABLES ========================= */
  :root {
    /* Palette (light) */
    --bg: #f7f8fa;
    --panel: #ffffff;
    --text: #0f172a;        /* slate-900 */
    --muted: #475569;       /* slate-600 */
    --border: #e5e7eb;      /* gray-200 */
    --shadow: 0 10px 25px rgba(2,6,23,0.08);
    --pill-shadow: 0 2px 6px rgba(2,6,23,0.12);

    /* Accents */
    --pri: #2563eb;         /* blue-600 */
    --pri-weak: #93c5fd;    /* blue-300 */
    --ok: #16a34a;          /* green-600 */
    --warn: #f59e0b;        /* amber-500 */
    --err: #ef4444;         /* red-500 */
    --neutral: #6b7280;     /* gray-500 */

    /* States */
    --hover: rgba(37,99,235,0.08);
    --focus: 0 0 0 3px rgba(37,99,235,0.35);

    /* Typography & radius */
    --radius: 14px;
    --radius-sm: 10px;
    --radius-lg: 18px;
    --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
            Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;

    /* Table */
    --row-alt: #f9fafb;
  }

  /* Dark mode tokens */
  :root[data-theme="dark"] {
    --bg: #0b1220;
    --panel: #0f172a;
    --text: #e5e7eb;
    --muted: #94a3b8;
    --border: #1f2a3b;
    --shadow: 0 12px 28px rgba(0,0,0,0.45);
    --row-alt: #0d1628;
    --hover: rgba(147,197,253,0.08);
    --focus: 0 0 0 3px rgba(147,197,253,0.35);
  }

  /* ========================= RESET / BASE ========================= */
  *,*::before,*::after { box-sizing: border-box; }
  html,body { height: 100%; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    line-height: 1.45;
  }
  a { color: inherit; text-decoration: none; }
  button { font: inherit; cursor: pointer; }
  img { max-width: 100%; height: auto; display: block; }

  /* ========================= LAYOUT ========================= */
  .app {
    display: grid;
    grid-template-columns: 280px 1fr;
    min-height: 100dvh;
  }
  .sidebar {
    position: sticky;
    top: 0;
    align-self: start;
    height: 100dvh;
    padding: 18px;
    background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.2));
    backdrop-filter: blur(12px);
    border-right: 1px solid var(--border);
  }
  [data-theme="dark"] .sidebar {
    background: linear-gradient(180deg, rgba(15,23,42,0.7), rgba(15,23,42,0.2));
  }

  .brand {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 16px;
  }
  .brand-logo {
    width: 40px; height: 40px; border-radius: 12px;
    background: radial-gradient(circle at 30% 30%, var(--pri), #4f46e5);
    box-shadow: var(--shadow);
  }
  .brand h1 { font-size: 18px; margin: 0; }
  .brand small { display:block; color: var(--muted); }

  .nav {
    margin-top: 16px;
    display: grid; gap: 6px;
  }
  .nav button {
    text-align: left;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid transparent;
    background: transparent;
    color: var(--text);
  }
  .nav button[aria-current="page"] {
    background: var(--hover);
    border-color: var(--border);
  }
  .nav button:focus-visible {
    outline: none; box-shadow: var(--focus);
  }

  .sidebar-footer {
    position: absolute; left: 18px; right: 18px; bottom: 18px;
    display: flex; gap: 10px; align-items: center; justify-content: space-between;
  }

  .main {
    padding: 20px 24px 80px;
  }

  .topbar {
    display: flex; align-items: center; gap: 12px; justify-content: space-between;
    margin-bottom: 16px;
  }
  .search {
    display: flex; align-items: center; gap: 8px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 8px 12px;
    box-shadow: var(--shadow);
    max-width: 520px; width: 100%;
  }
  .search input {
    border: none; outline: none; background: transparent; width: 100%;
    color: var(--text);
  }

  .btn {
    padding: 10px 14px; border-radius: 999px; border: 1px solid var(--border);
    background: var(--panel);
    box-shadow: var(--shadow);
  }
  .btn.primary { background: var(--pri); color: white; border-color: rgba(0,0,0,0); }
  .btn.ghost { background: transparent; }
  .btn:focus-visible { outline: none; box-shadow: var(--focus); }

  .grid {
    display: grid; gap: 16px;
  }
  .grid.cards { grid-template-columns: repeat(12, 1fr); }
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 16px;
  }
  .kpi {
    grid-column: span 3;
  }
  .kpi h3 { margin: 0 0 6px 0; font-size: 14px; color: var(--muted); }
  .kpi .value { font-size: 28px; font-weight: 700; }

  .quick-actions { display: flex; gap: 10px; flex-wrap: wrap; }

  /* Pills */
  .pill {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 6px 10px; border-radius: 999px; font-size: 12px;
    box-shadow: var(--pill-shadow);
    border: 1px solid var(--border);
    background: var(--panel);
  }
  .pill.gray { color: var(--neutral); }
  .pill.amber { color: #b45309; background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.25); }
  .pill.green { color: #047857; background: rgba(16,185,129,0.12); border-color: rgba(16,185,129,0.25); }
  .pill.red { color: #991b1b; background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.25); }

  /* Tables (we‚Äôll use later in Rooms/Payments/Reports) */
  table { width: 100%; border-collapse: separate; border-spacing: 0; }
  th, td { text-align: left; padding: 12px 10px; }
  thead th {
    position: sticky; top: 0; z-index: 1;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
  }
  tbody tr { border-bottom: 1px solid var(--border); }
  tbody tr:nth-child(even) { background: var(--row-alt); }

  /* Overlay / Modal */
  .overlay {
    position: fixed; inset: 0; display: none; place-items: center;
    background: rgba(2,6,23,0.35); backdrop-filter: blur(6px);
  }
  .overlay.open { display: grid; }
  .sheet {
    width: min(1100px, calc(100vw - 24px));
    height: min(82vh, 840px);
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    display: grid; grid-template-rows: auto 1fr auto;
    overflow: hidden;
  }
  .sheet header, .sheet footer {
    padding: 12px 16px; border-bottom: 1px solid var(--border);
  }
  .sheet footer { border-top: 1px solid var(--border); border-bottom: none; }
  .sheet main { overflow: auto; padding: 16px; }

  /* Tabs */
  .tabs { display: flex; gap: 8px; flex-wrap: wrap; }
  .tabs button {
    padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border);
    background: transparent;
  }
  .tabs button[aria-selected="true"] {
    background: var(--hover);
  }

  /* Mobile responsive tweaks */
  @media (max-width: 980px) {
    .app { grid-template-columns: 1fr; }
    .sidebar {
      position: static; height: auto; border-right: none; border-bottom: 1px solid var(--border);
    }
    .grid.cards .kpi { grid-column: span 6; }
  }
  @media (max-width: 640px) {
    .grid.cards .kpi { grid-column: span 12; }
    .topbar { flex-direction: column; align-items: stretch; }
    .quick-actions { width: 100%; }
  }

  /* Print basics (we‚Äôll extend in the builder part) */
  @media print {
    .sidebar, .topbar, .quick-actions { display: none !important; }
    .main { padding: 0; }
    body { background: white; color: black; }
  }
</style>
</head>
<body>
<div id="app" class="app" data-theme="light" aria-live="polite">
  <!-- ========================= SIDEBAR ========================= -->
  <aside class="sidebar" aria-label="Primary">
    <div class="brand" tabindex="0" aria-label="Brand">
      <div class="brand-logo" aria-hidden="true"></div>
      <div>
        <h1>Apartment Admin</h1>
        <small>Desktop-first UI</small>
      </div>
    </div>

    <nav class="nav" role="navigation" aria-label="Main Navigation">
      <button data-route="dashboard" aria-current="page">üìä Dashboard</button>
      <button data-route="rooms">üè¢ Rooms</button>
      <button data-route="renters">üë• Renters</button>
      <button data-route="payments">üí∏ Payments</button>
      <button data-route="builder">üßæ Invoices & Receipts</button>
      <button data-route="reports">üìà Reports</button>
      <button data-route="files">üñºÔ∏è Files</button>
      <button data-route="settings">‚öôÔ∏è Settings</button>
    </nav>

    <div class="sidebar-footer">
      <button id="themeToggle" class="btn" aria-pressed="false" aria-label="Toggle theme">üåó Theme</button>
      <a class="btn ghost" href="#" id="keyboardHelp">‚å®Ô∏è Keys</a>
    </div>
  </aside>

  <!-- ========================= MAIN ========================= -->
  <main class="main" id="main" tabindex="-1">
    <div class="topbar" role="search">
      <div class="search" aria-label="Global search">
        <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M10 2a8 8 0 105.293 14.293l4.207 4.207 1.414-1.414-4.207-4.207A8 8 0 0010 2zm0 2a6 6 0 110 12A6 6 0 0110 4z"/></svg>
        <input id="globalSearch" type="search" placeholder="Search renter, room, invoice‚Ä¶" aria-label="Search input">
      </div>
      <div class="quick-actions" aria-label="Quick actions">
        <button class="btn" data-action="addRenter">‚ûï Add Renter</button>
        <button class="btn" data-action="createInvoice">üßæ Create Invoice</button>
        <button class="btn" data-action="recordPayment">üí≥ Record Payment</button>
      </div>
    </div>

    <!-- ========== VIEW CONTAINER (router renders here) ========== -->
    <section id="view"></section>
  </main>
</div>

<!-- ========================= OVERLAY (shared) ========================= -->
<div class="overlay" id="overlay" aria-hidden="true" aria-label="Dialog overlay">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <header>
      <strong id="sheetTitle">Overlay</strong>
    </header>
    <main id="sheetBody">
      <!-- dynamic -->
    </main>
    <footer>
      <button class="btn" id="sheetClose">Close (Esc)</button>
    </footer>
  </div>
</div>

<!-- ========================= TOAST ========================= -->
<div id="toast" aria-live="polite" aria-atomic="true" style="position:fixed;bottom:20px;right:20px;display:none;"></div>

<script>
/* ========================= UTIL: A11y & Helpers ========================= */
const $ = (q, el=document) => el.querySelector(q);
const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

const Toast = {
  show(msg, ms=1600) {
    const t = $('#toast');
    t.style.display = 'block';
    t.innerHTML = '<div style="background:var(--panel);border:1px solid var(--border);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow)">' + msg + '</div>';
    clearTimeout(Toast._id);
    Toast._id = setTimeout(()=>{ t.style.display='none'; t.innerHTML=''; }, ms);
  }
};

function escClose(e) {
  if (e.key === 'Escape') closeOverlay();
}

function openOverlay(title, node) {
  const overlay = $('#overlay');
  $('#sheetTitle').textContent = title;
  const body = $('#sheetBody');
  body.innerHTML = '';
  if (node) body.appendChild(node);
  overlay.classList.add('open');
  overlay.setAttribute('aria-hidden', 'false');
  document.addEventListener('keydown', escClose);
  $('#sheetClose').focus();
}
function closeOverlay() {
  const overlay = $('#overlay');
  overlay.classList.remove('open');
  overlay.setAttribute('aria-hidden', 'true');
  document.removeEventListener('keydown', escClose);
}

/* ========================= THEME TOGGLE ========================= */
(function initTheme() {
  const root = document.documentElement;
  const saved = localStorage.getItem('theme');
  if (saved) root.setAttribute('data-theme', saved);
  $('#themeToggle').addEventListener('click', () => {
    const current = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    root.setAttribute('data-theme', current);
    localStorage.setItem('theme', current);
    const pressed = current === 'dark';
    $('#themeToggle').setAttribute('aria-pressed', String(pressed));
  });
})();

/* ========================= MOCK STATE ========================= */
/** Central mock store ‚Äî later we‚Äôll sync to Google Sheets.
//  TODO: Google Sheets ‚Äî hydrate/persist store.
*/
const Store = {
  now: new Date(),
  rooms: [],       // populated below (101‚Äì120)
  renters: [],     // 8‚Äì12 Thai names
  invoices: [],    // 6‚Äì10 mixed statuses
  bankAccounts: [
    { id:'b1', bank:'Kasikorn', name:'East Home Property', acct:'123-4-56789-0' },
    { id:'b2', bank:'SCB',      name:'East Home Property', acct:'987-6-54321-0' },
    { id:'b3', bank:'Krungthai',name:'East Home Property', acct:'654-3-21098-7' },
  ],
  addresses: [
    { id:'a1', name:'Suwann Apartment', addr:'99/9 Ban Kao Rd, Chonburi' },
    { id:'a2', name:'East Home Property HQ', addr:'88/8 Amata City, Chonburi' },
  ],
  utilities: { elecRate: 8.50, waterRate: 18.00 },
  defaults: { roomRate: 4500, lateFee: { type:'flat', value:200 }, depositPolicy:'Refund within 30 days.' },
  files: [], // base64 slips in memory
  _seeded: false,
};

function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function currency(num){ return '‡∏ø' + Number(num).toLocaleString('en-TH', {maximumFractionDigits:2}); }
function monthKey(d=new Date()){ return d.toISOString().slice(0,7); } // yyyy-mm

function seedMock() {
  if (Store._seeded) return;
  // Rooms 101‚Äì120
  for (let n=101; n<=120; n++){
    Store.rooms.push({
      id: String(n), roomNo: String(n),
      status: 'vacant', // updated if assigned
      rate: 4000 + (Math.random()>0.6 ? 500 : 0),
      renterId: null,
      payMethodId: rand(Store.bankAccounts).id,
    });
  }
  // Renters (Thai names)
  const thai = ['‡∏™‡∏°‡∏ä‡∏≤‡∏¢', '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á', '‡∏ß‡∏¥‡∏†‡∏≤', '‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥', '‡∏õ‡∏ß‡∏µ‡∏ì‡∏≤', '‡∏™‡∏∏‡∏ä‡∏≤‡∏ï‡∏¥', '‡∏ä‡∏•‡∏ò‡∏¥‡∏ä‡∏≤', '‡∏ô‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏®‡∏∏‡∏†‡∏ä‡∏±‡∏¢', '‡∏û‡∏¥‡∏ä‡∏ç‡∏≤', '‡∏®‡∏¥‡∏£‡∏¥‡∏û‡∏£', '‡∏ó‡∏®‡∏û‡∏•'];
  const take = 10 + Math.floor(Math.random()*3); // 10‚Äì12
  const occupiedRooms = new Set();
  for (let i=0; i<take; i++){
    const name = thai[i % thai.length] + ' ' + '‡πÉ‡∏à‡∏î‡∏µ';
    // assign a room randomly not already taken
    let room = null;
    while(!room){
      const r = rand(Store.rooms);
      if (!occupiedRooms.has(r.id)){
        room = r; occupiedRooms.add(r.id);
      }
    }
    const renter = {
      id: 'r'+(i+1),
      name, phone: '08x-xxx-xxxx', address: '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ',
      roomId: room.id,
      balance: (Math.random()>0.7) ? 0 : (Math.random()>0.5 ? 500 : 0),
      contract: {
        start: '2025-01-01', end: '2025-12-31', depositPaidOn: '2025-01-01',
        depositSlip: null // base64 placeholder later
      }
    };
    Store.renters.push(renter);
    room.status = renter.balance>0 ? 'unpaid' : 'occupied';
    room.renterId = renter.id;
  }

  // Invoices (6‚Äì10)
  const statuses = ['draft','sent','paid','overdue'];
  const invCount = 6 + Math.floor(Math.random()*5);
  for (let i=0; i<invCount; i++){
    const r = rand(Store.renters);
    const total = (Store.rooms.find(x=>x.id===r.roomId)?.rate ?? Store.defaults.roomRate)
      + (Math.random()>0.6 ? 300 : 0)
      + (Math.random()>0.6 ? 150 : 0);
    Store.invoices.push({
      id: 'inv'+(i+1),
      roomId: r.roomId,
      renterId: r.id,
      yyyymm: monthKey(),
      total,
      status: rand(statuses),
      method: rand(['Cash','Bank Transfer','PromptPay','Credit Card']),
      slip: null
    });
  }
  Store._seeded = true;
}
seedMock();

/* ========================= ROUTER ========================= */
const Router = {
  current: 'dashboard',
  navigate(route){
    Router.current = route;
    // update active
    $$('.nav button').forEach(b=>{
      b.setAttribute('aria-current', b.dataset.route===route ? 'page' : 'false');
    });
    // render
    Views[route]?.();
    // focus main for a11y
    $('#main').focus();
    // persist
    localStorage.setItem('route', route);
  },
  init(){
    const saved = localStorage.getItem('route');
    if (saved && Views[saved]) Router.current = saved;
    $$('.nav button').forEach(b=>{
      b.addEventListener('click', ()=> Router.navigate(b.dataset.route));
    });
    Router.navigate(Router.current);
  }
};

/* ========================= VIEWS ========================= */
const Views = {
  dashboard(){
    const wrap = document.createElement('div');
    // KPI cards
    const totalRooms = Store.rooms.length;
    const occupied = Store.rooms.filter(r=>r.status==='occupied').length;
    const vacant = Store.rooms.filter(r=>!r.renterId).length;
    const unpaidRooms = Store.rooms.filter(r=>r.status==='unpaid').length;
    const collected = Store.invoices.filter(i=>i.status==='paid').reduce((a,b)=>a+b.total,0);

    wrap.innerHTML = `
      <div class="grid cards" style="margin-bottom:12px">
        ${KPI('Total Rooms', totalRooms)}
        ${KPI('Occupied', occupied)}
        ${KPI('Vacant', vacant)}
        ${KPI('Unpaid (this month)', unpaidRooms)}
        ${KPI('Collected (this month)', currency(collected))}
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h2 style="margin:0;font-size:18px">Recent Invoices</h2>
          <span class="pill gray">Mock data</span>
        </div>
        ${InvoiceTable(Store.invoices.slice(0,8))}
      </div>
    `;
    $('#view').replaceChildren(wrap);
  },

  // placeholders; implemented in subsequent parts
  rooms(){ $('#view').innerHTML = Placeholder('Rooms (Floor Plan)'); },
  renters(){ $('#view').innerHTML = Placeholder('Renters'); },
  payments(){ $('#view').innerHTML = Placeholder('Payments'); },
  builder(){ $('#view').innerHTML = Placeholder('Invoices & Receipts Builder'); },
  reports(){ $('#view').innerHTML = Placeholder('Reports'); },
  files(){ $('#view').innerHTML = Placeholder('Files'); },
  settings(){ $('#view').innerHTML = Placeholder('Settings'); },
};

/* ========================= COMPONENTS ========================= */
function KPI(label, value){
  return `
    <div class="card kpi" role="group" aria-label="${label}">
      <h3>${label}</h3>
      <div class="value">${value}</div>
    </div>
  `;
}

function InvoiceTable(list){
  const pill = (status)=>{
    const map = { draft:'gray', sent:'amber', paid:'green', overdue:'red' };
    return `<span class="pill ${map[status]||'gray'}" aria-label="status ${status}">${status}</span>`;
  };
  const rows = list.map(inv=>{
    const room = Store.rooms.find(r=>r.id===inv.roomId)?.roomNo ?? '‚Äî';
    const renter = Store.renters.find(r=>r.id===inv.renterId)?.name ?? '‚Äî';
    return `
      <tr>
        <td>${room}</td>
        <td>${renter}</td>
        <td>${inv.yyyymm}</td>
        <td>${currency(inv.total)}</td>
        <td>${pill(inv.status)}</td>
        <td><button class="btn" data-open-invoice="${inv.id}" aria-label="Open invoice ${inv.id}">Open</button></td>
      </tr>
    `;
  }).join('');
  return `
    <div style="overflow:auto">
      <table aria-label="Recent invoices">
        <thead>
          <tr><th>Room</th><th>Renter</th><th>Month</th><th>Total</th><th>Status</th><th></th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
}

function Placeholder(title){
  return `
    <div class="card" role="status" aria-live="polite">
      <h2 style="margin:0 0 8px 0">${title}</h2>
      <p style="color:var(--muted)">This section will be delivered in the next part. UI only, no backend.</p>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
        <span class="pill gray">Desktop-first</span>
        <span class="pill gray">Accessible</span>
        <span class="pill gray">Mock data</span>
      </div>
    </div>
  `;
}

/* ========================= EVENT WIRING ========================= */
function wireGlobal() {
  // Open invoice from Dashboard
  $('#view').addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-open-invoice]');
    if (!btn) return;
    const inv = Store.invoices.find(x=>x.id===btn.dataset.openInvoice);
    if (!inv) return;
    const room = Store.rooms.find(r=>r.id===inv.roomId);
    const renter = Store.renters.find(r=>r.id===inv.renterId);
    const node = document.createElement('div');
    node.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div class="pill gray">${inv.yyyymm}</div>
          <h3 style="margin:6px 0">${room?.roomNo ?? '‚Äî'} ¬∑ ${renter?.name ?? '‚Äî'}</h3>
        </div>
        <div class="pill ${inv.status==='paid'?'green':inv.status==='overdue'?'red':inv.status==='sent'?'amber':'gray'}">${inv.status}</div>
      </div>
      <div class="card" style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between">
          <div>Total</div>
          <strong>${currency(inv.total)}</strong>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn">Preview Invoice</button>
        <button class="btn">Preview Receipt</button>
        <button class="btn">Attach Slip</button>
      </div>
      <!-- TODO: Google Sheets ‚Äî mark invoice paid, update records. -->
    `;
    openOverlay('Invoice', node);
  });

  // Quick actions (mock)
  $$('[data-action]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const act = btn.dataset.action;
      Toast.show(`Action "${act}" (mock)`);
      if (act==='createInvoice') Router.navigate('builder');
      if (act==='addRenter') Router.navigate('renters');
      if (act==='recordPayment') Router.navigate('payments');
    });
  });

  // Search (mock highlights)
  $('#globalSearch').addEventListener('keydown', (e)=>{
    if (e.key==='Enter'){
      const q = e.currentTarget.value.trim();
      Toast.show(q ? `Search: "${q}" (mock)` : 'Clear search');
    }
  });

  // Overlay close
  $('#sheetClose').addEventListener('click', closeOverlay);

  // Keyboard help
  $('#keyboardHelp').addEventListener('click', (e)=>{
    e.preventDefault();
    const node = document.createElement('div');
    node.innerHTML = `
      <div class="grid" style="gap:8px">
        <div class="pill gray">Tab</div> Focus/Traverse
        <div class="pill gray">Enter</div> Activate
        <div class="pill gray">Esc</div> Close Overlay
      </div>`;
    openOverlay('Keyboard Shortcuts', node);
  });
}

/* ========================= INIT ========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  wireGlobal();
  Router.init();
});
</script>

</html>

<!-- ==== PART 1 END ===================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 2 START =================================================== -->
<style>
  /* Rooms: floor plan list */
  .floor {
    margin-bottom: 16px;
  }
  .floor h3 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: var(--muted);
  }
  .rooms-grid {
    display: grid;
    grid-template-columns: repeat(6, minmax(0,1fr));
    gap: 10px;
  }
  @media (max-width: 1100px) { .rooms-grid { grid-template-columns: repeat(4,1fr); } }
  @media (max-width: 780px)  { .rooms-grid { grid-template-columns: repeat(3,1fr); } }
  @media (max-width: 560px)  { .rooms-grid { grid-template-columns: repeat(2,1fr); } }

  .room-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--panel);
    box-shadow: var(--shadow);
    padding: 12px;
    display: grid;
    gap: 6px;
  }
  .room-card header {
    display:flex;justify-content:space-between;align-items:center;
    font-weight:600;
  }
  .room-meta { font-size: 12px; color: var(--muted); display: grid; gap: 2px; }
  .room-actions { display:flex; gap:8px; flex-wrap:wrap; }

  /* Overlay tabs specifics */
  .sheet main .tab-panel { display: none; }
  .sheet main .tab-panel[aria-hidden="false"] { display: block; }
  .sheet main .resizable {
    resize: vertical;
    overflow: auto;
    min-height: 220px;
    max-height: calc(78vh - 140px);
    border: 1px dashed var(--border);
    border-radius: var(--radius);
    padding: 10px;
  }
  .form-row {
    display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:10px;
  }
  @media (max-width: 700px){ .form-row { grid-template-columns: 1fr; } }
  .field { display:grid; gap:6px; }
  .field label { font-size: 12px; color: var(--muted); }
  .field input, .field select, .field textarea {
    width: 100%; padding: 10px 12px; border:1px solid var(--border);
    background: var(--panel); color: var(--text); border-radius: 10px;
  }
  .mini-table { width:100%; border-collapse: collapse; }
  .mini-table th, .mini-table td { border-bottom:1px solid var(--border); padding:8px; text-align:left; }
  .right { text-align: right; }
</style>

<script>
/* ========================= PART 2 SCRIPT ========================= */

/* Augment seed with per-room remarks/utilities if missing */
Store.rooms.forEach(r=>{
  if (!('remarks' in r)) r.remarks = '';
  if (!('utilities' in r)) r.utilities = []; // {yyyymm, elecKwh, waterM3}
});

/* ---------- Helpers specific to rooms ---------- */
function groupByFloor(rooms) {
  // Floor inferred from first two digits of roomNo (e.g., 101‚Äì105 => Floor 1)
  const map = new Map();
  rooms.forEach(r=>{
    const floor = String(r.roomNo).slice(0,1); // simplistic for 1xx, 2xx ‚Ä¶
    if (!map.has(floor)) map.set(floor, []);
    map.get(floor).push(r);
  });
  // sort rooms in each floor
  for (const arr of map.values()) arr.sort((a,b)=>Number(a.roomNo)-Number(b.roomNo));
  // sort floors numeric
  return Array.from(map.entries()).sort((a,b)=>Number(a[0])-Number(b[0]));
}

function statusPill(status) {
  const map = { vacant:'gray', occupied:'green', unpaid:'red' };
  const cls = map[status] || 'amber';
  return `<span class="pill ${cls}" aria-label="room status ${status}">${status}</span>`;
}

/* ---------- View: Rooms (Floor Plan) ---------- */
Views.rooms = function renderRooms() {
  const container = document.createElement('div');
  container.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0">Rooms ‚Äî Floor Plan</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="roomsFilter" aria-label="Filter rooms" class="field" placeholder="Filter by room/renter‚Ä¶" style="padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel)">
          <button class="btn" id="roomsReset">Reset</button>
        </div>
      </div>
    </div>
    <div id="roomsList"></div>
  `;
  const listHost = container.querySelector('#roomsList');
  function paint(filter='') {
    const q = filter.trim().toLowerCase();
    const filtered = q ? Store.rooms.filter(r=>{
      const renter = Store.renters.find(x=>x.id===r.renterId)?.name || '';
      return r.roomNo.includes(q) || renter.toLowerCase().includes(q);
    }) : Store.rooms.slice();

    const floors = groupByFloor(filtered);
    listHost.innerHTML = floors.map(([floor, rooms])=>{
      return `
        <section class="floor">
          <h3>Floor ${floor}</h3>
          <div class="rooms-grid">
            ${rooms.map(roomCard).join('')}
          </div>
        </section>
      `;
    }).join('') || `<div class="card"><em>No rooms match.</em></div>`;
  }
  function roomCard(r) {
    const renter = Store.renters.find(x=>x.id===r.renterId);
    const pay = Store.bankAccounts.find(b=>b.id===r.payMethodId);
    return `
      <article class="room-card" aria-label="Room ${r.roomNo}">
        <header>
          <span>${r.roomNo}</span>
          ${statusPill(r.status)}
        </header>
        <div class="room-meta">
          <div>Renter: <strong>${renter ? renter.name : '‚Äî'}</strong></div>
          <div>Payment to: ${pay ? `${pay.bank} ‚Ä¢ ${pay.acct}` : '‚Äî'}</div>
          <div>Rate: <strong>${currency(r.rate)}</strong></div>
        </div>
        <div class="room-actions">
          <button class="btn" data-open-room="${r.id}">Open</button>
          <button class="btn ghost" data-invoice-room="${r.id}">Invoice</button>
        </div>
      </article>
    `;
  }

  // Wire filter
  container.querySelector('#roomsFilter').addEventListener('input', e=>paint(e.target.value));
  container.querySelector('#roomsReset').addEventListener('click', ()=>{ $('#roomsFilter').value=''; paint(''); });

  // Delegate clicks (open room / invoice)
  container.addEventListener('click', (e)=>{
    const openBtn = e.target.closest('[data-open-room]');
    if (openBtn) {
      const roomId = openBtn.getAttribute('data-open-room');
      openRoomOverlay(roomId);
      return;
    }
    const invBtn = e.target.closest('[data-invoice-room]');
    if (invBtn) {
      const roomId = invBtn.getAttribute('data-invoice-room');
      const r = Store.rooms.find(x=>x.id===roomId);
      const anyInv = Store.invoices.find(i=>i.roomId===roomId);
      if (anyInv) {
        // Reuse Dashboard invoice overlay rendering by triggering a fake button:
        const node = document.createElement('div');
        node.innerHTML = `<p>Go to Payments to manage invoices for <strong>Room ${r.roomNo}</strong>.</p>`;
        node.innerHTML += `<div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="goPayments">Open Payments</button>
          <button class="btn" id="stayHere">Stay</button>
        </div>`;
        openOverlay('Invoice Shortcut', node);
        $('#sheetBody').addEventListener('click', ev=>{
          if (ev.target.id==='goPayments'){ closeOverlay(); Router.navigate('payments'); }
          if (ev.target.id==='stayHere'){ closeOverlay(); }
        }, { once:true });
      } else {
        Toast.show('No invoices yet (mock). Use Builder to create.');
        Router.navigate('builder');
      }
    }
  });

  $('#view').replaceChildren(container);
  paint(); // initial
};

/* ---------- Room Overlay with Tabs ---------- */
function openRoomOverlay(roomId) {
  const room = Store.rooms.find(r=>r.id===roomId);
  if (!room) return;
  const renter = Store.renters.find(x=>x.id===room.renterId) || null;

  const node = document.createElement('div');
  node.innerHTML = `
    <div class="tabs" role="tablist" aria-label="Room Tabs" style="margin-bottom:8px">
      ${[
        'Basic Information','Contract Information','Payment','Move-Out',
        'Remarks','Payment Method (Per Room)','Utilities Record','Room Rate'
      ].map((t,i)=>`<button role="tab" class="btn" aria-selected="${i===0?'true':'false'}" aria-controls="tab-${i}" id="tab-btn-${i}">${t}</button>`).join('')}
    </div>
    <div class="resizable" style="margin-bottom:10px">
      ${Array.from({length:8}).map((_,i)=>`<section id="tab-${i}" role="tabpanel" class="tab-panel" aria-labelledby="tab-btn-${i}" aria-hidden="${i===0?'false':'true'}"></section>`).join('')}
    </div>
  `;

  openOverlay(`Room ${room.roomNo} ‚Äî ${renter? renter.name : 'Vacant'}`, node);

  // Render tab bodies
  renderTab0_Basic($('#tab-0'), room, renter);
  renderTab1_Contract($('#tab-1'), room, renter);
  renderTab2_Payment($('#tab-2'), room, renter);
  renderTab3_MoveOut($('#tab-3'), room, renter);
  renderTab4_Remarks($('#tab-4'), room);
  renderTab5_PayMethod($('#tab-5'), room);
  renderTab6_Utilities($('#tab-6'), room);
  renderTab7_RoomRate($('#tab-7'), room);

  // Wire tab switching (keyboard & click)
  const tabs = $$('.tabs [role="tab"]', node);
  const panels = $$('.tab-panel', node);
  function activate(idx){
    tabs.forEach((b,i)=>{
      b.setAttribute('aria-selected', String(i===idx));
      panels[i].setAttribute('aria-hidden', String(i!==idx));
    });
    tabs[idx].focus();
  }
  tabs.forEach((b,i)=>{
    b.addEventListener('click', ()=>activate(i));
    b.addEventListener('keydown', (e)=>{
      if (e.key==='ArrowRight') activate((i+1)%tabs.length);
      if (e.key==='ArrowLeft')  activate((i-1+tabs.length)%tabs.length);
      if (e.key==='Home') activate(0);
      if (e.key==='End') activate(tabs.length-1);
    });
  });
}

/* ---------- Tab 0: Basic Information ---------- */
function renderTab0_Basic(host, room, renter) {
  host.innerHTML = `
    <div class="form-row">
      <div class="field">
        <label>Renter Name</label>
        <input id="biName" value="${renter? renter.name:''}" ${renter?'':'placeholder="Vacant"'} ${renter?'':'disabled'}>
      </div>
      <div class="field">
        <label>Phone</label>
        <input id="biPhone" value="${renter? renter.phone:''}" ${renter?'':'placeholder="‚Äî"'} ${renter?'':'disabled'}>
      </div>
    </div>
    <div class="form-row">
      <div class="field">
        <label>Address</label>
        <input id="biAddr" value="${renter? renter.address:''}" ${renter?'':'placeholder="‚Äî"'} ${renter?'':'disabled'}>
      </div>
      <div class="field">
        <label>Current Balance</label>
        <input id="biBal" value="${renter? currency(renter.balance):''}" ${renter?'':'placeholder="‚Äî"'} ${renter?'':'disabled'}>
      </div>
    </div>
    <div class="form-row">
      <div class="field">
        <label>Room Status</label>
        <input value="${room.status}" disabled>
      </div>
      <div class="field">
        <label>Assigned Bank</label>
        <input value="${(Store.bankAccounts.find(b=>b.id===room.payMethodId)?.bank || '‚Äî')}" disabled>
      </div>
    </div>
  `;
}

/* ---------- Tab 1: Contract Information ---------- */
function renderTab1_Contract(host, room, renter) {
  const start = renter?.contract.start ?? '';
  const end = renter?.contract.end ?? '';
  const depDate = renter?.contract.depositPaidOn ?? '';
  host.innerHTML = `
    <div class="form-row">
      <div class="field">
        <label>Start Date</label>
        <input type="date" id="ctStart" value="${start}">
      </div>
      <div class="field">
        <label>End Date</label>
        <input type="date" id="ctEnd" value="${end}">
      </div>
    </div>
    <div class="form-row">
      <div class="field">
        <label>Deposit Paid On</label>
        <input type="date" id="ctDepositOn" value="${depDate}">
      </div>
      <div class="field">
        <label>Deposit Slip (mock)</label>
        <input type="file" id="ctSlip" accept="image/*">
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="ctSave">Save (mock)</button>
      <button class="btn" id="ctGenReceipt">Generate Deposit Receipt</button>
    </div>
    <!-- TODO: Google Sheets ‚Äî store contract + deposit slip -->
  `;
  host.querySelector('#ctSave').addEventListener('click', ()=>{
    if (!renter) return Toast.show('No renter assigned.');
    renter.contract.start = $('#ctStart').value || renter.contract.start;
    renter.contract.end = $('#ctEnd').value || renter.contract.end;
    renter.contract.depositPaidOn = $('#ctDepositOn').value || renter.contract.depositPaidOn;
    const file = host.querySelector('#ctSlip').files?.[0];
    if (file) {
      const rd = new FileReader();
      rd.onload = ()=>{ renter.contract.depositSlip = rd.result; Toast.show('Saved (mock)'); };
      rd.readAsDataURL(file);
    } else {
      Toast.show('Saved (mock)');
    }
  });
  host.querySelector('#ctGenReceipt').addEventListener('click', ()=>{
    const node = document.createElement('div');
    node.innerHTML = `<p>Print-ready deposit receipt (mock). Use the Builder later.</p>`;
    openOverlay('Deposit Receipt', node);
  });
}

/* ---------- Tab 2: Payment (invoice/receipt history per month) ---------- */
function renderTab2_Payment(host, room, renter) {
  const months = [0,1,2,3,4,5].map(m=>{
    const d = new Date(Store.now); d.setMonth(d.getMonth()-m);
    return d.toISOString().slice(0,7);
  });
  const sel = document.createElement('div');
  sel.className = 'form-row';
  sel.innerHTML = `
    <div class="field">
      <label>Month</label>
      <select id="pmMonth">${months.map(m=>`<option value="${m}">${m}</option>`).join('')}</select>
    </div>
  `;
  const tableWrap = document.createElement('div');
  function paintTable(yyyymm) {
    const list = Store.invoices.filter(i=>i.roomId===room.id && i.yyyymm===yyyymm);
    tableWrap.innerHTML = `
      <table class="mini-table" aria-label="Invoices for ${yyyymm}">
        <thead><tr><th>Doc</th><th>Status</th><th class="right">Total</th><th>Slip</th><th></th></tr></thead>
        <tbody>
          ${list.map(i=>`
            <tr>
              <td>${i.id}</td>
              <td><span class="pill ${i.status==='paid'?'green':i.status==='overdue'?'red':i.status==='sent'?'amber':'gray'}">${i.status}</span></td>
              <td class="right">${currency(i.total)}</td>
              <td>${i.slip? '‚Ä¢' : '‚Äî'}</td>
              <td>
                <button class="btn" data-prev-inv="${i.id}">Preview Invoice</button>
                <button class="btn" data-prev-rec="${i.id}">Preview Receipt</button>
              </td>
            </tr>`).join('') || `<tr><td colspan="5"><em>No records.</em></td></tr>`}
        </tbody>
      </table>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="pmAttach">Attach Slip</button>
      </div>
      <!-- TODO: Google Sheets ‚Äî mark invoice paid, update records. -->
    `;
  }

  host.replaceChildren(sel, tableWrap);
  const picker = sel.querySelector('#pmMonth');
  picker.addEventListener('change', ()=>paintTable(picker.value));
  picker.value = months[0];
  paintTable(picker.value);

  tableWrap.addEventListener('click', (e)=>{
    const invBtn = e.target.closest('[data-prev-inv]');
    const recBtn = e.target.closest('[data-prev-rec]');
    if (invBtn) {
      openOverlay('Invoice Preview', document.createTextNode(`Invoice ${invBtn.dataset.prevInv} (mock preview)`));
    } else if (recBtn) {
      openOverlay('Receipt Preview', document.createTextNode(`Receipt for ${recBtn.dataset.prevRec} (mock preview)`));
    }
  });
  tableWrap.querySelector('#pmAttach').addEventListener('click', ()=>{
    Toast.show('Attach slip (mock upload)');
  });
}

/* ---------- Tab 3: Move-Out (UI calc only) ---------- */
function renderTab3_MoveOut(host, room, renter) {
  host.innerHTML = `
    <div class="form-row">
      <div class="field">
        <label>Move-out Date</label>
        <input type="date" id="moDate">
      </div>
      <div class="field">
        <label>Additional Fee (THB)</label>
        <input type="number" id="moFee" value="0" step="1" min="0">
      </div>
    </div>
    <div class="form-row">
      <div class="field">
        <label>Electricity (kWh)</label>
        <input type="number" id="moElec" value="0" step="1" min="0">
      </div>
      <div class="field">
        <label>Water (m¬≥)</label>
        <input type="number" id="moWater" value="0" step="1" min="0">
      </div>
    </div>
    <div class="form-row">
      <div class="field">
        <label>Advance Rent (THB)</label>
        <input type="number" id="moAdv" value="${room.rate}" step="1" min="0">
      </div>
      <div class="field">
        <label>Deposit (THB)</label>
        <input type="number" id="moDep" value="${Store.defaults.roomRate}" step="1" min="0">
      </div>
    </div>

    <div class="card" id="moResult">
      <h3 style="margin:0 0 8px 0">Breakdown</h3>
      <div id="moBreak"></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px">
        <strong>Return Amount</strong>
        <strong id="moReturn">‡∏ø0</strong>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button class="btn" id="moGenInv">Generate Invoice</button>
      <button class="btn" id="moGenRec">Generate Receipt</button>
      <button class="btn" id="moRecord">Record Move-Out (mock)</button>
      <button class="btn" id="moAttach">Attach Slip</button>
    </div>
    <!-- TODO: Google Sheets ‚Äî record move-out summary. -->
  `;
  function calc() {
    const adv = Number($('#moAdv').value||0);
    const dep = Number($('#moDep').value||0);
    const fee = Number($('#moFee').value||0);
    const elec = Number($('#moElec').value||0) * Store.utilities.elecRate;
    const water = Number($('#moWater').value||0) * Store.utilities.waterRate;
    const finalMonthRent = room.rate; // UI assumption
    const charges = finalMonthRent + fee + elec + water;
    const credits = adv + dep;
    const ret = credits - charges;
    $('#moBreak').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr auto;gap:6px">
        <div>Final Month Rent</div><div class="right">${currency(finalMonthRent)}</div>
        <div>Electricity</div><div class="right">${currency(elec)}</div>
        <div>Water</div><div class="right">${currency(water)}</div>
        <div>Additional Fee</div><div class="right">${currency(fee)}</div>
        <div style="grid-column:1/-1;border-top:1px dashed var(--border)"></div>
        <div>Credits (Advance + Deposit)</div><div class="right">-${currency(credits)}</div>
      </div>`;
    $('#moReturn').textContent = currency(ret);
  }
  host.addEventListener('input', calc);
  calc();

  host.querySelector('#moRecord').addEventListener('click', ()=>Toast.show('Move-out recorded (mock)'));
  host.querySelector('#moAttach').addEventListener('click', ()=>Toast.show('Attach slip (mock)'));
  host.querySelector('#moGenInv').addEventListener('click', ()=>Toast.show('Generate Invoice (mock)'));
  host.querySelector('#moGenRec').addEventListener('click', ()=>Toast.show('Generate Receipt (mock)'));
}

/* ---------- Tab 4: Remarks ---------- */
function renderTab4_Remarks(host, room) {
  host.innerHTML = `
    <div class="field">
      <label>Room Remarks</label>
      <textarea id="rkText" rows="6" placeholder="Notes about maintenance, behavior, etc.">${room.remarks||''}</textarea>
    </div>
    <div style="margin-top:8px">
      <button class="btn" id="rkSave">Save (mock)</button>
    </div>
  `;
  host.querySelector('#rkSave').addEventListener('click', ()=>{
    room.remarks = host.querySelector('#rkText').value;
    Toast.show('Remarks saved (mock)');
  });
}

/* ---------- Tab 5: Payment Method (Per Room) ---------- */
function renderTab5_PayMethod(host, room) {
  host.innerHTML = `
    <div class="form-row">
      <div class="field">
        <label>Assigned Bank Account</label>
        <select id="pmAssign">
          ${Store.bankAccounts.map(b=>`
            <option value="${b.id}" ${room.payMethodId===b.id?'selected':''}>${b.bank} ‚Äî ${b.acct} (${b.name})</option>
          `).join('')}
        </select>
      </div>
      <div class="field">
        <label>Details</label>
        <input id="pmDetails" disabled>
      </div>
    </div>
    <div><button class="btn" id="pmSave">Save (mock)</button></div>
  `;
  const details = host.querySelector('#pmDetails');
  function paintDetails(){
    const b = Store.bankAccounts.find(x=>x.id===host.querySelector('#pmAssign').value);
    details.value = b ? `${b.bank} ‚Ä¢ ${b.acct} ‚Ä¢ ${b.name}` : '‚Äî';
  }
  paintDetails();
  host.querySelector('#pmAssign').addEventListener('change', paintDetails);
  host.querySelector('#pmSave').addEventListener('click', ()=>{
    room.payMethodId = host.querySelector('#pmAssign').value;
    Toast.show('Payment method saved (mock)');
  });
}

/* ---------- Tab 6: Utilities Record ---------- */
function renderTab6_Utilities(host, room) {
  host.innerHTML = `
    <div class="form-row">
      <div class="field">
        <label>Month (YYYY-MM)</label>
        <input id="utMonth" placeholder="2025-10" value="${monthKey()}">
      </div>
      <div class="field">
        <label>Electricity (kWh)</label>
        <input id="utElec" type="number" min="0" step="1" value="0">
      </div>
    </div>
    <div class="form-row">
      <div class="field">
        <label>Water (m¬≥)</label>
        <input id="utWater" type="number" min="0" step="1" value="0">
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="btn" id="utAdd">Add Record</button>
      </div>
    </div>

    <div class="card" style="margin-top:6px">
      <table class="mini-table" aria-label="Utility records">
        <thead><tr><th>Month</th><th class="right">kWh</th><th class="right">m¬≥</th><th class="right">Est. Cost</th><th></th></tr></thead>
        <tbody id="utBody"></tbody>
      </table>
    </div>
  `;
  const body = host.querySelector('#utBody');
  function paint() {
    body.innerHTML = room.utilities.map((u,idx)=>`
      <tr>
        <td>${u.yyyymm}</td>
        <td class="right">${u.elecKwh}</td>
        <td class="right">${u.waterM3}</td>
        <td class="right">${currency(u.elecKwh*Store.utilities.elecRate + u.waterM3*Store.utilities.waterRate)}</td>
        <td><button class="btn ghost" data-del="${idx}">Delete</button></td>
      </tr>
    `).join('') || `<tr><td colspan="5"><em>No records yet.</em></td></tr>`;
  }
  paint();

  host.querySelector('#utAdd').addEventListener('click', ()=>{
    const y = host.querySelector('#utMonth').value.trim();
    const e = Number(host.querySelector('#utElec').value||0);
    const w = Number(host.querySelector('#utWater').value||0);
    if (!/^\d{4}-\d{2}$/.test(y)) return Toast.show('Invalid month format. Use YYYY-MM.');
    room.utilities.push({ yyyymm:y, elecKwh:e, waterM3:w });
    paint();
    Toast.show('Utility record added (mock)');
  });
  body.addEventListener('click', e=>{
    const del = e.target.closest('[data-del]');
    if (del){
      room.utilities.splice(Number(del.dataset.del),1);
      paint();
    }
  });
  // TODO: Google Sheets ‚Äî persist per-room utilities
}

/* ---------- Tab 7: Room Rate ---------- */
function renderTab7_RoomRate(host, room) {
  host.innerHTML = `
    <div class="form-row">
      <div class="field">
        <label>Room Rate (THB)</label>
        <input id="rrRate" type="number" min="0" step="1" value="${room.rate}">
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="btn" id="rrSave">Save (mock)</button>
      </div>
    </div>
  `;
  host.querySelector('#rrSave').addEventListener('click', ()=>{
    room.rate = Number(host.querySelector('#rrRate').value||room.rate);
    Toast.show('Room rate updated (mock)');
  });
}

</script>
<!-- ==== PART 2 END ===================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 3 START =================================================== -->
<style>
  /* Renters */
  .renters-wrap .grid-cards {
    display:grid; gap:12px;
    grid-template-columns: repeat(4, minmax(0,1fr));
  }
  @media (max-width: 1200px){ .renters-wrap .grid-cards { grid-template-columns: repeat(3,1fr); } }
  @media (max-width: 820px){ .renters-wrap .grid-cards { grid-template-columns: repeat(2,1fr); } }
  @media (max-width: 560px){ .renters-wrap .grid-cards { grid-template-columns: 1fr; } }

  .renter-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--panel);
    box-shadow: var(--shadow);
    padding: 12px;
    display: grid; gap: 6px;
  }
  .renter-card header { display:flex; justify-content:space-between; align-items:center; }
  .subtle { color: var(--muted); font-size: 12px; }

  /* Payments */
  .payments-grid {
    display:grid; gap:12px;
    grid-template-columns: repeat(5, minmax(0,1fr));
  }
  @media (max-width: 1400px){ .payments-grid { grid-template-columns: repeat(4,1fr); } }
  @media (max-width: 1100px){ .payments-grid { grid-template-columns: repeat(3,1fr); } }
  @media (max-width: 800px){ .payments-grid { grid-template-columns: repeat(2,1fr); } }
  @media (max-width: 560px){ .payments-grid { grid-template-columns: 1fr; } }

  .pay-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--panel);
    box-shadow: var(--shadow);
    padding: 12px;
    display:grid; gap:8px;
  }
  .pay-card header { display:flex; justify-content:space-between; align-items:center; }
  .pay-meta { font-size: 12px; color: var(--muted); display:grid; gap:2px; }
  .right { text-align:right; }

  /* Files */
  .files-toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .dropzone {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 16px; text-align: center; color: var(--muted);
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.02));
  }
  .files-grid {
    margin-top: 12px;
    display:grid; gap:12px;
    grid-template-columns: repeat(6, minmax(0,1fr));
  }
  @media (max-width: 1300px){ .files-grid { grid-template-columns: repeat(5,1fr); } }
  @media (max-width: 1100px){ .files-grid { grid-template-columns: repeat(4,1fr); } }
  @media (max-width: 860px){  .files-grid { grid-template-columns: repeat(3,1fr); } }
  @media (max-width: 640px){  .files-grid { grid-template-columns: repeat(2,1fr); } }
  @media (max-width: 480px){  .files-grid { grid-template-columns: 1fr; } }

  .file-card {
    border:1px solid var(--border);
    border-radius: var(--radius);
    background: var(--panel);
    box-shadow: var(--shadow);
    overflow:hidden; display:grid; grid-template-rows: 120px auto;
  }
  .file-thumb { background:#1111; display:grid; place-items:center; }
  .file-thumb img { max-height: 120px; object-fit: contain; }
  .file-meta { padding:10px; display:grid; gap:6px; }
  .tag-input { width:100%; padding:8px 10px; border:1px solid var(--border); border-radius: 999px; background: var(--panel); color: var(--text); }
</style>

<script>
/* ========================= PART 3 SCRIPT ========================= */

/* ---------- RENTERS VIEW ---------- */
Views.renters = function renderRenters(){
  const wrap = document.createElement('div');
  wrap.className = 'renters-wrap';
  wrap.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h2 style="margin:0">Renters</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="rFilter" placeholder="Search name, room, status‚Ä¶" style="padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel)">
          <select id="rStatus" class="btn" aria-label="Status filter">
            <option value="">All</option>
            <option value="occupied">Occupied</option>
            <option value="unpaid">Unpaid</option>
          </select>
          <button class="btn" id="rReset">Reset</button>
        </div>
      </div>
    </div>
    <div class="grid-cards" id="rList"></div>
  `;
  $('#view').replaceChildren(wrap);

  const elList = wrap.querySelector('#rList');
  function statusOf(renter){
    const room = Store.rooms.find(x=>x.id===renter.roomId);
    return room?.status || 'occupied';
  }
  function paint(){
    const q = wrap.querySelector('#rFilter').value.trim().toLowerCase();
    const s = wrap.querySelector('#rStatus').value;
    const list = Store.renters.filter(r=>{
      const room = Store.rooms.find(x=>x.id===r.roomId);
      const txt = [r.name, room?.roomNo, statusOf(r)].filter(Boolean).join(' ').toLowerCase();
      const okQ = q ? txt.includes(q) : true;
      const okS = s ? statusOf(r)===s : true;
      return okQ && okS;
    });
    elList.innerHTML = list.map(r=>{
      const room = Store.rooms.find(x=>x.id===r.roomId);
      const stat = statusOf(r);
      const map = { occupied:'green', unpaid:'red', vacant:'gray' };
      return `
        <article class="renter-card" aria-label="${r.name}">
          <header>
            <strong>${r.name}</strong>
            <span class="pill ${map[stat]||'gray'}">${stat}</span>
          </header>
          <div class="subtle">Room <strong>${room?.roomNo || '‚Äî'}</strong></div>
          <div class="subtle">Phone ${r.phone}</div>
          <div class="subtle">Balance: <strong>${currency(r.balance)}</strong></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
            <button class="btn" data-open-room="${room?.id||''}">Open Room</button>
            <button class="btn ghost" data-msg="${r.id}">Message (mock)</button>
          </div>
        </article>
      `;
    }).join('') || `<div class="card"><em>No renters found.</em></div>`;
  }
  paint();

  wrap.addEventListener('input', paint);
  wrap.querySelector('#rReset').addEventListener('click', ()=>{
    wrap.querySelector('#rFilter').value='';
    wrap.querySelector('#rStatus').value='';
    paint();
  });

  // Delegated actions
  wrap.addEventListener('click', (e)=>{
    const roomBtn = e.target.closest('[data-open-room]');
    if (roomBtn && roomBtn.dataset.openRoom) openRoomOverlay(roomBtn.dataset.openRoom);
    const msgBtn = e.target.closest('[data-msg]');
    if (msgBtn){
      const r = Store.renters.find(x=>x.id===msgBtn.dataset.msg);
      Toast.show(`Messaging ${r?.name} (mock)`);
    }
  });
};

/* ---------- PAYMENTS VIEW + INVOICE OVERLAY ---------- */
Views.payments = function renderPayments(){
  const thisMonth = monthKey();
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <h2 style="margin:0">Payments ‚Äî ${thisMonth}</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="pFilter" placeholder="Search room/renter‚Ä¶" style="padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel)">
          <select id="pStatus" class="btn" aria-label="Status filter">
            <option value="">All</option>
            <option value="draft">Draft</option>
            <option value="sent">Sent</option>
            <option value="paid">Paid</option>
            <option value="overdue">Overdue</option>
          </select>
          <button class="btn" id="pReset">Reset</button>
        </div>
      </div>
    </div>
    <div class="payments-grid" id="pList"></div>
  `;
  $('#view').replaceChildren(wrap);

  function statusPill(status){
    const map = { draft:'gray', sent:'amber', paid:'green', overdue:'red' };
    return `<span class="pill ${map[status]||'gray'}">${status}</span>`;
  }
  function ensureInvoiceForRoomMonth(roomId, yyyymm){
    // Return existing or synthesize a draft
    let inv = Store.invoices.find(i=>i.roomId===roomId && i.yyyymm===yyyymm);
    if (!inv){
      const renter = Store.renters.find(r=>r.roomId===roomId);
      const base = Store.rooms.find(r=>r.id===roomId)?.rate || Store.defaults.roomRate;
      inv = {
        id: 'inv' + (Store.invoices.length+1),
        roomId, renterId: renter?.id || null,
        yyyymm, total: base, status: 'draft',
        method: 'Bank Transfer', slip: null,
        settings: { addressId: Store.addresses[0]?.id || null, remark: 'Please pay by due date.' }
      };
      Store.invoices.push(inv);
    } else if (!inv.settings){
      inv.settings = { addressId: Store.addresses[0]?.id || null, remark: 'Please pay by due date.' };
    }
    return inv;
  }

  function paint(){
    const q = wrap.querySelector('#pFilter').value.trim().toLowerCase();
    const s = wrap.querySelector('#pStatus').value;
    // Build a card list aligned to rooms (so you see all rooms for current month)
    const cards = Store.rooms.map(room=>{
      const inv = ensureInvoiceForRoomMonth(room.id, thisMonth);
      const renter = Store.renters.find(r=>r.id===inv.renterId);
      const txt = [room.roomNo, renter?.name, inv.status].filter(Boolean).join(' ').toLowerCase();
      const okQ = q ? txt.includes(q) : true;
      const okS = s ? inv.status===s : true;
      if (!(okQ && okS)) return '';
      return `
        <article class="pay-card">
          <header>
            <strong>${room.roomNo}</strong>
            ${statusPill(inv.status)}
          </header>
          <div class="pay-meta">
            <div>Renter: <strong>${renter?.name || '‚Äî'}</strong></div>
            <div>Amount Due: <strong>${currency(inv.total)}</strong></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" data-open-inv="${inv.id}">Open</button>
            <button class="btn ghost" data-send="${inv.id}">Mark Sent (mock)</button>
          </div>
        </article>
      `;
    }).join('');
    wrap.querySelector('#pList').innerHTML = cards || `<div class="card"><em>No results.</em></div>`;
  }
  paint();

  wrap.addEventListener('input', paint);
  wrap.querySelector('#pReset').addEventListener('click', ()=>{
    wrap.querySelector('#pFilter').value='';
    wrap.querySelector('#pStatus').value='';
    paint();
  });

  // Delegation
  wrap.addEventListener('click', (e)=>{
    const openBtn = e.target.closest('[data-open-inv]');
    if (openBtn){
      const inv = Store.invoices.find(x=>x.id===openBtn.dataset.openInv);
      if (inv) openInvoiceOverlay(inv.id);
    }
    const sendBtn = e.target.closest('[data-send]');
    if (sendBtn){
      const inv = Store.invoices.find(x=>x.id===sendBtn.dataset.send);
      if (inv){ inv.status = 'sent'; Toast.show('Marked Sent (mock)'); paint(); }
    }
  });

  // Helper: open overlay
  function openInvoiceOverlay(invId){
    const inv = Store.invoices.find(x=>x.id===invId);
    const room = Store.rooms.find(r=>r.id===inv.roomId);
    const renter = Store.renters.find(r=>r.id===inv.renterId);

    const node = document.createElement('div');
    node.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;flex-wrap:wrap">
        <div>
          <div class="pill gray">${inv.yyyymm}</div>
          <h3 style="margin:6px 0">${room?.roomNo ?? '‚Äî'} ¬∑ ${renter?.name ?? '‚Äî'}</h3>
        </div>
        <div>
          <select id="invStatus" class="btn" aria-label="Invoice status">
            ${['draft','sent','paid','overdue'].map(s=>`<option ${inv.status===s?'selected':''}>${s}</option>`).join('')}
          </select>
        </div>
      </div>

      <div class="card" style="margin-bottom:10px">
        <div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center">
          <div>Room Rate</div><input id="liRoom" type="number" min="0" step="1" value="${room?.rate ?? Store.defaults.roomRate}" style="width:120px;justify-self:end">
          <div>Electricity</div><input id="liElec" type="number" min="0" step="1" value="0" style="width:120px;justify-self:end">
          <div>Water</div><input id="liWater" type="number" min="0" step="1" value="0" style="width:120px;justify-self:end">
          <div>Late Fee</div><input id="liLate" type="number" min="0" step="1" value="0" style="width:120px;justify-self:end">
          <div>Other Adjustments (+/-)</div><input id="liAdj" type="number" step="1" value="0" style="width:120px;justify-self:end">
          <div style="grid-column:1/-1;border-top:1px dashed var(--border);height:1px"></div>
          <div><strong>Total</strong></div><div class="right" id="liTotal"><strong>${currency(inv.total)}</strong></div>
        </div>
      </div>

      <div class="card" style="margin-bottom:10px">
        <h4 style="margin:0 0 8px 0">Invoice Settings</h4>
        <div class="form-row">
          <div class="field">
            <label>Apartment Address</label>
            <select id="invAddr">
              ${Store.addresses.map(a=>`<option value="${a.id}" ${inv.settings?.addressId===a.id?'selected':''}>${a.name} ‚Äî ${a.addr}</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <label>Invoice Footer Remark</label>
            <input id="invRemark" value="${inv.settings?.remark || ''}" placeholder="Thank you for your payment.">
          </div>
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="invSave">Save (mock)</button>
        <button class="btn" id="invPreview">Generate Invoice</button>
        <button class="btn" id="recPreview">Generate Receipt</button>
        <button class="btn" id="invAttach">Attach Slip</button>
      </div>

      <!-- TODO: Google Sheets ‚Äî mark invoice paid, update records. -->
    `;
    openOverlay('Invoice', node);

    const elTotal = node.querySelector('#liTotal');
    function recalc(){
      const sum = Number($('#liRoom').value||0)
                + Number($('#liElec').value||0)
                + Number($('#liWater').value||0)
                + Number($('#liLate').value||0)
                + Number($('#liAdj').value||0);
      elTotal.innerHTML = `<strong>${currency(sum)}</strong>`;
      return sum;
    }
    node.addEventListener('input', (e)=>{
      if (['liRoom','liElec','liWater','liLate','liAdj'].includes(e.target.id)) recalc();
    });

    node.querySelector('#invSave').addEventListener('click', ()=>{
      inv.total = recalc();
      inv.status = node.querySelector('#invStatus').value;
      inv.settings.addressId = node.querySelector('#invAddr').value;
      inv.settings.remark = node.querySelector('#invRemark').value.trim();
      Toast.show('Invoice saved (mock)');
    });
    node.querySelector('#invPreview').addEventListener('click', ()=>{
      openOverlay('Invoice (print preview)', document.createTextNode('Print-ready invoice sheet (mock).'));
    });
    node.querySelector('#recPreview').addEventListener('click', ()=>{
      openOverlay('Receipt (print preview)', document.createTextNode('Print-ready receipt sheet (mock).'));
    });
    node.querySelector('#invAttach').addEventListener('click', ()=>{
      Toast.show('Attach slip (mock)');
    });
  }
};

/* ---------- FILES (base64 gallery) ---------- */
Views.files = function renderFiles(){
  // Ensure at least one placeholder image in Store.files
  if (!Store.files.length){
    Store.files.push({
      id:'f1',
      name:'placeholder-slip.png',
      data:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8Xw8AAmMB8b0C6d8AAAAASUVORK5CYII=',
      tags:['slip','demo'], createdAt: new Date().toISOString()
    });
  }

  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div class="files-toolbar">
        <h2 style="margin:0">Files</h2>
        <input id="fSearch" placeholder="Search name/tag‚Ä¶" style="padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel)">
        <input id="fUpload" type="file" accept="image/*" multiple class="btn">
        <button class="btn" id="fClear">Clear Search</button>
      </div>
      <div class="dropzone" id="dropzone" style="margin-top:10px">Drag & drop images here (mock in-memory)</div>
    </div>
    <div class="files-grid" id="fGrid"></div>
  `;
  $('#view').replaceChildren(wrap);

  const grid = wrap.querySelector('#fGrid');

  function paint(){
    const q = wrap.querySelector('#fSearch').value.trim().toLowerCase();
    const list = Store.files.filter(f=>{
      const t = (f.name + ' ' + (f.tags||[]).join(' ')).toLowerCase();
      return q ? t.includes(q) : true;
    });
    grid.innerHTML = list.map(f=>`
      <article class="file-card">
        <div class="file-thumb"><img src="${f.data}" alt="${f.name}"></div>
        <div class="file-meta">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:75%">${f.name}</strong>
            <button class="btn ghost" data-del="${f.id}" aria-label="Delete file">‚úï</button>
          </div>
          <input class="tag-input" data-tags="${f.id}" value="${(f.tags||[]).join(', ')}" placeholder="Add tags, comma-separated">
          <div class="subtle">${new Date(f.createdAt).toLocaleString()}</div>
        </div>
      </article>
    `).join('') || `<div class="card"><em>No files yet.</em></div>`;
  }
  paint();

  // Upload via input
  wrap.querySelector('#fUpload').addEventListener('change', (e)=>{
    const files = Array.from(e.target.files||[]);
    if (!files.length) return;
    const readers = files.map(file => new Promise(res=>{
      const rd = new FileReader();
      rd.onload = ()=>res({ name:file.name, data: rd.result });
      rd.readAsDataURL(file);
    }));
    Promise.all(readers).then(all=>{
      all.forEach(x=>{
        Store.files.push({ id:'f'+(Store.files.length+1), name:x.name, data:x.data, tags:[], createdAt:new Date().toISOString() });
      });
      paint();
      Toast.show('Uploaded (mock)');
    });
    e.target.value = '';
  });

  // Drag & drop
  const dz = wrap.querySelector('#dropzone');
  ;['dragenter','dragover'].forEach(ev=>{
    dz.addEventListener(ev, e=>{ e.preventDefault(); dz.style.background='var(--hover)'; });
  });
  ;['dragleave','drop'].forEach(ev=>{
    dz.addEventListener(ev, e=>{ e.preventDefault(); dz.style.background=''; });
  });
  dz.addEventListener('drop', (e)=>{
    const files = Array.from(e.dataTransfer.files||[]).filter(f=>f.type.startsWith('image/'));
    if (!files.length) return;
    const readers = files.map(file => new Promise(res=>{
      const rd = new FileReader();
      rd.onload = ()=>res({ name:file.name, data: rd.result });
      rd.readAsDataURL(file);
    }));
    Promise.all(readers).then(all=>{
      all.forEach(x=>{
        Store.files.push({ id:'f'+(Store.files.length+1), name:x.name, data:x.data, tags:[], createdAt:new Date().toISOString() });
      });
      paint();
      Toast.show('Dropped (mock)');
    });
  });

  // Delete + tag edit (delegation)
  wrap.addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del]');
    if (del){
      const id = del.dataset.del;
      const idx = Store.files.findIndex(f=>f.id===id);
      if (idx>=0) Store.files.splice(idx,1);
      paint();
    }
  });
  wrap.addEventListener('change', (e)=>{
    const tagInput = e.target.closest('[data-tags]');
    if (tagInput){
      const id = tagInput.getAttribute('data-tags');
      const f = Store.files.find(x=>x.id===id);
      if (f) f.tags = tagInput.value.split(',').map(s=>s.trim()).filter(Boolean);
      Toast.show('Tags updated (mock)');
    }
  });

  wrap.querySelector('#fClear').addEventListener('click', ()=>{
    wrap.querySelector('#fSearch').value='';
    paint();
  });

  // TODO: Backend Storage ‚Äî persist files.
};

</script>
<!-- ==== PART 3 END ===================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 4 START =================================================== -->
<style>
  /* ---------- Builder & Print ---------- */
  .builder-grid {
    display:grid; gap:12px;
    grid-template-columns: 1.2fr 1fr;
  }
  @media (max-width: 1000px){ .builder-grid { grid-template-columns: 1fr; } }

  .print-sheet {
    background: white; color: black;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }
  .print-head {
    display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:start;
    border-bottom: 2px solid #0003; padding-bottom: 8px; margin-bottom: 8px;
  }
  .logo-box {
    width: 64px; height: 64px; border-radius: 14px;
    background: linear-gradient(135deg, #2563eb, #4f46e5);
  }
  .doc-title { font-size: 24px; font-weight: 800; letter-spacing: 0.02em; }
  .meta-grid { display:grid; grid-template-columns: 1fr 1fr; gap:6px; }
  .line-items { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .line-items th, .line-items td { border: 1px solid #0002; padding: 8px; }
  .li-right { text-align: right; }
  .print-foot {
    display:grid; grid-template-columns: 1fr; gap:8px; margin-top: 10px;
    border-top: 2px solid #0003; padding-top: 8px;
  }
  .print-remark { font-size: 12px; color: #222; }

  /* Print isolation */
  @media print {
    body { background: white !important; color: black !important; }
    .sidebar, .topbar, #toast, #overlay, .quick-actions { display:none !important; }
    .main { padding: 0 !important; }
    #view > *:not(.print-sheet) { display:none !important; }
    .print-sheet { border:none !important; border-radius:0 !important; box-shadow:none !important; }
  }

  /* ---------- Reports ---------- */
  .report-toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .sum-row { background: var(--hover); font-weight: 700; }

  /* ---------- Settings ---------- */
  .settings-grid {
    display:grid; gap:12px;
    grid-template-columns: 1fr 1fr;
  }
  @media (max-width: 1100px){ .settings-grid { grid-template-columns: 1fr; } }
  .list-table { width:100%; border-collapse: collapse; }
  .list-table th, .list-table td { border-bottom: 1px solid var(--border); padding: 8px; }
</style>

<script>
/* ========================= PART 4 SCRIPT ========================= */

/* ---------- VIEW: Builder (Invoices & Receipts) ---------- */
Views.builder = function renderBuilder(){
  // local working state
  const state = {
    docType: 'INVOICE',
    docNo: 'INV-' + Math.floor(Math.random()*9000+1000),
    date: new Date().toISOString().slice(0,10),
    roomId: Store.rooms[0]?.id || null,
    renterId: Store.renters[0]?.id || null,
    addrId: Store.addresses[0]?.id || null,
    bankId: Store.bankAccounts[0]?.id || null,
    remark: 'Thank you for your payment.',
    items: [
      { name:'Room Rate', qty:1, price: Store.defaults.roomRate },
      { name:'Electricity', qty:1, price: 0 },
      { name:'Water', qty:1, price: 0 },
    ],
    lateFee: 0,
    depositReturn: 0,
    moveOut: false,
  };

  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <div class="builder-grid">
      <div class="card">
        <h2 style="margin:0 0 8px 0">Invoice & Receipt Builder</h2>
        <div class="form-row">
          <div class="field">
            <label>Document Type</label>
            <select id="bdType">
              <option>INVOICE</option>
              <option>RECEIPT</option>
            </select>
          </div>
          <div class="field">
            <label>Document No.</label>
            <input id="bdNo" value="${state.docNo}">
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Date</label>
            <input id="bdDate" type="date" value="${state.date}">
          </div>
          <div class="field">
            <label>Room</label>
            <select id="bdRoom">
              ${Store.rooms.map(r=>`<option value="${r.id}">${r.roomNo}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Renter</label>
            <select id="bdRenter">
              ${Store.renters.map(r=>`<option value="${r.id}">${r.name}</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <label>Apartment Address</label>
            <select id="bdAddr">
              ${Store.addresses.map(a=>`<option value="${a.id}">${a.name} ‚Äî ${a.addr}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Payment Method (Bank Account)</label>
            <select id="bdBank">
              ${Store.bankAccounts.map(b=>`<option value="${b.id}">${b.bank} ‚Äî ${b.acct} (${b.name})</option>`).join('')}
            </select>
          </div>
          <div class="field">
            <label>Remark (footer)</label>
            <input id="bdRemark" value="${state.remark}">
          </div>
        </div>

        <div class="card" style="margin-top:8px">
          <h3 style="margin:0 0 8px 0">Line Items</h3>
          <div id="itemsHost"></div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn" id="addItem">Add Item</button>
            <button class="btn ghost" id="resetItems">Reset</button>
          </div>
        </div>

        <div class="form-row" style="margin-top:10px">
          <div class="field">
            <label>Late Fee</label>
            <input id="bdLate" type="number" min="0" step="1" value="0">
          </div>
          <div class="field">
            <label>Deposit Return</label>
            <input id="bdDepReturn" type="number" step="1" value="0">
          </div>
        </div>
        <div class="field" style="margin-top:6px">
          <label><input id="bdMoveOut" type="checkbox"> Move-Out (show deposit return line)</label>
        </div>

        <div class="card" style="margin-top:10px">
          <div style="display:grid;grid-template-columns:1fr auto;gap:6px">
            <div>Subtotal</div><div class="li-right" id="bdSubtotal">‡∏ø0</div>
            <div>Late Fee</div><div class="li-right" id="bdLateShow">‡∏ø0</div>
            <div>Deposit Return</div><div class="li-right" id="bdDepShow">‡∏ø0</div>
            <div style="grid-column:1/-1;border-top:1px dashed var(--border)"></div>
            <div><strong>Total</strong></div><div class="li-right" id="bdTotal"><strong>‡∏ø0</strong></div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="btn" id="bdPreview">Preview / Print</button>
          <button class="btn" id="bdSave">Save (mock)</button>
          <!-- TODO: Google Sheets ‚Äî push invoice rows. -->
        </div>
      </div>

      <!-- PRINT PREVIEW TARGET -->
      <div class="print-sheet" id="printSheet" aria-label="Print sheet">
        <!-- Filled by paintPrint() -->
      </div>
    </div>
  `;
  $('#view').replaceChildren(wrap);

  // Element refs
  const els = {
    type: $('#bdType', wrap), no: $('#bdNo', wrap), date: $('#bdDate', wrap),
    room: $('#bdRoom', wrap), renter: $('#bdRenter', wrap), addr: $('#bdAddr', wrap),
    bank: $('#bdBank', wrap), remark: $('#bdRemark', wrap),
    itemsHost: $('#itemsHost', wrap),
    addItem: $('#addItem', wrap), resetItems: $('#resetItems', wrap),
    late: $('#bdLate', wrap), depRet: $('#bdDepReturn', wrap), moveOut: $('#bdMoveOut', wrap),
    subtotal: $('#bdSubtotal', wrap), lateShow: $('#bdLateShow', wrap), depShow: $('#bdDepShow', wrap), total: $('#bdTotal', wrap),
    preview: $('#bdPreview', wrap), save: $('#bdSave', wrap),
    printSheet: $('#printSheet', wrap),
  };

  // Bind initial selects to state defaults
  els.room.value = state.roomId;
  els.renter.value = state.renterId;
  els.addr.value = state.addrId;
  els.bank.value = state.bankId;

  function paintItems(){
    els.itemsHost.innerHTML = state.items.map((it,idx)=>`
      <div class="form-row" data-idx="${idx}">
        <div class="field">
          <label>Item</label>
          <input data-k="name" value="${it.name}">
        </div>
        <div class="field">
          <label>Qty</label>
          <input data-k="qty" type="number" min="0" step="1" value="${it.qty}">
        </div>
        <div class="field">
          <label>Price</label>
          <input data-k="price" type="number" step="1" value="${it.price}">
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="btn ghost" data-del="${idx}">Delete</button>
        </div>
      </div>
    `).join('');
  }

  function calcTotals(){
    const subtotal = state.items.reduce((a,b)=>a + (Number(b.qty||0)*Number(b.price||0)), 0);
    const late = Number(els.late.value||0);
    const dep = Number(els.depRet.value||0);
    const total = subtotal + late - (state.moveOut ? dep : 0);
    els.subtotal.textContent = currency(subtotal);
    els.lateShow.textContent = currency(late);
    els.depShow.textContent = state.moveOut ? '-'+currency(dep) : '‚Äî';
    els.total.innerHTML = `<strong>${currency(total)}</strong>`;
    return { subtotal, late, dep, total };
  }

  function paintPrint(){
    const room = Store.rooms.find(r=>r.id===els.room.value);
    const renter = Store.renters.find(r=>r.id===els.renter.value);
    const addr = Store.addresses.find(a=>a.id===els.addr.value);
    const bank = Store.bankAccounts.find(b=>b.id===els.bank.value);
    const totals = calcTotals();

    const lineRows = state.items.map(it=>`
      <tr>
        <td>${it.name}</td>
        <td class="li-right">${Number(it.qty||0)}</td>
        <td class="li-right">${currency(Number(it.price||0))}</td>
        <td class="li-right">${currency(Number(it.qty||0)*Number(it.price||0))}</td>
      </tr>`).join('');

    const depRow = state.moveOut ? `
      <tr>
        <td>Deposit Return</td>
        <td class="li-right">1</td>
        <td class="li-right">${currency(Number(els.depRet.value||0))}</td>
        <td class="li-right">-${currency(Number(els.depRet.value||0))}</td>
      </tr>` : '';

    els.printSheet.innerHTML = `
      <div class="print-head">
        <div style="display:flex;gap:10px;align-items:center">
          <div class="logo-box" aria-hidden="true"></div>
          <div>
            <div style="font-weight:800">Apartment Admin</div>
            <div style="font-size:12px">${addr?.name || ''}</div>
            <div style="font-size:12px">${addr?.addr || ''}</div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="doc-title">${els.type.value}</div>
          <div>Doc No: <strong>${els.no.value}</strong></div>
          <div>Date: <strong>${els.date.value}</strong></div>
          <div>Room: <strong>${room?.roomNo || ''}</strong></div>
        </div>
      </div>

      <div class="meta-grid">
        <div>
          <div style="font-weight:700">Bill To:</div>
          <div>${renter?.name || ''}</div>
          <div style="font-size:12px">${renter?.address || ''}</div>
          <div style="font-size:12px">Phone: ${renter?.phone || ''}</div>
        </div>
        <div>
          <div style="font-weight:700">Payment Method:</div>
          <div>${bank?.bank || ''} ‚Ä¢ ${bank?.acct || ''}</div>
          <div style="font-size:12px">${bank?.name || ''}</div>
        </div>
      </div>

      <table class="line-items">
        <thead>
          <tr><th>Description</th><th class="li-right">Qty</th><th class="li-right">Unit</th><th class="li-right">Amount</th></tr>
        </thead>
        <tbody>
          ${lineRows}
          ${state.moveOut ? '<tr><td colspan="4" style="background:#0001;height:8px"></td></tr>' : ''}
          ${depRow}
        </tbody>
        <tfoot>
          <tr><td colspan="3" class="li-right"><strong>Subtotal</strong></td><td class="li-right">${currency(totals.subtotal)}</td></tr>
          <tr><td colspan="3" class="li-right"><strong>Late Fee</strong></td><td class="li-right">${currency(totals.late)}</td></tr>
          ${state.moveOut ? `<tr><td colspan="3" class="li-right"><strong>Deposit Return</strong></td><td class="li-right">-${currency(totals.dep)}</td></tr>` : ''}
          <tr><td colspan="3" class="li-right"><strong>Total</strong></td><td class="li-right"><strong>${currency(totals.total)}</strong></td></tr>
        </tfoot>
      </table>

      <div class="print-foot">
        <div class="print-remark">${els.remark.value}</div>
      </div>
    `;
  }

  // Wire events
  wrap.addEventListener('input', (e)=>{
    if (e.target===els.type) state.docType = els.type.value;
    if (e.target===els.no) state.docNo = els.no.value;
    if (e.target===els.date) state.date = els.date.value;
    if (e.target===els.remark) state.remark = els.remark.value;
    if (e.target===els.late) state.lateFee = Number(els.late.value||0);
    if (e.target===els.depRet) state.depositReturn = Number(els.depRet.value||0);
    if (e.target===els.moveOut) state.moveOut = els.moveOut.checked;
    calcTotals();
    paintPrint();
  });

  // Items events
  els.itemsHost.addEventListener('input', (e)=>{
    const row = e.target.closest('[data-idx]');
    if (!row) return;
    const idx = Number(row.dataset.idx);
    const key = e.target.getAttribute('data-k');
    if (!key) return;
    const val = (key==='name') ? e.target.value : Number(e.target.value||0);
    state.items[idx][key] = val;
    calcTotals();
    paintPrint();
  });
  els.itemsHost.addEventListener('click', (e)=>{
    const del = e.target.closest('[data-del]');
    if (del){ state.items.splice(Number(del.dataset.del),1); paintItems(); calcTotals(); paintPrint(); }
  });

  els.addItem.addEventListener('click', ()=>{
    state.items.push({ name:'Item', qty:1, price:0 });
    paintItems(); calcTotals(); paintPrint();
  });
  els.resetItems.addEventListener('click', ()=>{
    state.items = [
      { name:'Room Rate', qty:1, price: Store.defaults.roomRate },
      { name:'Electricity', qty:1, price: 0 },
      { name:'Water', qty:1, price: 0 },
    ];
    paintItems(); calcTotals(); paintPrint();
  });

  els.preview.addEventListener('click', ()=>{
    paintPrint();
    window.print(); // user prints to PDF
  });

  els.save.addEventListener('click', ()=>{
    // Mock: push into invoices list
    const invId = 'inv'+(Store.invoices.length+1);
    Store.invoices.push({
      id: invId, roomId: els.room.value, renterId: els.renter.value,
      yyyymm: monthKey(new Date(els.date.value)), total: calcTotals().total,
      status: state.docType==='RECEIPT' ? 'paid' : 'sent',
      method: 'Bank Transfer', slip: null,
      settings: { addressId: els.addr.value, remark: els.remark.value }
    });
    Toast.show('Saved to mock invoices');
    // TODO: Google Sheets ‚Äî push invoice/receipt rows.
  });

  // Initial paint
  paintItems(); calcTotals(); paintPrint();
};

/* ---------- VIEW: Reports (Monthly & Yearly + CSV) ---------- */
Views.reports = function renderReports(){
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div class="report-toolbar">
        <h2 style="margin:0">Reports</h2>
        <input id="repMonth" type="month" value="${monthKey()}" class="btn">
        <button class="btn" id="repMonthly">Monthly Report</button>
        <button class="btn" id="repYearly">Yearly Report</button>
        <button class="btn" id="repCSV">Export CSV</button>
        <button class="btn" id="repCopy">Copy CSV</button>
      </div>
    </div>
    <div class="card" id="repTable"></div>
  `;
  $('#view').replaceChildren(wrap);

  // Data builders
  function monthlyRows(yyyymm){
    // Columns: Room No., Date of Payment, Amount, Payment Method, Status
    const rows = Store.invoices
      .filter(i=>i.yyyymm===yyyymm)
      .map(i=>{
        const room = Store.rooms.find(r=>r.id===i.roomId)?.roomNo ?? '';
        const renter = Store.renters.find(r=>r.id===i.renterId)?.name ?? '';
        return [room, renter, `${yyyymm}-01`, i.total, i.method, i.status];
      });
    return rows;
  }
  function yearlyRows(yyyy){
    // Totals per month and category (simple: total only)
    const months = Array.from({length:12}, (_,m)=>`${yyyy}-${String(m+1).padStart(2,'0')}`);
    const rows = months.map(m=>{
      const invs = Store.invoices.filter(i=>i.yyyymm===m);
      const total = invs.reduce((a,b)=>a+b.total,0);
      return [m, total];
    });
    return rows;
  }

  // Renderers
  function renderMonthly(yyyymm){
    const rows = monthlyRows(yyyymm);
    const total = rows.reduce((a,r)=>a + Number(r[3]||0), 0);
    $('#repTable').innerHTML = `
      <h3 style="margin:0 0 8px 0">Monthly Report ‚Äî ${yyyymm}</h3>
      <div style="overflow:auto">
        <table aria-label="Monthly report table">
          <thead>
            <tr><th>Room</th><th>Renter</th><th>Date</th><th>Amount</th><th>Method</th><th>Status</th></tr>
          </thead>
          <tbody>
            ${rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${currency(r[3])}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`).join('')}
            <tr class="sum-row"><td colspan="3">Total</td><td>${currency(total)}</td><td colspan="2"></td></tr>
          </tbody>
        </table>
      </div>
    `;
    currentCSV = toCSV([['Room','Renter','Date','Amount','Method','Status'], ...rows, ['Total','','', total, '', '']]);
  }
  function renderYearly(yyyy){
    const rows = yearlyRows(yyyy);
    const total = rows.reduce((a,r)=>a + Number(r[1]||0), 0);
    $('#repTable').innerHTML = `
      <h3 style="margin:0 0 8px 0">Yearly Report ‚Äî ${yyyy}</h3>
      <div style="overflow:auto">
        <table aria-label="Yearly report table">
          <thead>
            <tr><th>Month</th><th>Total Amount</th></tr>
          </thead>
          <tbody>
            ${rows.map(r=>`<tr><td>${r[0]}</td><td>${currency(r[1])}</td></tr>`).join('')}
            <tr class="sum-row"><td>Total</td><td>${currency(total)}</td></tr>
          </tbody>
        </table>
      </div>
    `;
    currentCSV = toCSV([['Month','Total'], ...rows, ['Total', total]]);
  }

  // CSV helpers
  function toCSV(rows){
    return rows.map(r=>r.map(v=>{
      const s = String(v ?? '');
      return s.includes(',') || s.includes('"') ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');
  }
  let currentCSV = '';

  // Wire buttons
  $('#repMonthly', wrap).addEventListener('click', ()=>{
    renderMonthly($('#repMonth', wrap).value || monthKey());
  });
  $('#repYearly', wrap).addEventListener('click', ()=>{
    const yyyy = ($('#repMonth', wrap).value || monthKey()).slice(0,4);
    renderYearly(yyyy);
  });
  $('#repCSV', wrap).addEventListener('click', ()=>{
    if (!currentCSV) return Toast.show('Run a report first.');
    const blob = new Blob([currentCSV], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'report.csv';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });
  $('#repCopy', wrap).addEventListener('click', async()=>{
    if (!currentCSV) return Toast.show('Run a report first.');
    try { await navigator.clipboard.writeText(currentCSV); Toast.show('CSV copied'); }
    catch { Toast.show('Copy failed'); }
  });

  // Default render: Monthly current
  renderMonthly(monthKey());
  // TODO: Google Sheets ‚Äî report sync.
};

/* ---------- VIEW: Settings ---------- */
Views.settings = function renderSettings(){
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <h2 style="margin:0">Settings</h2>
      <small class="subtle">UI-only; persists in memory for this session.</small>
    </div>

    <div class="settings-grid">
      <div class="card">
        <h3 style="margin:0 0 8px 0">Utilities & Defaults</h3>
        <div class="form-row">
          <div class="field">
            <label>Electricity Rate (THB/kWh)</label>
            <input id="stElec" type="number" step="0.01" value="${Store.utilities.elecRate}">
          </div>
          <div class="field">
            <label>Water Rate (THB/m¬≥)</label>
            <input id="stWater" type="number" step="0.01" value="${Store.utilities.waterRate}">
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Default Room Rate</label>
            <input id="stRoomRate" type="number" step="1" value="${Store.defaults.roomRate}">
          </div>
          <div class="field">
            <label>Late Fee Policy</label>
            <select id="stLateType">
              <option ${Store.defaults.lateFee.type==='flat'?'selected':''} value="flat">Flat</option>
              <option ${Store.defaults.lateFee.type==='percent'?'selected':''} value="percent">Percent</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Late Fee Value</label>
            <input id="stLateVal" type="number" step="1" value="${Store.defaults.lateFee.value}">
          </div>
          <div class="field">
            <label>Deposit Policy (text)</label>
            <input id="stDepositPolicy" value="${Store.defaults.depositPolicy}">
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Invoice Terms (days)</label>
            <input id="stTerms" type="number" step="1" value="${Store.terms || 7}">
          </div>
          <div class="field">
            <label>Due Days</label>
            <input id="stDue" type="number" step="1" value="${Store.dueDays || 5}">
          </div>
        </div>
        <div>
          <button class="btn" id="stSave1">Save Utilities & Defaults (mock)</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Bank Accounts</h3>
        <table class="list-table" aria-label="Bank accounts">
          <thead><tr><th>Bank</th><th>Account</th><th>Name</th><th></th></tr></thead>
          <tbody id="bankBody"></tbody>
        </table>
        <div class="form-row" style="margin-top:8px">
          <div class="field"><label>Bank</label><input id="bBank"></div>
          <div class="field"><label>Account</label><input id="bAcct"></div>
          <div class="field"><label>Name</label><input id="bName"></div>
          <div class="field"><label>&nbsp;</label><button class="btn" id="bAdd">Add</button></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Apartment Addresses</h3>
        <table class="list-table" aria-label="Addresses">
          <thead><tr><th>Name</th><th>Address</th><th></th></tr></thead>
          <tbody id="addrBody"></tbody>
        </table>
        <div class="form-row" style="margin-top:8px">
          <div class="field"><label>Name</label><input id="aName"></div>
          <div class="field"><label>Address</label><input id="aAddr"></div>
          <div class="field"><label>&nbsp;</label><button class="btn" id="aAdd">Add</button></div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Display Toggles</h3>
        <div class="field"><label><input id="tgDenseTables" type="checkbox"> Dense table rows</label></div>
        <div class="field"><label><input id="tgShowHints" type="checkbox" checked> Show helper hints</label></div>
        <div style="margin-top:8px"><button class="btn" id="stSave2">Save Display (mock)</button></div>
      </div>
    </div>
  `;
  $('#view').replaceChildren(wrap);

  // Utilities & defaults
  $('#stSave1', wrap).addEventListener('click', ()=>{
    Store.utilities.elecRate = Number($('#stElec', wrap).value||Store.utilities.elecRate);
    Store.utilities.waterRate = Number($('#stWater', wrap).value||Store.utilities.waterRate);
    Store.defaults.roomRate = Number($('#stRoomRate', wrap).value||Store.defaults.roomRate);
    Store.defaults.lateFee.type = $('#stLateType', wrap).value;
    Store.defaults.lateFee.value = Number($('#stLateVal', wrap).value||Store.defaults.lateFee.value);
    Store.defaults.depositPolicy = $('#stDepositPolicy', wrap).value;
    Store.terms = Number($('#stTerms', wrap).value||7);
    Store.dueDays = Number($('#stDue', wrap).value||5);
    Toast.show('Saved (mock)');
    // TODO: Google Sheets ‚Äî save config.
  });

  // Banks
  const bankBody = $('#bankBody', wrap);
  function paintBanks(){
    bankBody.innerHTML = Store.bankAccounts.map((b,i)=>`
      <tr>
        <td>${b.bank}</td><td>${b.acct}</td><td>${b.name}</td>
        <td><button class="btn ghost" data-delb="${i}">Delete</button></td>
      </tr>`).join('') || `<tr><td colspan="4"><em>No accounts.</em></td></tr>`;
  }
  paintBanks();
  $('#bAdd', wrap).addEventListener('click', ()=>{
    const bank = $('#bBank', wrap).value.trim();
    const acct = $('#bAcct', wrap).value.trim();
    const name = $('#bName', wrap).value.trim();
    if (!bank || !acct) return Toast.show('Bank and Account required');
    Store.bankAccounts.push({ id:'b'+(Store.bankAccounts.length+1), bank, acct, name: name || 'East Home Property' });
    paintBanks(); Toast.show('Added (mock)');
  });
  bankBody.addEventListener('click', (e)=>{
    const del = e.target.closest('[data-delb]');
    if (del){ Store.bankAccounts.splice(Number(del.dataset.delb),1); paintBanks(); }
  });

  // Addresses
  const addrBody = $('#addrBody', wrap);
  function paintAddrs(){
    addrBody.innerHTML = Store.addresses.map((a,i)=>`
      <tr>
        <td>${a.name}</td><td>${a.addr}</td>
        <td><button class="btn ghost" data-dela="${i}">Delete</button></td>
      </tr>`).join('') || `<tr><td colspan="3"><em>No addresses.</em></td></tr>`;
  }
  paintAddrs();
  $('#aAdd', wrap).addEventListener('click', ()=>{
    const name = $('#aName', wrap).value.trim();
    const addr = $('#aAddr', wrap).value.trim();
    if (!name || !addr) return Toast.show('Name and Address required');
    Store.addresses.push({ id:'a'+(Store.addresses.length+1), name, addr });
    paintAddrs(); Toast.show('Added (mock)');
  });
  addrBody.addEventListener('click', (e)=>{
    const del = e.target.closest('[data-dela]');
    if (del){ Store.addresses.splice(Number(del.dataset.dela),1); paintAddrs(); }
  });

  // Display toggles (mock preferences only)
  $('#stSave2', wrap).addEventListener('click', ()=>{
    const dense = $('#tgDenseTables', wrap).checked;
    document.documentElement.style.setProperty('--row-alt', dense ? 'transparent' : getComputedStyle(document.documentElement).getPropertyValue('--row-alt'));
    Toast.show('Display toggles saved (mock)');
  });
};
</script>
<!-- ==== PART 4 END ===================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 5 START =================================================== -->
<style>
  /* ---------- Loading Skeletons ---------- */
  .skeleton {
    position: relative; overflow: hidden; border-radius: 10px;
    background: linear-gradient(90deg, rgba(148,163,184,0.12), rgba(148,163,184,0.18), rgba(148,163,184,0.12));
    height: 14px;
  }
  .skeleton::after {
    content: ""; position: absolute; inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.28), transparent);
    animation: shimmer 1.2s infinite;
  }
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  .s-card {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: var(--radius); box-shadow: var(--shadow); padding: 14px;
  }
  .s-grid { display:grid; gap:12px; }
  .s-kpis { display:grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
  .s-kpis > .s-card { grid-column: span 3; height: 84px; }
  @media (max-width:980px){ .s-kpis > .s-card { grid-column: span 6; } }
  @media (max-width:640px){ .s-kpis > .s-card { grid-column: span 12; } }

  /* ---------- Mobile Bottom Tabs ---------- */
  .mobile-tabs {
    position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
    width: min(720px, calc(100vw - 20px));
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 999px; box-shadow: var(--shadow);
    display: none; z-index: 50;
    padding: 8px;
  }
  .mobile-tabs nav {
    display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px;
  }
  .mobile-tabs button {
    border: 1px solid var(--border);
    background: transparent; border-radius: 999px; padding: 8px 6px;
    font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .mobile-tabs button[aria-current="page"] { background: var(--hover); }
  @media (max-width: 980px){ .mobile-tabs { display: block; } }
  @media print { .mobile-tabs { display:none !important; } }
</style>

<script>
/* ========================= PART 5 SCRIPT ========================= */

/* ---------- Extra mock slips (so Files looks alive) ---------- */
(function seedExtraSlips(){
  if (!Store._extraSlips) {
    const tinyPNG = 'iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAQAAACEN3D/AAAADUlEQVQYV2P8z8DwHwAGYgJv8C0SxQAAAABJRU5ErkJggg==';
    const mk = (id,colorName)=>({
      id, name:`slip-${colorName}.png`,
      data:`data:image/png;base64,${tinyPNG}`, // placeholder byte; UI demo only
      tags:['slip'], createdAt: new Date().toISOString()
    });
    Store.files.push(mk('fx1','blue'), mk('fx2','green'), mk('fx3','amber'));
    Store._extraSlips = true;
  }
})();

/* ---------- Mobile bottom tabs (routes shortcut on small screens) ---------- */
(function initMobileTabs(){
  const bar = document.createElement('div');
  bar.className = 'mobile-tabs';
  bar.innerHTML = `
    <nav aria-label="Mobile Tabs">
      <button data-route="dashboard">üìä Dashboard</button>
      <button data-route="rooms">üè¢ Rooms</button>
      <button data-route="payments">üí∏ Payments</button>
      <button data-route="reports">üìà Reports</button>
      <button data-route="settings">‚öôÔ∏è Settings</button>
    </nav>
  `;
  document.body.appendChild(bar);
  function paintActive(){
    const route = Router.current;
    bar.querySelectorAll('button').forEach(b=>{
      b.setAttribute('aria-current', b.dataset.route===route ? 'page' : 'false');
    });
  }
  bar.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-route]');
    if (!btn) return;
    Router.navigate(btn.dataset.route);
    paintActive();
  });
  // Repaint when route changes (monkey-patch navigate)
  const _nav = Router.navigate.bind(Router);
  Router.navigate = (r)=>{ _nav(r); paintActive(); };
  paintActive();
})();

/* ---------- Loading skeleton manager ---------- */
const Skeletons = {
  tpl(route){
    switch(route){
      case 'dashboard': return `
        <div class="s-kpis">
          <div class="s-card"><div class="skeleton" style="width:40%"></div><div class="skeleton" style="width:70%;height:24px;margin-top:8px"></div></div>
          <div class="s-card"><div class="skeleton" style="width:40%"></div><div class="skeleton" style="width:70%;height:24px;margin-top:8px"></div></div>
          <div class="s-card"><div class="skeleton" style="width:40%"></div><div class="skeleton" style="width:70%;height:24px;margin-top:8px"></div></div>
          <div class="s-card"><div class="skeleton" style="width:40%"></div><div class="skeleton" style="width:70%;height:24px;margin-top:8px"></div></div>
        </div>
        <div class="s-card" style="margin-top:12px">
          <div class="skeleton" style="width:24%;height:18px"></div>
          <div class="s-grid" style="margin-top:10px">
            ${'<div class="skeleton" style="height:18px"></div>'.repeat(6)}
          </div>
        </div>`;
      case 'rooms': return Skeletons.list('Room cards loading‚Ä¶', 12);
      case 'renters': return Skeletons.list('Renters loading‚Ä¶', 8);
      case 'payments': return Skeletons.list('Payments loading‚Ä¶', 10);
      case 'reports': return `
        <div class="s-card"><div class="skeleton" style="width:30%;height:18px"></div></div>
        <div class="s-card" style="margin-top:12px">
          ${'<div class="skeleton" style="height:18px;margin:6px 0"></div>'.repeat(10)}
        </div>`;
      case 'files': return Skeletons.grid('Files loading‚Ä¶', 9);
      case 'builder': return `
        <div class="s-grid">
          <div class="s-card"><div class="skeleton" style="width:40%;height:18px"></div>${'<div class="skeleton" style="height:14px;margin-top:8px"></div>'.repeat(6)}</div>
          <div class="s-card"><div class="skeleton" style="width:30%;height:18px"></div>${'<div class="skeleton" style="height:14px;margin-top:8px"></div>'.repeat(8)}</div>
        </div>`;
      case 'settings': return `
        <div class="s-grid">
          ${'<div class="s-card"><div class="skeleton" style="width:45%;height:18px"></div>' +
             '<div class="skeleton" style="height:14px;margin-top:8px"></div>'.repeat(5) +
            '</div>'}
          ${'<div class="s-card"><div class="skeleton" style="width:45%;height:18px"></div>' +
             '<div class="skeleton" style="height:14px;margin-top:8px"></div>'.repeat(5) +
            '</div>'}
        </div>`;
      default: return `<div class="s-card"><div class="skeleton" style="width:50%"></div></div>`;
    }
  },
  list(title, n){
    return `
      <div class="s-card"><div class="skeleton" style="width:30%;height:18px"></div></div>
      <div class="s-grid" style="grid-template-columns: repeat(4, 1fr)">
        ${Array.from({length:n}).map(()=>`
          <div class="s-card">
            <div class="skeleton" style="width:60%;height:16px"></div>
            <div class="skeleton" style="height:12px;margin-top:8px"></div>
            <div class="skeleton" style="width:40%;height:12px;margin-top:6px"></div>
          </div>`).join('')}
      </div>`;
  },
  grid(title, n){
    return `
      <div class="s-card"><div class="skeleton" style="width:30%;height:18px"></div></div>
      <div class="s-grid" style="grid-template-columns: repeat(6, 1fr)">
        ${Array.from({length:n}).map(()=>`
          <div class="s-card" style="height:160px;display:grid;align-content:end;">
            <div class="skeleton" style="height:120px"></div>
            <div class="skeleton" style="height:12px;margin-top:8px"></div>
          </div>`).join('')}
      </div>`;
  }
};

/* ---------- Router loading shim (adds ~220ms skeleton for perceived speed) ---------- */
(function shimRouterWithSkeletons(){
  const orig = Router.navigate.bind(Router);
  Router.navigate = function(route){
    // Paint skeleton immediately
    const host = document.getElementById('view');
    if (host) host.innerHTML = Skeletons.tpl(route);
    // Slight delay, then render real view
    setTimeout(()=>{ orig(route); }, 220);
    // keep sidebar active state & mobile tab sync via patched navigate in Part 5 init
  };
})();

/* ---------- Optional: mini command palette (Ctrl+K / ‚åòK) ---------- */
(function commandPalette(){
  let open = false;
  document.addEventListener('keydown', (e)=>{
    const mod = e.ctrlKey || e.metaKey;
    if (mod && e.key.toLowerCase()==='k'){
      e.preventDefault();
      open = !open;
      if (open){
        const node = document.createElement('div');
        node.innerHTML = `
          <div class="field"><label>Jump to‚Ä¶</label>
            <input id="cmdJump" placeholder="dashboard, rooms, renters, payments, builder, reports, files, settings">
          </div>`;
        openOverlay('Command Palette', node);
        setTimeout(()=>$('#cmdJump')?.focus(), 0);
        $('#sheetBody').addEventListener('keydown', ev=>{
          if (ev.key==='Enter'){
            const v = $('#cmdJump').value.trim().toLowerCase();
            const map = { d:'dashboard', r:'rooms', n:'renters', p:'payments', b:'builder', rep:'reports', f:'files', s:'settings' };
            const route = ['dashboard','rooms','renters','payments','builder','reports','files','settings'].find(x=>x.startsWith(v)) || map[v] || v;
            if (Views[route]) { closeOverlay(); Router.navigate(route); }
          }
        }, { once:true });
      } else {
        closeOverlay();
      }
    }
  });
})();

</script>
<!-- ==== PART 5 END ===================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 6 START =================================================== -->
<style>
  /* ---------- Tooltips (ARIA-friendly) ---------- */
  .tip-layer {
    position: fixed; inset: 0; pointer-events: none; z-index: 99; /* above UI, below overlays */
  }
  .tip-bubble {
    position: absolute; transform: translate(-50%, calc(-100% - 10px));
    max-width: 280px;
    background: var(--panel);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 10px;
    box-shadow: var(--shadow);
    font-size: 12px;
    line-height: 1.35;
    pointer-events: none;
    white-space: nowrap;
  }
  .tip-bubble::after {
    content: ""; position: absolute; left: 50%; transform: translateX(-50%);
    bottom: -6px; width: 10px; height: 10px; rotate: 45deg;
    background: var(--panel); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border);
  }

  /* ---------- Print Watermark (applies to print-sheet only) ---------- */
  @media print {
    .print-sheet::before {
      content: "Apartment Admin";
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%) rotate(-24deg);
      font-size: 72px;
      color: rgba(0,0,0,0.06);
      letter-spacing: 2px;
      white-space: nowrap;
      z-index: -1;
    }
  }
</style>

<script>
/* ========================= PART 6 SCRIPT ========================= */

/* ---------- Tooltip engine ----------
   Usage: add [data-tip="text"] to any focusable/hoverable element.
   Optional: [data-tip-kbd="Ctrl+K"] to append a shortcut badge. */
const Tips = (()=> {
  const layer = document.createElement('div');
  layer.className = 'tip-layer';
  document.body.appendChild(layer);

  let active = null; // {el, bubble}

  function show(el){
    const msg = el.getAttribute('data-tip');
    if (!msg) return;
    hide();

    const bubble = document.createElement('div');
    bubble.className = 'tip-bubble';
    const kbd = el.getAttribute('data-tip-kbd');
    bubble.innerHTML = kbd
      ? `${escapeHTML(msg)} <span style="margin-left:8px;padding:2px 6px;border:1px solid var(--border);border-radius:6px;font-size:11px;">${escapeHTML(kbd)}</span>`
      : escapeHTML(msg);
    layer.appendChild(bubble);

    const rect = el.getBoundingClientRect();
    const x = rect.left + rect.width/2;
    const y = rect.top; // top edge
    positionBubble(bubble, x, y);
    active = { el, bubble };
  }
  function hide(){
    if (active){
      active.bubble.remove();
      active = null;
    }
  }
  function positionBubble(node, x, y){
    // keep within viewport
    const pad = 10;
    const vw = window.innerWidth;
    const nx = Math.min(Math.max(x, pad), vw - pad);
    node.style.left = nx + 'px';
    node.style.top  = y + 'px';
  }
  function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // Global delegation (hover/focus)
  document.addEventListener('mouseover', e=>{
    const el = e.target.closest('[data-tip]');
    if (!el) return;
    show(el);
  });
  document.addEventListener('mouseout', e=>{
    if (!e.relatedTarget || !e.relatedTarget.closest('.tip-bubble')) hide();
  });
  document.addEventListener('focusin', e=>{
    const el = e.target.closest('[data-tip]');
    if (el) show(el);
  });
  document.addEventListener('focusout', ()=> hide());
  window.addEventListener('scroll', ()=> hide());
  window.addEventListener('resize', ()=> hide());

  return { show, hide };
})();

/* Seed useful tips on existing controls (without editing earlier parts' markup) */
(function addCommonTips(){
  const t = [
    ['#themeToggle', 'Toggle light/dark', 'T'],
    ['#globalSearch', 'Type and press Enter to search', 'Enter'],
    ['[data-route="dashboard"]', 'Overview & KPIs', 'G D'],
    ['[data-route="rooms"]', 'Rooms floor-plan list', 'G R'],
    ['[data-route="payments"]', 'Current month invoices', 'G P'],
    ['[data-route="reports"]', 'Monthly / Yearly reports', 'G O'],
    ['#keyboardHelp', 'Keyboard cheatsheet', '?'],
  ];
  t.forEach(([sel, tip, kbd])=>{
    const el = document.querySelector(sel);
    if (el){ el.setAttribute('data-tip', tip); if (kbd) el.setAttribute('data-tip-kbd', kbd); }
  });
  // Mobile bottom bar buttons (from Part 5)
  document.querySelectorAll('.mobile-tabs [data-route]').forEach(b=>{
    if (!b.hasAttribute('data-tip')) b.setAttribute('data-tip','Open ' + b.textContent.trim());
  });
})();

/* ---------- Esc-to-clear for search inputs ----------
   Applies to: #globalSearch, #roomsFilter, #rFilter, #pFilter, #fSearch
   Works even when those fields are created after navigation. */
function attachEscClear(scope=document){
  const selectors = ['#globalSearch', '#roomsFilter', '#rFilter', '#pFilter', '#fSearch'];
  selectors.forEach(sel=>{
    const el = scope.querySelector(sel);
    if (!el || el._escBound) return;
    el._escBound = true;
    el.classList.add('esc-clears');
    el.addEventListener('keydown', e=>{
      if (e.key === 'Escape'){
        e.stopPropagation();
        el.value = '';
        el.dispatchEvent(new Event('input', { bubbles:true }));
        Toast.show('Cleared');
      }
    });
    // add a tooltip hint
    if (!el.hasAttribute('data-tip')){
      el.setAttribute('data-tip','Press Esc to clear');
      el.setAttribute('data-tip-kbd','Esc');
    }
  });
}

// Initial bind and re-bind after each navigation render.
// We patch Router.navigate once (layered on top of Part 5‚Äôs patch).
(function patchNavigateForEscClear(){
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    // Give the freshly rendered view a tick to appear, then bind
    setTimeout(()=> attachEscClear(document.getElementById('view') || document), 0);
  };
  // Bind on first load too
  attachEscClear(document);
})();

/* ---------- Bonus: quick-shortcut keys ----------
   - Press "?" anywhere to open Keyboard Shortcuts overlay
   - Press "T" to toggle theme */
(function bindQuickKeys(){
  document.addEventListener('keydown', (e)=>{
    if (e.target && ['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
    if (e.key === '?'){
      document.getElementById('keyboardHelp')?.click();
    } else if (e.key.toLowerCase() === 't'){
      document.getElementById('themeToggle')?.click();
    }
  });
})();
</script>
<!-- ==== PART 6 END ===================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 7 START =================================================== -->
<style>
  /* ---------- Print header & footer decorations ---------- */
  .print-header, .print-footer {
    position: fixed;
    left: 0; right: 0;
    color: #000;
    font-size: 12px;
    z-index: 2; /* above page content but below overlays */
    padding: 6px 12px;
  }
  .print-header { top: 0; border-bottom: 1px solid #0002; }
  .print-footer { bottom: 0; border-top: 1px solid #0002; display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .print-footer .page::after { content: "Page " counter(page) " of " counter(pages); }

  .ph-row { display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .ph-left { display:flex; gap:10px; align-items:center; }
  .ph-logo { width: 28px; height: 28px; border-radius: 7px; background: linear-gradient(135deg, #2563eb, #4f46e5); }
  .ph-title { font-weight: 800; letter-spacing: .02em; }
  .ph-muted { opacity: .75; }

  /* Ensure header/footer print on all pages */
  @media print {
    :root { --print-padding-y: 42px; }
    /* give top/bottom breathing room in the printable area */
    .print-sheet { padding-top: calc(16px + var(--print-padding-y)); padding-bottom: calc(16px + var(--print-padding-y)); }
    .print-header, .print-footer { display: block !important; }
  }

  /* ---------- Paid stamp ---------- */
  .print-stamp {
    position: absolute;
    top: 45%; left: 50%;
    transform: translate(-50%, -50%) rotate(-18deg);
    z-index: 3;
    font-weight: 900;
    font-size: 48px;
    color: rgba(220, 38, 38, 0.75); /* red-600-ish */
    border: 4px solid rgba(220, 38, 38, 0.75);
    padding: 8px 18px;
    letter-spacing: 3px;
    border-radius: 8px;
    mix-blend-mode: multiply;
    text-transform: uppercase;
    pointer-events: none;
    box-shadow: 0 0 0 2px rgba(255,255,255,0.65) inset;
  }
  .print-stamp small {
    display:block; font-size: 12px; letter-spacing: 0; text-align:right; margin-top: 4px; color: rgba(0,0,0,.7);
  }

  /* ---------- Builder mini-panel (UI-only) ---------- */
  .stamp-panel {
    margin-top: 10px; border: 1px dashed var(--border);
    border-radius: var(--radius); padding: 10px;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.02));
  }
  .stamp-grid { display:grid; gap:8px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 900px){ .stamp-grid { grid-template-columns: 1fr; } }
  .stamp-grid .field input { padding: 8px 10px; }
</style>

<script>
/* ========================= PART 7 SCRIPT ========================= */

/* The Builder view (Part 4) renders a left control card and a #printSheet on the right.
   Here we *augment* that view at navigation time: inject a small "Paid stamp" panel,
   and overlay a print header/footer + the optional stamp onto #printSheet. */

(function enhanceBuilderWithStampAndHeaders(){
  // Hook into navigation to run after Builder renders
  const origNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    origNav(route);
    if (route === 'builder') {
      // Delay one tick to ensure Part 4 has painted
      setTimeout(initEnhancementsIfNeeded, 0);
    }
  };

  function initEnhancementsIfNeeded(){
    const grid = document.querySelector('.builder-grid');
    const printSheet = document.getElementById('printSheet');
    const ctrlCard = grid ? grid.querySelector('.card') : null;

    if (!grid || !printSheet || !ctrlCard) return;

    // 1) Inject the mini "Stamp Paid" control panel once
    if (!ctrlCard.querySelector('.stamp-panel')) {
      const panel = document.createElement('div');
      panel.className = 'stamp-panel';
      panel.innerHTML = `
        <h3 style="margin:0 0 8px 0">Print Decorations</h3>
        <div class="stamp-grid">
          <div class="field">
            <label><input id="stpToggle" type="checkbox"> Show Stamp</label>
          </div>
          <div class="field">
            <label>Stamp Text</label>
            <input id="stpText" value="PAID">
          </div>
          <div class="field">
            <label>Date (small subtext)</label>
            <input id="stpDate" type="date" value="${new Date().toISOString().slice(0,10)}">
          </div>
          <div class="field">
            <label>Color (CSS)</label>
            <input id="stpColor" value="rgba(220,38,38,0.75)">
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="stpApply">Apply to Preview</button>
          <button class="btn ghost" id="stpAuto">Auto: stamp on RECEIPT</button>
        </div>
      `;
      ctrlCard.appendChild(panel);

      // Wire panel actions
      panel.querySelector('#stpApply').addEventListener('click', ()=>{
        decoratePrintArea();
        Toast.show('Applied to preview');
      });
      panel.querySelector('#stpAuto').addEventListener('click', ()=>{
        const isReceipt = (document.getElementById('bdType')?.value || '').toUpperCase() === 'RECEIPT';
        panel.querySelector('#stpToggle').checked = isReceipt;
        if (isReceipt && !panel.querySelector('#stpText').value.trim()) {
          panel.querySelector('#stpText').value = 'PAID';
        }
        decoratePrintArea();
      });

      // Auto-apply when key builder fields change
      ['bdType','bdNo','bdDate','bdRoom','bdRenter','bdAddr','bdBank','bdRemark','bdLate','bdDepReturn','bdMoveOut']
        .forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.addEventListener('input', ()=>decoratePrintArea());
        });

      // Observe the print sheet for changes from Part 4's paintPrint()
      const mo = new MutationObserver(()=>decoratePrintArea());
      mo.observe(printSheet, { childList: true, subtree: true });
    }

    // 2) Ensure header/footer & stamp reflect current state now
    decoratePrintArea();
  }

  /* Pull builder values and refresh header/footer + stamp on #printSheet */
  function decoratePrintArea(){
    const printSheet = document.getElementById('printSheet');
    if (!printSheet) return;

    // Remove any previous adornments
    printSheet.querySelectorAll('.print-header,.print-footer,.print-stamp').forEach(n=>n.remove());

    // Gather dynamic pieces from Builder controls (Part 4)
    const v = {
      type: (document.getElementById('bdType')?.value || 'INVOICE').toUpperCase(),
      no: document.getElementById('bdNo')?.value || '',
      date: document.getElementById('bdDate')?.value || '',
      room: (()=> {
        const rid = document.getElementById('bdRoom')?.value;
        const room = Store.rooms.find(r=>r.id===rid);
        return room?.roomNo || '';
      })(),
      addr: (()=> {
        const aid = document.getElementById('bdAddr')?.value;
        const a = Store.addresses.find(x=>x.id===aid);
        return a ? `${a.name} ‚Äî ${a.addr}` : '';
      })(),
    };

    // Header
    const header = document.createElement('div');
    header.className = 'print-header';
    header.innerHTML = `
      <div class="ph-row">
        <div class="ph-left">
          <div class="ph-logo" aria-hidden="true"></div>
          <div>
            <div class="ph-title">Apartment Admin</div>
            <div class="ph-muted">${v.addr}</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800">${v.type}</div>
          <div>Doc No: <strong>${v.no}</strong></div>
          <div>Date: <strong>${v.date}</strong> ¬∑ Room: <strong>${v.room}</strong></div>
        </div>
      </div>
    `;
    printSheet.appendChild(header);

    // Footer with page number counters
    const footer = document.createElement('div');
    footer.className = 'print-footer';
    footer.innerHTML = `
      <div>Generated by Apartment Admin (UI-only)</div>
      <div class="page"></div>
    `;
    printSheet.appendChild(footer);

    // Optional stamp
    const p = {
      on: !!document.getElementById('stpToggle')?.checked,
      text: document.getElementById('stpText')?.value?.trim() || 'PAID',
      date: document.getElementById('stpDate')?.value || '',
      color: document.getElementById('stpColor')?.value?.trim() || 'rgba(220,38,38,0.75)'
    };
    if (p.on){
      const stamp = document.createElement('div');
      stamp.className = 'print-stamp';
      stamp.style.color = p.color;
      stamp.style.borderColor = p.color;
      stamp.innerHTML = `${escapeHTML(p.text)}${p.date ? `<small>${escapeHTML(p.date)}</small>`:''}`;
      printSheet.style.position = 'relative'; // ensure absolute stamp anchors properly
      printSheet.appendChild(stamp);
    }
  }

  function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
})();
</script>
<!-- ==== PART 7 END ===================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 8 START =================================================== -->
<style>
  /* Tiny helper bar added to Builder controls */
  .kbd-hints {
    margin: 8px 0 0 0;
    display:flex; gap:6px; flex-wrap:wrap; align-items:center;
    font-size:12px; color: var(--muted);
  }
  .kbd {
    padding:2px 6px; border:1px solid var(--border); border-radius:6px;
    background: var(--panel); color: var(--text);
  }

  /* Payments toolbar add-on button */
  .btn.inline {
    padding: 8px 10px; border-radius: 10px; font-size: 13px;
  }
</style>

<script>
/* ========================= PART 8 SCRIPT ========================= */

/* ---------- Utility: find Builder elements safely ---------- */
function $B(id){ return document.getElementById(id); }

/* ---------- Enhance Builder with keyboard nav & hints ---------- */
(function enhanceBuilderKeys(){
  // Hook navigation to run after Builder renders (stack with prior patches)
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    if (route === 'builder'){
      // Wait a tick for Part 4 to paint
      setTimeout(initBuilderKeysOnce, 0);
    }
    if (route === 'payments'){
      setTimeout(injectDuplicateButtonOnce, 0);
    }
  };

  let builderWired = false;
  function initBuilderKeysOnce(){
    const grid = document.querySelector('.builder-grid');
    const printSheet = $B('printSheet');
    const ctrlCard = grid ? grid.querySelector('.card') : null;
    if (!grid || !printSheet || !ctrlCard) return;

    // Add a tiny hint strip once
    if (!ctrlCard.querySelector('.kbd-hints')){
      const hints = document.createElement('div');
      hints.className = 'kbd-hints';
      hints.innerHTML = `
        <span>Shortcuts:</span>
        <span class="kbd">Alt+1</span> Doc
        <span class="kbd">Alt+2</span> Parties
        <span class="kbd">Alt+3</span> Lines
        <span class="kbd">Alt+4</span> Fees
        <span class="kbd">Alt+5</span> Totals
        <span class="kbd">Alt+A</span> Add Line
        <span class="kbd">Alt+P</span> Print
        <span class="kbd">Alt+S</span> Save
        <span class="kbd">Enter</span> add on last price
        <span class="kbd">Ctrl+Del</span> delete line
      `;
      ctrlCard.appendChild(hints);
    }

    if (builderWired) return;
    builderWired = true;

    // Keyboard handler (scoped to builder route)
    document.addEventListener('keydown', onBuilderKeys, true);

    // Line-items smart behavior
    const itemsHost = document.querySelector('#itemsHost');
    if (itemsHost){
      // Enter on last price ‚Üí add new line
      itemsHost.addEventListener('keydown', (e)=>{
        const row = e.target.closest('[data-idx]');
        if (!row) return;
        const isPrice = e.target.matches('input[data-k="price"]');
        const idx = Number(row.getAttribute('data-idx'));
        const rows = Array.from(itemsHost.querySelectorAll('[data-idx]'));
        const isLastRow = rows.length && Number(rows[rows.length-1].getAttribute('data-idx')) === idx;

        if (isPrice && isLastRow && e.key === 'Enter'){
          e.preventDefault();
          // Click "Add Item" (Part 4) then focus new name field
          const addBtn = document.querySelector('#addItem');
          addBtn?.click();
          // next microtask: focus the new name field
          setTimeout(()=>{
            const newRows = itemsHost.querySelectorAll('[data-idx]');
            const last = newRows[newRows.length-1];
            last?.querySelector('input[data-k="name"]')?.focus();
          }, 0);
        }

        // Ctrl+Del deletes current row
        if (e.key === 'Delete' && (e.ctrlKey || e.metaKey)){
          e.preventDefault();
          const delBtn = row.querySelector('[data-del]');
          delBtn?.click();
          Toast.show('Line deleted');
        }
      });
    }
  }

  function onBuilderKeys(e){
    // Only when Builder is active and not typing in a multi-line area
    if (Router.current !== 'builder') return;
    const tag = (e.target && e.target.tagName) || '';
    const isTyping = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

    // Alt-based global Builder commands should still work while typing
    const alt = e.altKey;

    // Focus helpers
    function f(el){ if (el){ el.focus(); el.select?.(); } }

    // Sections mapping
    const S = {
      doc: ()=> f($B('bdNo') || $B('bdType')),
      parties: ()=> f($B('bdRoom') || $B('bdRenter') || $B('bdAddr') || $B('bdBank')),
      lines: ()=> {
        const firstName = document.querySelector('#itemsHost input[data-k="name"]');
        f(firstName || $B('addItem'));
      },
      fees: ()=> f($B('bdLate') || $B('bdDepReturn')),
      totals: ()=> {
        const totalEl = document.querySelector('#bdTotal');
        // focus something near totals; fallback to preview button
        f($B('bdPreview') || $B('bdSave'));
        if (totalEl) Toast.show('Totals: ' + totalEl.textContent.replace(/\s+/g,' ').trim());
      }
    };

    // Alt-number shortcuts
    if (alt && !e.shiftKey){
      if (e.key === '1'){ e.preventDefault(); S.doc(); return; }
      if (e.key === '2'){ e.preventDefault(); S.parties(); return; }
      if (e.key === '3'){ e.preventDefault(); S.lines(); return; }
      if (e.key === '4'){ e.preventDefault(); S.fees(); return; }
      if (e.key === '5'){ e.preventDefault(); S.totals(); return; }
      if (e.key.toLowerCase() === 'a'){ e.preventDefault(); $B('addItem')?.click(); return; }
      if (e.key.toLowerCase() === 'p'){ e.preventDefault(); $B('bdPreview')?.click(); return; }
      if (e.key.toLowerCase() === 's'){ e.preventDefault(); $B('bdSave')?.click(); return; }
    }

    // When not using Alt commands, bail if the user is typing in a text field
    if (isTyping) return;
  }

  /* ---------- Payments: inject "Duplicate Last Invoice" ---------- */
  let dupInjected = false;
  function injectDuplicateButtonOnce(){
    const host = document.getElementById('view');
    if (!host) return;
    const card = host.querySelector('.card'); // the top toolbar card
    if (!card) return;
    if (dupInjected && card.querySelector('#dupLastInv')) return;

    const bar = card.querySelector('.report-toolbar') ||
                card.querySelector('div[style*="justify-content:space-between"]') ||
                card;

    const btn = document.createElement('button');
    btn.className = 'btn inline';
    btn.id = 'dupLastInv';
    btn.textContent = 'Duplicate Last Invoice';
    btn.setAttribute('data-tip','Clone most recent invoice for quick testing');
    btn.setAttribute('data-tip-kbd','Alt+D');

    // Put it to the right end
    if (bar) bar.appendChild(btn);

    btn.addEventListener('click', ()=> duplicateLastInvoice());
    // Also bind Alt+D on Payments route
    document.addEventListener('keydown', (e)=>{
      if (Router.current!=='payments') return;
      if (e.altKey && e.key.toLowerCase()==='d'){
        e.preventDefault();
        duplicateLastInvoice();
      }
    });

    dupInjected = true;
  }

  function duplicateLastInvoice(){
    if (!Store.invoices.length){
      Toast.show('No invoices to duplicate');
      return;
    }
    const last = Store.invoices[Store.invoices.length-1];
    const copy = JSON.parse(JSON.stringify(last));
    copy.id = 'inv'+(Store.invoices.length+1);
    // keep same room/renter/month; set status back to draft; tweak remark if exists
    copy.status = 'draft';
    if (copy.settings){ copy.settings.remark = (copy.settings.remark || '') + ' (copy)'; }
    Store.invoices.push(copy);
    Toast.show(`Duplicated ${last.id} ‚Üí ${copy.id}`);
    // If we are on Payments, re-render quickly by navigating to same route
    if (Router.current==='payments'){
      const r = Router.current;
      // force refresh via navigate (skeleton shim will kick in)
      Router.navigate(r);
    }
  }

})();
</script>
<!-- ==== PART 8 END ===================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 9 START =================================================== -->
<style>
  .import-card .hint { color: var(--muted); font-size: 12px; }
  .import-grid { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 1100px){ .import-grid { grid-template-columns: 1fr; } }
  .csv-area {
    width:100%; height:180px; padding:10px 12px;
    border:1px dashed var(--border); border-radius: var(--radius);
    background: var(--panel); color: var(--text); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  .mini-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .mini-table th, .mini-table td { border-bottom: 1px solid var(--border); padding: 6px 8px; text-align: left; font-size: 13px; }
  .mini-table thead th { position: sticky; top: 0; background: var(--panel); z-index: 1; }
  .pill.bad { color: #991b1b; background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.25); }
</style>

<script>
/* ========================= PART 9 SCRIPT ========================= */

/* We *extend* the Settings view by injecting an Import/Export card at the bottom.
   This avoids changing earlier part code. */
(function augmentSettingsWithImporter(){
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    if (route === 'settings'){
      setTimeout(injectImporterCard, 0);
    }
  };

  function injectImporterCard(){
    const view = document.getElementById('view');
    if (!view) return;
    // Find the last .settings-grid (from Part 4)
    const grid = view.querySelector('.settings-grid');
    if (!grid || grid.querySelector('.import-card')) return; // already added

    const card = document.createElement('div');
    card.className = 'card import-card';
    card.innerHTML = `
      <h3 style="margin:0 0 6px 0">Import / Export Mock Data</h3>
      <div class="hint">Paste CSV below, preview, then import into in-memory Store (UI-only). No files are uploaded.</div>

      <div class="import-grid" style="margin-top:10px">
        <!-- LEFT: Import -->
        <section>
          <div class="form-row" style="margin-bottom:8px">
            <div class="field">
              <label>Data Type</label>
              <select id="imType">
                <option value="rooms">Rooms</option>
                <option value="renters">Renters</option>
                <option value="invoices">Invoices</option>
              </select>
            </div>
            <div class="field">
              <label>Mode</label>
              <select id="imMode">
                <option value="append">Append</option>
                <option value="replace">Replace</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>CSV Input</label>
            <textarea id="imCSV" class="csv-area" placeholder="Paste CSV here‚Ä¶"></textarea>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="btn" id="imTpl">Insert Template</button>
            <button class="btn" id="imPreview">Preview</button>
            <button class="btn" id="imImport">Import</button>
            <button class="btn ghost" id="imClear">Clear</button>
          </div>
        </section>

        <!-- RIGHT: Preview & Export -->
        <section>
          <div class="field">
            <label>Preview</label>
            <div id="imPreviewHost" style="min-height:80px;border:1px solid var(--border);border-radius:var(--radius);padding:8px"></div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="btn" id="exRooms">Export Rooms CSV</button>
            <button class="btn" id="exRenters">Export Renters CSV</button>
            <button class="btn" id="exInvoices">Export Invoices CSV</button>
          </div>
        </section>
      </div>
    `;
    grid.appendChild(card);

    // Wire up
    const els = {
      type: card.querySelector('#imType'),
      mode: card.querySelector('#imMode'),
      csv: card.querySelector('#imCSV'),
      previewBtn: card.querySelector('#imPreview'),
      importBtn: card.querySelector('#imImport'),
      clearBtn: card.querySelector('#imClear'),
      tplBtn: card.querySelector('#imTpl'),
      host: card.querySelector('#imPreviewHost'),

      exRooms: card.querySelector('#exRooms'),
      exRenters: card.querySelector('#exRenters'),
      exInvoices: card.querySelector('#exInvoices'),
    };

    // Template CSVs
    const templates = {
      rooms:
`roomNo,rate,status,payMethodId,renterName,renterPhone
201,4500,occupied,b1,‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ,081-234-5678
202,4000,vacant,b2,,
203,4500,unpaid,b1,‡∏®‡∏¥‡∏£‡∏¥‡∏û‡∏£ ‡πÉ‡∏à‡∏î‡∏µ,089-111-2222`,
      renters:
`name,phone,address,roomNo,balance
‡∏õ‡∏ß‡∏µ‡∏ì‡∏≤ ‡πÉ‡∏à‡∏î‡∏µ,082-555-0000,‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ,204,0
‡∏™‡∏∏‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÉ‡∏à‡∏î‡∏µ,083-222-3333,‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ,205,500`,
      invoices:
`roomNo,yyyymm,total,status,method
201,2025-10,4700,paid,Bank Transfer
205,2025-10,5000,sent,Cash`
    };

    els.tplBtn.addEventListener('click', ()=>{
      const t = els.type.value;
      els.csv.value = templates[t] || '';
      Toast.show('Template inserted');
    });
    els.clearBtn.addEventListener('click', ()=>{ els.csv.value=''; els.host.innerHTML=''; });

    // CSV parsing (tiny, tolerant)
    function parseCSV(text){
      // split into lines; handle quoted commas "a,b"
      const lines = text.trim().split(/\r?\n/).filter(l=>l.trim().length>0);
      if (!lines.length) return { headers: [], rows: [] };
      const headers = splitCSVLine(lines[0]);
      const rows = lines.slice(1).map(line=>{
        const cells = splitCSVLine(line);
        const obj = {};
        headers.forEach((h,i)=> obj[h.trim()] = (cells[i]??'').trim());
        return obj;
      });
      return { headers, rows };
    }
    function splitCSVLine(line){
      const out = []; let cur = ''; let inQ = false;
      for (let i=0;i<line.length;i++){
        const c = line[i];
        if (c === '"'){
          if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
        } else if (c === ',' && !inQ){
          out.push(cur); cur = '';
        } else {
          cur += c;
        }
      }
      out.push(cur);
      return out;
    }

    // Preview renderer with basic validation
    let lastParsed = null;
    els.previewBtn.addEventListener('click', ()=>{
      const txt = els.csv.value.trim();
      if (!txt) { Toast.show('No CSV'); return; }
      const parsed = parseCSV(txt);
      lastParsed = parsed;

      // Build preview table
      const bads = [];
      const t = els.type.value;
      const reqCols = {
        rooms: ['roomNo','rate'],
        renters: ['name','roomNo'],
        invoices: ['roomNo','yyyymm','total']
      }[t];
      reqCols.forEach(col=>{
        if (!parsed.headers.includes(col)) bads.push(col);
      });

      const head = `<thead><tr>${parsed.headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>`;
      const body = `<tbody>${
        parsed.rows.map(r=>`<tr>${parsed.headers.map(h=>`<td>${escapeHTML(r[h]??'')}</td>`).join('')}</tr>`).join('')
      }</tbody>`;
      els.host.innerHTML = `
        ${bads.length? `<div class="pill bad" style="margin-bottom:6px">Missing columns: ${bads.join(', ')}</div>`:''}
        <div style="max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table class="mini-table">${head}${body}</table>
        </div>
        <div class="hint" style="margin-top:6px">${parsed.rows.length} row(s) ready.</div>
      `;
    });

    // Import logic
    els.importBtn.addEventListener('click', ()=>{
      if (!lastParsed || !lastParsed.rows.length){ Toast.show('Preview first'); return; }
      const type = els.type.value;
      const mode = els.mode.value;

      if (type === 'rooms'){
        if (mode==='replace') Store.rooms.splice(0, Store.rooms.length);
        lastParsed.rows.forEach(r=>{
          // Find or create room by roomNo
          let room = Store.rooms.find(x=>x.roomNo === r.roomNo);
          if (!room){
            room = { id: String(r.roomNo), roomNo: r.roomNo, status:'vacant', rate: Number(r.rate||Store.defaults.roomRate), renterId:null, payMethodId: r.payMethodId || (Store.bankAccounts[0]?.id) };
            Store.rooms.push(room);
          } else {
            room.rate = Number(r.rate || room.rate);
            room.payMethodId = r.payMethodId || room.payMethodId;
            if (r.status) room.status = r.status;
          }
          // Optional renter inline
          const hasRenter = (r.renterName||'').trim().length>0;
          if (hasRenter){
            // create renter bound to this room
            const renter = {
              id: 'r'+(Store.renters.length+1),
              name: r.renterName,
              phone: r.renterPhone || '',
              address: r.renterAddress || '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ',
              roomId: room.id,
              balance: 0,
              contract: { start:'2025-01-01', end:'2025-12-31', depositPaidOn:'2025-01-01', depositSlip:null }
            };
            Store.renters.push(renter);
            room.renterId = renter.id;
            room.status = r.status || 'occupied';
          }
        });
      }

      if (type === 'renters'){
        if (mode==='replace') Store.renters.splice(0, Store.renters.length);
        lastParsed.rows.forEach(r=>{
          // match room
          const room = Store.rooms.find(x=>x.roomNo === r.roomNo);
          const rid = 'r'+(Store.renters.length+1);
          Store.renters.push({
            id: rid,
            name: r.name,
            phone: r.phone || '',
            address: r.address || '‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ',
            roomId: room ? room.id : null,
            balance: Number(r.balance||0),
            contract: { start:'2025-01-01', end:'2025-12-31', depositPaidOn:'2025-01-01', depositSlip:null }
          });
          if (room){ room.renterId = rid; room.status = (Number(r.balance||0) > 0) ? 'unpaid' : 'occupied'; }
        });
      }

      if (type === 'invoices'){
        if (mode==='replace') Store.invoices.splice(0, Store.invoices.length);
        lastParsed.rows.forEach(r=>{
          const room = Store.rooms.find(x=>x.roomNo === r.roomNo);
          const renter = room ? Store.renters.find(z=>z.roomId===room.id) : null;
          Store.invoices.push({
            id: 'inv'+(Store.invoices.length+1),
            roomId: room?.id || null,
            renterId: renter?.id || null,
            yyyymm: r.yyyymm || monthKey(),
            total: Number(r.total||0),
            status: r.status || 'draft',
            method: r.method || 'Bank Transfer',
            slip: null,
            settings: { addressId: Store.addresses[0]?.id || null, remark: (r.remark||'') }
          });
        });
      }

      Toast.show('Imported to mock Store');
      // Optional: re-paint current route if it depends on these
      if (['rooms','renters','payments','reports'].includes(Router.current)){
        const r = Router.current;
        Router.navigate(r);
      }
    });

    // Exporters
    els.exRooms.addEventListener('click', ()=> downloadCSV('rooms.csv', toCSVRooms(Store.rooms)));
    els.exRenters.addEventListener('click', ()=> downloadCSV('renters.csv', toCSVRenters(Store.renters)));
    els.exInvoices.addEventListener('click', ()=> downloadCSV('invoices.csv', toCSVInvoices(Store.invoices)));

    // Utility: CSV builders
    function toCSVRooms(rooms){
      const head = ['roomNo','rate','status','payMethodId','renterName','renterPhone'];
      const rows = rooms.map(r=>{
        const renter = Store.renters.find(x=>x.id===r.renterId);
        return [r.roomNo, r.rate, r.status, r.payMethodId||'', renter?.name||'', renter?.phone||''];
      });
      return toCSV([head, ...rows]);
    }
    function toCSVRenters(renters){
      const head = ['name','phone','address','roomNo','balance'];
      const rows = renters.map(r=>{
        const roomNo = Store.rooms.find(x=>x.id===r.roomId)?.roomNo || '';
        return [r.name, r.phone, r.address, roomNo, r.balance];
      });
      return toCSV([head, ...rows]);
    }
    function toCSVInvoices(invoices){
      const head = ['roomNo','yyyymm','total','status','method','remark'];
      const rows = invoices.map(i=>{
        const roomNo = Store.rooms.find(x=>x.id===i.roomId)?.roomNo || '';
        return [roomNo, i.yyyymm, i.total, i.status, i.method, i.settings?.remark||''];
      });
      return toCSV([head, ...rows]);
    }
    function toCSV(rows){
      return rows.map(r=>r.map(v=>{
        const s = String(v ?? '');
        return (s.includes(',') || s.includes('"') || /\r|\n/.test(s)) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');
    }
    function downloadCSV(filename, csv){
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // Quality-of-life: Esc-to-clear applies from Part 6, but also bind Ctrl+Enter to preview/import
    els.csv.addEventListener('keydown', (e)=>{
      if (e.key==='Enter' && (e.ctrlKey || e.metaKey)){
        e.preventDefault();
        if (!lastParsed) els.previewBtn.click();
        else els.importBtn.click();
      }
    });
  }
})();
</script>
<!-- ==== PART 9 END ===================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 10 START ================================================== -->
<style>
  .btn.bad { border-color: rgba(239,68,68,.35); color: #991b1b; }
  .btn.good { border-color: rgba(16,185,129,.35); color: #065f46; }
  .about-grid { display:grid; gap:8px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 780px){ .about-grid { grid-template-columns: 1fr; } }
  .kv { display:flex; justify-content:space-between; gap:12px; }
  .kv b { font-weight:700 }
</style>

<script>
/* ========================= PART 10 SCRIPT ========================= */

/* ---------- 0) Theme aria-pressed fix on load ---------- */
(function syncThemeToggleAria(){
  const root = document.documentElement;
  const saved = localStorage.getItem('theme') || root.getAttribute('data-theme') || 'light';
  root.setAttribute('data-theme', saved);
  const pressed = (saved === 'dark');
  const tgl = document.getElementById('themeToggle');
  if (tgl) tgl.setAttribute('aria-pressed', String(pressed));
})();

/* ---------- 1) About modal (inline; no markup edits required) ---------- */
(function injectAboutButton(){
  const footer = document.querySelector('.sidebar-footer');
  if (!footer || document.getElementById('aboutBtn')) return;
  const btn = document.createElement('button');
  btn.id = 'aboutBtn';
  btn.className = 'btn ghost';
  btn.textContent = '‚ÑπÔ∏è About';
  btn.setAttribute('data-tip','App info & shortcuts');
  footer.insertBefore(btn, footer.firstChild);

  btn.addEventListener('click', ()=>{
    const node = document.createElement('div');
    node.innerHTML = `
      <div class="about-grid">
        <section class="card" style="padding:10px">
          <h3 style="margin:0 0 6px 0">Apartment Admin (UI-Only)</h3>
          <div class="kv"><span>Version</span><b>v1.0 (Parts 1‚Äì10)</b></div>
          <div class="kv"><span>Persistence</span><b>Session only (optional localStorage)</b></div>
          <div class="kv"><span>Theme</span><b>${document.documentElement.getAttribute('data-theme')}</b></div>
          <div class="kv"><span>Rooms</span><b>${Store.rooms.length}</b></div>
          <div class="kv"><span>Renters</span><b>${Store.renters.length}</b></div>
          <div class="kv"><span>Invoices</span><b>${Store.invoices.length}</b></div>
        </section>
        <section class="card" style="padding:10px">
          <h3 style="margin:0 0 6px 0">Keyboard Cheats</h3>
          <ul style="margin:0 0 6px 18px; line-height:1.5">
            <li>Esc ‚Äî close overlay / clear search (Parts 1 & 6)</li>
            <li>Ctrl/‚åò + K ‚Äî Command palette (Part 5)</li>
            <li>T ‚Äî Toggle theme (Part 6)</li>
            <li>Alt+1..5 ‚Äî Builder sections (Part 8)</li>
            <li>Alt+A / Alt+P / Alt+S ‚Äî Builder add / print / save (Part 8)</li>
          </ul>
          <div class="kv"><span>Print</span><b>Header, footer, watermark, paid-stamp</b></div>
        </section>
      </div>
      <div style="margin-top:8px" class="subtle">UI is mock-only. Integration points marked with <code>// TODO</code> for Google Sheets / storage.</div>
    `;
    openOverlay('About', node);
  });
})();

/* ---------- 2) Safe deletes (confirm before destructive actions) ---------- */
(function guardDeletes(){
  document.addEventListener('click', (e)=>{
    const dangerBtn = e.target.closest('[data-del],[data-delb],[data-dela]');
    if (!dangerBtn) return;
    const label = dangerBtn.hasAttribute('data-delb') ? 'bank account'
                 : dangerBtn.hasAttribute('data-dela') ? 'address'
                 : 'item';
    const ok = confirm(`Delete this ${label}? This cannot be undone (mock).`);
    if (!ok){
      e.preventDefault();
      e.stopPropagation();
    }
  }, true); // capture to intercept before original handlers
})();

/* ---------- 3) Session Save / Load / Clear (localStorage) ---------- */
(function addSessionTools(){
  const footer = document.querySelector('.sidebar-footer');
  if (!footer || document.getElementById('sessionBtn')) return;

  const btn = document.createElement('button');
  btn.id = 'sessionBtn';
  btn.className = 'btn';
  btn.textContent = 'üíæ Session';
  btn.setAttribute('data-tip','Save/Load mock data for this browser');
  footer.appendChild(btn);

  btn.addEventListener('click', ()=>{
    const node = document.createElement('div');
    const size = (str)=> (str ? (new Blob([str]).size) : 0);
    const ss = localStorage.getItem('aptAdminStore');
    node.innerHTML = `
      <p>Save the current in-memory Store to your browser or load it back. No network, no external storage.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn good" id="sesSave">Save to Browser</button>
        <button class="btn" id="sesLoad" ${ss?'':'disabled'}>Load from Browser ${ss?`(${(size(ss)/1024).toFixed(1)} KB)`:''}</button>
        <button class="btn bad" id="sesClear" ${ss?'':'disabled'}>Clear Saved</button>
      </div>
      <div class="card" style="padding:8px;margin-top:10px">
        <strong>What‚Äôs saved?</strong>
        <ul style="margin:6px 0 0 18px; line-height:1.5">
          <li>Rooms, Renters, Invoices, Files (base64), Accounts, Addresses, Settings</li>
          <li>Not saved: functions, event handlers, ephemeral UI state</li>
        </ul>
      </div>
    `;
    openOverlay('Session Tools', node);

    node.querySelector('#sesSave').addEventListener('click', ()=>{
      try {
        const snapshot = structuredCloneSafe(Store);
        localStorage.setItem('aptAdminStore', JSON.stringify(snapshot));
        Toast.show('Saved to browser');
        closeOverlay();
      } catch (err) {
        Toast.show('Save failed');
        console.error(err);
      }
    });
    node.querySelector('#sesLoad').addEventListener('click', ()=>{
      try {
        const raw = localStorage.getItem('aptAdminStore');
        if (!raw) return;
        const obj = JSON.parse(raw);
        // shallow merge known keys
        const keys = ['rooms','renters','invoices','bankAccounts','addresses','utilities','defaults','files','terms','dueDays'];
        keys.forEach(k=>{ if (k in obj) Store[k] = obj[k]; });
        Store._seeded = true;
        Toast.show('Loaded from browser');
        // Re-render current route to reflect
        const r = Router.current;
        Router.navigate(r);
        closeOverlay();
      } catch (err) {
        Toast.show('Load failed');
        console.error(err);
      }
    });
    node.querySelector('#sesClear').addEventListener('click', ()=>{
      const ok = confirm('Clear saved session in this browser?');
      if (!ok) return;
      localStorage.removeItem('aptAdminStore');
      Toast.show('Cleared');
      closeOverlay();
    });
  });

  // Safe structural clone (drop functions & circular refs)
  function structuredCloneSafe(src){
    const seen = new WeakSet();
    return JSON.parse(JSON.stringify(src, (k,v)=>{
      if (typeof v === 'function') return undefined;
      if (typeof v === 'object' && v !== null){
        if (seen.has(v)) return undefined;
        seen.add(v);
      }
      return v;
    }));
  }
})();

/* ---------- 4) Mini validation helpers (gentle warnings) ---------- */
(function softValidation(){
  // Warn on obviously odd numbers (negative totals/rates)
  document.addEventListener('change', (e)=>{
    const el = e.target;
    if (!(el instanceof HTMLInputElement)) return;
    if (el.type === 'number'){
      const val = Number(el.value);
      if (isNaN(val)) return;
      if (val < 0){
        el.style.outline = '2px solid rgba(239,68,68,.6)';
        Toast.show('Value should not be negative');
      } else {
        el.style.outline = '';
      }
    }
  });

  // Builder: prevent printing if total is NaN (rare but possible)
  document.addEventListener('click', (e)=>{
    const printBtn = e.target.closest('#bdPreview');
    if (!printBtn) return;
    const totalEl = document.getElementById('bdTotal');
    if (!totalEl) return;
    const num = Number(totalEl.textContent.replace(/[^\d.]/g,''));
    if (!isFinite(num)){
      e.preventDefault();
      Toast.show('Fix invalid numbers before printing');
    }
  });
})();

/* ---------- 5) Tiny quality-of-life tweaks ---------- */
(function qolTweaks(){
  // When switching theme, announce via toast for a11y ‚Äúlive region‚Äù feedback
  const tgl = document.getElementById('themeToggle');
  if (tgl){
    tgl.addEventListener('click', ()=>{
      const current = document.documentElement.getAttribute('data-theme');
      Toast.show(`Theme: ${current}`);
    });
  }

  // When overlay opens, trap initial focus to Close button if no focusable element inside body
  const overlay = document.getElementById('overlay');
  if (overlay){
    const sheet = overlay.querySelector('.sheet');
    overlay.addEventListener('transitionend', ()=>{
      if (!overlay.classList.contains('open')) return;
      const focusables = sheet.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      if (!focusables.length) document.getElementById('sheetClose').focus();
    });
  }
})();
</script>
<!-- ==== PART 10 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 11 START ================================================== -->
<style>
  .loc-panel {
    margin-top: 10px; border: 1px dashed var(--border);
    border-radius: var(--radius); padding: 10px;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.02));
  }
  .loc-grid { display:grid; gap:8px; grid-template-columns: 1fr 1fr 1fr; }
  @media (max-width: 900px){ .loc-grid { grid-template-columns: 1fr; } }
  .conv-note { font-size:12px; color: var(--muted); }
  .conv-chip { display:inline-block; padding: 2px 8px; border:1px solid var(--border); border-radius:999px; margin-left:6px; }
</style>

<script>
/* ========================= PART 11 SCRIPT ========================= */

/* This augments the Builder view (Part 4):
   - Adds a "Localization & Currency" panel with:
       ‚úì Thai labels (print) toggle
       ‚úì Currency preview: select target, set rate (per THB), show converted total
   - Rewrites #printSheet labels to Thai when enabled (non-destructive DOM rewrite)
*/

(function augmentBuilderLocalization(){
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    if (route === 'builder'){
      setTimeout(initLocalizationPanelOnce, 0);
    }
  };

  let wired = false;

  function initLocalizationPanelOnce(){
    const grid = document.querySelector('.builder-grid');
    const printSheet = document.getElementById('printSheet');
    const ctrlCard = grid ? grid.querySelector('.card') : null;
    if (!grid || !printSheet || !ctrlCard) return;

    if (!ctrlCard.querySelector('.loc-panel')){
      const wrap = document.createElement('div');
      wrap.className = 'loc-panel';
      wrap.innerHTML = `
        <h3 style="margin:0 0 8px 0">Localization & Currency</h3>
        <div class="loc-grid">
          <div class="field">
            <label><input id="thToggle" type="checkbox"> Thai labels in print (‡∏ó‡∏î‡∏•‡∏≠‡∏á)</label>
          </div>
          <div class="field">
            <label>Convert Total To</label>
            <select id="fxCode">
              <option value="">‚Äî Off ‚Äî</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="JPY">JPY</option>
              <option value="SGD">SGD</option>
              <option value="MYR">MYR</option>
              <option value="IDR">IDR</option>
            </select>
          </div>
          <div class="field">
            <label>Rate (per 1 THB)</label>
            <input id="fxRate" type="number" step="0.000001" placeholder="e.g. 0.027 for USD">
          </div>
        </div>
        <div style="margin-top:6px">
          <span class="conv-note">Preview only. You set the rate. No live FX.</span>
          <span class="conv-chip" id="fxOut" aria-live="polite" style="display:none"></span>
        </div>
      `;
      ctrlCard.appendChild(wrap);

      // Restore last used settings (session memory)
      const saved = JSON.parse(localStorage.getItem('aptAdminLoc')||'{}');
      if (saved.th) wrap.querySelector('#thToggle').checked = true;
      if (saved.code) wrap.querySelector('#fxCode').value = saved.code;
      if (typeof saved.rate === 'number') wrap.querySelector('#fxRate').value = saved.rate;

      // Wire recalculations
      wrap.addEventListener('input', ()=>{
        persistLocPrefs();
        applyThaiLabelsIfNeeded();
        paintConversion();
      });

      // Observe print sheet changes (from Part 4 & 7)
      const mo = new MutationObserver(()=>{
        applyThaiLabelsIfNeeded();
        paintConversion();
      });
      mo.observe(printSheet, { childList: true, subtree: true });

      // First paint
      applyThaiLabelsIfNeeded();
      paintConversion();
    }

    if (wired) return;
    wired = true;

    function persistLocPrefs(){
      const th = document.getElementById('thToggle')?.checked || false;
      const code = document.getElementById('fxCode')?.value || '';
      const rate = Number(document.getElementById('fxRate')?.value || NaN);
      localStorage.setItem('aptAdminLoc', JSON.stringify({ th, code, rate: isFinite(rate)? rate : undefined }));
    }

    /* Replace common English labels in the Builder print DOM with Thai equivalents.
       We only rewrite known label text; document data (names, numbers) remain intact. */
    function applyThaiLabelsIfNeeded(){
      const on = document.getElementById('thToggle')?.checked;
      const ps = document.getElementById('printSheet');
      if (!ps) return;
      // Remove any prior Thai markers
      ps.querySelectorAll('[data-th-rewritten]').forEach(n=>{
        // If the node still matches Thai, keep it; otherwise, drop the marker
        n.removeAttribute('data-th-rewritten');
      });
      if (!on) return; // nothing to do

      // Map: English ‚Üí Thai
      const M = {
        'INVOICE':'‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ',
        'RECEIPT':'‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
        'Doc No:':'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:',
        'Date:':'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:',
        'Room:':'‡∏´‡πâ‡∏≠‡∏á:',
        'Bill To:':'‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ:',
        'Payment Method:':'‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:',
        'Description':'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
        'Qty':'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
        'Unit':'‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢',
        'Amount':'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
        'Subtotal':'‡∏£‡∏ß‡∏°',
        'Late Fee':'‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤',
        'Deposit Return':'‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô',
        'Total':'‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°',
        'Generated by Apartment Admin (UI-only)':'‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ Apartment Admin (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ UI)',
      };

      // Helper: replace exact text content of certain cells/headings
      function rewriteExact(selector, english, thai){
        ps.querySelectorAll(selector).forEach(el=>{
          if (el.textContent.trim() === english){
            el.textContent = thai;
            el.setAttribute('data-th-rewritten','1');
          }
        });
      }

      // Headline: INVOICE / RECEIPT (found in .doc-title)
      rewriteExact('.doc-title', 'INVOICE', M['INVOICE']);
      rewriteExact('.doc-title', 'RECEIPT', M['RECEIPT']);

      // Meta labels in header block
      // These are structured like "Doc No: <strong>‚Ä¶</strong>", so we need to rewrite only the label part.
      ps.querySelectorAll('.print-head div[style*="text-align:right"] > div').forEach(div=>{
        const t = div.firstChild && div.firstChild.nodeType === 3 ? div.firstChild.nodeValue.trim() : '';
        if (t.startsWith('Doc No:')) { div.firstChild.nodeValue = M['Doc No:'] + ' '; div.setAttribute('data-th-rewritten','1'); }
        if (t.startsWith('Date:'))   { div.firstChild.nodeValue = M['Date:'] + ' ';   div.setAttribute('data-th-rewritten','1'); }
        // "Room:" appears in same line separated by " ¬∑ Room: <strong>‚Ä¶</strong>"
        if (div.textContent.includes('Room:')){
          div.innerHTML = div.innerHTML.replace('Room:', '‡∏´‡πâ‡∏≠‡∏á:');
          div.setAttribute('data-th-rewritten','1');
        }
      });

      // "Bill To:" block header (exact)
      ps.querySelectorAll('.meta-grid div:first-child > div:first-child').forEach(el=>{
        if (el.textContent.trim()==='Bill To:'){
          el.textContent = M['Bill To:'];
          el.setAttribute('data-th-rewritten','1');
        }
      });

      // "Payment Method:" block header
      ps.querySelectorAll('.meta-grid div:nth-child(2) > div:first-child').forEach(el=>{
        if (el.textContent.trim()==='Payment Method:'){
          el.textContent = M['Payment Method:'];
          el.setAttribute('data-th-rewritten','1');
        }
      });

      // Line-item table headers
      const headCells = Array.from(ps.querySelectorAll('.line-items thead th'));
      headCells.forEach(th=>{
        const txt = th.textContent.trim();
        if (M[txt]){
          th.textContent = M[txt];
          th.setAttribute('data-th-rewritten','1');
        }
      });

      // Footer summary labels (tfoot)
      Array.from(ps.querySelectorAll('.line-items tfoot td')).forEach(td=>{
        const txt = td.textContent.trim();
        if (M[txt]) { td.textContent = M[txt]; td.setAttribute('data-th-rewritten','1'); }
      });

      // Global footer line
      ps.querySelectorAll('.print-footer > div:first-child').forEach(el=>{
        const txt = el.textContent.trim();
        if (M[txt]) { el.textContent = M[txt]; el.setAttribute('data-th-rewritten','1'); }
      });
    }

    /* Currency preview: read THB total from Builder, multiply by rate, show chip */
    function paintConversion(){
      const chip = document.getElementById('fxOut');
      const code = document.getElementById('fxCode')?.value || '';
      const rate = Number(document.getElementById('fxRate')?.value || NaN);
      // Parse THB total from Builder totals box (#bdTotal)
      const totalEl = document.getElementById('bdTotal');
      if (!code || !isFinite(rate) || !totalEl){
        chip.style.display = 'none';
        chip.textContent = '';
        return;
      }
      const thb = parseNumberFromCurrency(totalEl.textContent);
      if (!isFinite(thb)){
        chip.style.display = 'none';
        return;
      }
      const out = thb * rate;
      chip.textContent = `‚âà ${formatNumber(out)} ${code}`;
      chip.style.display = 'inline-block';
      chip.setAttribute('aria-label', `Converted total approximately ${formatNumber(out)} ${code}`);
    }

    function parseNumberFromCurrency(s){
      // Remove all except digits, dot, minus
      const num = Number(String(s).replace(/[^\d.-]/g,''));
      return num;
    }
    function formatNumber(n){
      // Keep sensible precision based on magnitude
      const opts = n >= 100 ? { maximumFractionDigits: 0 } :
                   n >= 10  ? { maximumFractionDigits: 1 } :
                              { maximumFractionDigits: 2 };
      return Number(n).toLocaleString(undefined, opts);
    }
  }
})();
</script>
<!-- ==== PART 11 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 12 START ================================================== -->
<style>
  .lang-panel {
    margin-top: 10px; border: 1px dashed var(--border);
    border-radius: var(--radius); padding: 10px;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.02));
  }
  .lang-grid { display:grid; gap:8px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 900px){ .lang-grid { grid-template-columns: 1fr; } }

  .overdue-badge {
    display:inline-block; padding: 2px 8px;
    border:1px solid rgba(239,68,68,0.35); color:#991b1b; border-radius: 999px;
    margin-left: 6px; font-weight:700; background: rgba(239,68,68,0.08);
  }
  .due-chip {
    display:inline-block; padding: 2px 8px; border:1px solid var(--border);
    border-radius:999px; margin-left:6px;
  }
  .bi-th { display:block; font-size: 11px; opacity: .9; margin-top: 2px; }
</style>

<script>
/* ========================= PART 12 SCRIPT ========================= */

/* Goals
   1) Add a Language selector to Builder controls (English / ‡πÑ‡∏ó‡∏¢ / Bilingual)
      and remember it *per document number* (e.g., INV-1234 vs RCP-1001).
   2) Render Due Date (Invoices only) into the print header; show "Overdue" badge if past today.
*/

/* --- Hook Builder render to inject panel & wire behavior --- */
(function enhanceBuilderPerDocLang(){
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    if (route === 'builder'){
      setTimeout(initLangPanelOnce, 0);
    }
  };

  function initLangPanelOnce(){
    const grid = document.querySelector('.builder-grid');
    const ctrlCard = grid ? grid.querySelector('.card') : null;
    const printSheet = document.getElementById('printSheet');
    if (!grid || !ctrlCard || !printSheet) return;

    // Inject panel only once
    if (!ctrlCard.querySelector('.lang-panel')){
      const panel = document.createElement('div');
      panel.className = 'lang-panel';
      panel.innerHTML = `
        <h3 style="margin:0 0 8px 0">Document Language & Due</h3>
        <div class="lang-grid">
          <div class="field">
            <label>Print Labels Language (per document)</label>
            <select id="docLang">
              <option value="en">English</option>
              <option value="th">‡πÑ‡∏ó‡∏¢</option>
              <option value="bi">Bilingual</option>
            </select>
          </div>
          <div class="field">
            <label>Due Mode (Invoices)</label>
            <select id="docDueMode">
              <option value="terms">Settings ‚Üí Terms (days)</option>
              <option value="date">Pick specific date</option>
              <option value="off">Off</option>
            </select>
          </div>
        </div>
        <div class="form-row" id="duePickerRow" style="display:none;margin-top:6px">
          <div class="field">
            <label>Due Date</label>
            <input id="docDueDate" type="date">
          </div>
          <div class="field">
            <label>Notes (optional)</label>
            <input id="docDueNote" placeholder="e.g., Payment within 7 days.">
          </div>
        </div>
        <small class="subtle">Language remembered by Document No. Changes re-apply to the preview automatically.</small>
      `;
      ctrlCard.appendChild(panel);

      // Read saved prefs for current doc
      applyPrefsToUI();
      // Wire: when controls change, save + repaint
      panel.addEventListener('input', ()=>{
        saveDocPrefs();
        repaintPrint();
      });

      // Also watch builder core fields for doc number/type changes
      ['bdNo','bdType','bdDate'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', ()=>{
          // When doc no changes, load prefs for that no
          if (id==='bdNo') applyPrefsToUI();
          repaintPrint();
        });
      });

      // Observe print sheet changes (from Builder paints)
      const mo = new MutationObserver(()=>repaintPrint());
      mo.observe(printSheet, { childList:true, subtree:true });

      // Initial pass
      repaintPrint();
    }
  }

  /* Persist & recall per-doc language/due prefs */
  function getDocKey(){
    return (document.getElementById('bdNo')?.value || 'DOC').trim();
  }
  function loadAllPrefs(){
    try { return JSON.parse(localStorage.getItem('aptAdminDocPrefs')||'{}'); }
    catch { return {}; }
  }
  function saveAllPrefs(all){
    try { localStorage.setItem('aptAdminDocPrefs', JSON.stringify(all)); } catch {}
  }
  function getPrefsForDoc(){
    const all = loadAllPrefs();
    return all[getDocKey()] || {};
  }
  function setPrefsForDoc(patch){
    const all = loadAllPrefs();
    const key = getDocKey();
    all[key] = { ...(all[key]||{}), ...patch };
    saveAllPrefs(all);
  }

  function applyPrefsToUI(){
    const p = getPrefsForDoc();
    const lang = p.lang || 'en';
    const dueMode = p.dueMode || 'terms';
    const dueDate = p.dueDate || '';
    const dueNote = p.dueNote || '';

    const docLang = document.getElementById('docLang');
    const docDueMode = document.getElementById('docDueMode');
    const docDueDate = document.getElementById('docDueDate');
    const docDueNote = document.getElementById('docDueNote');

    if (docLang) docLang.value = lang;
    if (docDueMode) docDueMode.value = dueMode;
    if (docDueDate) docDueDate.value = dueDate;
    if (docDueNote) docDueNote.value = dueNote;

    // Toggle due picker row visibility
    document.getElementById('duePickerRow').style.display = (dueMode==='date') ? '' : 'none';
  }

  function saveDocPrefs(){
    const lang = document.getElementById('docLang')?.value || 'en';
    const dueMode = document.getElementById('docDueMode')?.value || 'terms';
    const dueDate = document.getElementById('docDueDate')?.value || '';
    const dueNote = document.getElementById('docDueNote')?.value || '';
    setPrefsForDoc({ lang, dueMode, dueDate, dueNote });
    // sync picker visibility
    const row = document.getElementById('duePickerRow');
    if (row) row.style.display = (dueMode==='date') ? '' : 'none';
  }

  /* Repaint print area: apply language & inject due date/badge */
  function repaintPrint(){
    applyLanguageToPrint();
    applyDueToPrint();
  }

  /* Language transforms:
     - 'en': ensure English labels (no-op; Part 11 may have Thai toggled‚Äîforce EN)
     - 'th': apply Thai replacements (re-use Part 11‚Äôs logic by flipping #thToggle)
     - 'bi': bilingual: keep EN labels, append Thai equivalents as secondary lines
  */
  function applyLanguageToPrint(){
    const lang = document.getElementById('docLang')?.value || 'en';
    const ps = document.getElementById('printSheet');
    if (!ps) return;

    // Normalize to English first by re-rendering Builder preview function:
    // Trigger a tiny input to force paint without changing values
    const remarkEl = document.getElementById('bdRemark');
    if (remarkEl){ remarkEl.dispatchEvent(new Event('input', { bubbles:true })); }

    // Then apply language mode
    if (lang === 'th'){
      // Ensure Part 11 Thai toggle is ON
      const thToggle = document.getElementById('thToggle');
      if (thToggle && !thToggle.checked){
        thToggle.checked = true;
        thToggle.dispatchEvent(new Event('input', { bubbles:true }));
      } else {
        // If already on, re-run its function by touching print
        touchPrintSheet();
      }
      // Remove any bilingual artifacts from earlier runs
      ps.querySelectorAll('.bi-th').forEach(n=>n.remove());
    } else if (lang === 'en'){
      // Ensure Part 11 Thai toggle is OFF
      const thToggle = document.getElementById('thToggle');
      if (thToggle && thToggle.checked){
        thToggle.checked = false;
        thToggle.dispatchEvent(new Event('input', { bubbles:true }));
      } else {
        touchPrintSheet();
      }
      ps.querySelectorAll('.bi-th').forEach(n=>n.remove());
    } else if (lang === 'bi'){
      // Ensure base is English‚Ä¶
      const thToggle = document.getElementById('thToggle');
      if (thToggle && thToggle.checked){
        thToggle.checked = false;
        thToggle.dispatchEvent(new Event('input', { bubbles:true }));
      } else {
        touchPrintSheet();
      }
      // ‚Ä¶then add Thai sublabels where we know mappings.
      addBilingualLabels(ps);
    }
  }

  function touchPrintSheet(){
    // Tiny DOM nudge to allow other observers to repaint
    const ps = document.getElementById('printSheet');
    if (!ps) return;
    ps.style.outline = '1px solid transparent';
    setTimeout(()=> ps.style.outline = '', 0);
  }

  function addBilingualLabels(ps){
    const T = {
      'INVOICE':'‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ',
      'RECEIPT':'‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô',
      'Doc No:':'‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:',
      'Date:':'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:',
      'Room:':'‡∏´‡πâ‡∏≠‡∏á:',
      'Bill To:':'‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ:',
      'Payment Method:':'‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:',
      'Description':'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
      'Qty':'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô',
      'Unit':'‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢',
      'Amount':'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô',
      'Subtotal':'‡∏£‡∏ß‡∏°',
      'Late Fee':'‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤',
      'Deposit Return':'‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô',
      'Total':'‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°',
      'Generated by Apartment Admin (UI-only)':'‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ Apartment Admin (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ UI)',
    };

    // Title
    const title = ps.querySelector('.doc-title');
    if (title && !title.querySelector('.bi-th')){
      const th = document.createElement('span');
      th.className = 'bi-th';
      th.textContent = T[title.textContent.trim()] || '';
      if (th.textContent) title.appendChild(th);
    }

    // Header right labels (Doc No, Date, Room)
    ps.querySelectorAll('.print-head div[style*="text-align:right"] > div').forEach(div=>{
      // Avoid double-adding
      if (div.querySelector('.bi-th')) return;
      const txt = div.firstChild && div.firstChild.nodeType===3 ? div.firstChild.nodeValue.trim() : '';
      let key = null;
      if (txt.startsWith('Doc No:')) key = 'Doc No:';
      else if (txt.startsWith('Date:')) key = 'Date:';
      if (div.textContent.includes('Room:')){
        // Append Thai for "Room:"
        const small = document.createElement('span');
        small.className = 'bi-th';
        small.textContent = T['Room:'] || '';
        div.appendChild(small);
      }
      if (key && T[key]){
        const small = document.createElement('span');
        small.className = 'bi-th';
        small.textContent = T[key];
        div.appendChild(small);
      }
    });

    // Bill To / Payment Method headers
    const billTo = ps.querySelector('.meta-grid div:first-child > div:first-child');
    if (billTo && !billTo.querySelector('.bi-th')){
      const small = document.createElement('span'); small.className='bi-th'; small.textContent = T['Bill To:']||''; billTo.appendChild(small);
    }
    const payM = ps.querySelector('.meta-grid div:nth-child(2) > div:first-child');
    if (payM && !payM.querySelector('.bi-th')){
      const small = document.createElement('span'); small.className='bi-th'; small.textContent = T['Payment Method:']||''; payM.appendChild(small);
    }

    // Table headers
    ps.querySelectorAll('.line-items thead th').forEach(th=>{
      if (th.querySelector('.bi-th')) return;
      const en = th.textContent.trim();
      if (T[en]){
        const small = document.createElement('span');
        small.className = 'bi-th';
        small.textContent = T[en];
        th.appendChild(small);
      }
    });

    // Tfoot labels
    ps.querySelectorAll('.line-items tfoot td').forEach(td=>{
      if (td.querySelector('.bi-th')) return;
      const en = td.textContent.trim();
      if (T[en]){
        const small = document.createElement('span');
        small.className = 'bi-th';
        small.textContent = T[en];
        td.appendChild(small);
      }
    });

    // Footer credit line
    const footL = ps.querySelector('.print-footer > div:first-child');
    if (footL && !footL.querySelector('.bi-th')){
      const small = document.createElement('span'); small.className='bi-th'; small.textContent = T['Generated by Apartment Admin (UI-only)']||''; footL.appendChild(small);
    }
  }

  /* Inject Due Date & Overdue badge into print header (Invoices only) */
  function applyDueToPrint(){
    const ps = document.getElementById('printSheet');
    if (!ps) return;
    // Remove previous due-chip/badges
    ps.querySelectorAll('.due-chip,.overdue-badge').forEach(n=>n.remove());

    const type = (document.getElementById('bdType')?.value || 'INVOICE').toUpperCase();
    if (type !== 'INVOICE') return; // Only for invoices

    const p = getPrefsForDoc();
    const mode = p.dueMode || 'terms';

    // Locate the right-aligned header block where we‚Äôll append chips
    const headRight = ps.querySelector('.print-head div[style*="text-align:right"]');
    if (!headRight) return;

    // Compute due date
    let dueDate = '';
    if (mode === 'off'){
      return;
    } else if (mode === 'date'){
      dueDate = p.dueDate || '';
    } else {
      // 'terms' from settings: Store.terms or Store.dueDays
      const base = document.getElementById('bdDate')?.value || new Date().toISOString().slice(0,10);
      const terms = Number(Store.terms || 7);
      dueDate = addDays(base, terms);
    }

    if (dueDate){
      const chip = document.createElement('span');
      chip.className = 'due-chip';
      chip.textContent = `Due: ${dueDate}`;
      headRight.appendChild(chip);

      // Overdue?
      const today = new Date(Store.now || Date.now());
      const d = new Date(dueDate+'T00:00:00');
      if (d < new Date(today.toISOString().slice(0,10)+'T00:00:00')){
        const badge = document.createElement('span');
        badge.className = 'overdue-badge';
        badge.textContent = 'OVERDUE';
        headRight.appendChild(badge);
      }
      // Note (optional)
      if (p.dueNote){
        const note = document.createElement('div');
        note.className = 'bi-th'; // small accent line
        note.textContent = p.dueNote;
        headRight.appendChild(note);
      }
    }

    function addDays(ymd, n){
      const d = new Date(ymd+'T00:00:00'); d.setDate(d.getDate()+Number(n||0));
      return d.toISOString().slice(0,10);
    }
  }

})();
</script>
<!-- ==== PART 12 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 13 START ================================================== -->
<style>
  /* Bulk drawer */
  .bulk-drawer {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--panel);
    box-shadow: var(--shadow);
    padding: 10px;
    margin-bottom: 12px;
    display: none;
  }
  .bulk-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .bulk-row .count { color: var(--muted); font-size: 12px; margin-left: 4px; }
  .pay-select {
    display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted);
  }
  .pay-select input[type="checkbox"] { width:16px; height:16px; }
  .btn.sm { padding:6px 10px; border-radius:10px; font-size:12px; }
  .divider { width:1px; height:18px; background:var(--border); }
  /* Overlay helper hint chip */
  .chip {
    display:inline-block; padding: 2px 8px; border:1px solid var(--border);
    border-radius: 999px; font-size:12px; margin-left: 4px;
  }
</style>

<script>
/* ========================= PART 13 SCRIPT ========================= */

/* High-level:
   1) Enhance Payments view by injecting a bulk-action drawer and selection checkboxes
      on each .pay-card for the current month‚Äôs invoices.
   2) Watch for Invoice overlays; inject an ‚ÄúAuto from Utilities‚Äù button that reads the
      room‚Äôs Utilities for the chosen month and fills #liElec and #liWater.
*/

/* ---------- 1) Payments bulk actions ---------- */
(function enhancePaymentsBulk(){
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    if (route === 'payments') setTimeout(initBulkUI, 0);
  };

  // selection state (inv ids)
  let sel = new Set();

  function initBulkUI(){
    const view = document.getElementById('view');
    if (!view) return;

    // Find top toolbar card and payments grid built by Part 3
    const topCard = view.querySelector('.card');
    const grid = view.querySelector('.payments-grid');
    if (!topCard || !grid) return;

    // If drawer not present, add it just below the toolbar card
    let drawer = view.querySelector('.bulk-drawer');
    if (!drawer){
      drawer = document.createElement('div');
      drawer.className = 'bulk-drawer';
      drawer.innerHTML = `
        <div class="bulk-row">
          <strong>Bulk Actions</strong>
          <span class="count" id="bulkCount">(0 selected)</span>
          <div class="divider"></div>
          <button class="btn sm" id="bulkSelectAll" data-tip="Select all cards currently visible">Select All</button>
          <button class="btn sm ghost" id="bulkClear">Clear</button>
          <div class="divider"></div>
          <button class="btn sm" id="bulkSent">Mark Sent</button>
          <button class="btn sm" id="bulkPaid">Mark Paid</button>
          <div class="divider"></div>
          <label class="pay-select">Assign Bank:
            <select id="bulkBank" class="btn sm" style="min-width:220px">
              ${Store.bankAccounts.map(b=>`<option value="${b.id}">${b.bank} ‚Äî ${b.acct} (${b.name})</option>`).join('')}
            </select>
          </label>
          <button class="btn sm" id="bulkAssignBank" data-tip="Set payment account for selected rooms">Apply</button>
        </div>
      `;
      topCard.insertAdjacentElement('afterend', drawer);
    }

    // (Re)paint checkboxes on each payment card
    installCardCheckboxes();

    // Wire drawer actions
    drawer.querySelector('#bulkSelectAll').onclick = ()=> {
      sel = new Set(getVisibleInvIds());
      syncCheckboxes();
      paintCounter();
    };
    drawer.querySelector('#bulkClear').onclick = ()=> {
      sel.clear(); syncCheckboxes(); paintCounter();
    };
    drawer.querySelector('#bulkSent').onclick = ()=> bulkSetStatus('sent');
    drawer.querySelector('#bulkPaid').onclick = ()=> bulkSetStatus('paid');
    drawer.querySelector('#bulkAssignBank').onclick = ()=> bulkAssignBank(drawer.querySelector('#bulkBank').value);

    // Show drawer only if there are cards
    drawer.style.display = grid.querySelector('.pay-card') ? 'block' : 'none';

    // Respond to filter changes from Payments view (it re-renders grid),
    // so we listen for DOM changes and re-inject checkboxes.
    const mo = new MutationObserver(()=>{
      installCardCheckboxes();
      // When cards change, intersect selection with visible ids
      const visible = new Set(getVisibleInvIds());
      sel.forEach(id=>{ if (!visible.has(id)) sel.delete(id); });
      syncCheckboxes();
      paintCounter();
    });
    mo.observe(grid, { childList: true, subtree: true });

    // Helpers
    function getVisibleInvIds(){
      // Infer inv by roomNo + current month
      const month = monthKey();
      const list = [];
      grid.querySelectorAll('.pay-card').forEach(card=>{
        const roomNo = card.querySelector('header strong')?.textContent?.trim();
        const room = Store.rooms.find(r=>r.roomNo===roomNo);
        const inv = Store.invoices.find(i=>i.roomId===room?.id && i.yyyymm===month);
        if (inv) list.push(inv.id);
      });
      return list;
    }

    function installCardCheckboxes(){
      grid.querySelectorAll('.pay-card').forEach(card=>{
        if (card.querySelector('.pay-select')) return;
        // Find related inv id
        const roomNo = card.querySelector('header strong')?.textContent?.trim();
        const room = Store.rooms.find(r=>r.roomNo===roomNo);
        const inv = Store.invoices.find(i=>i.roomId===room?.id && i.yyyymm===monthKey());
        // Insert a checkbox row at bottom
        const row = document.createElement('div');
        row.className = 'pay-select';
        row.innerHTML = `
          <input type="checkbox" aria-label="Select invoice ${inv?.id || ''}">
          <span>Select</span>
        `;
        // Click handling
        const box = row.querySelector('input');
        if (inv){
          box.checked = sel.has(inv.id);
          box.addEventListener('change', ()=>{
            if (box.checked) sel.add(inv.id); else sel.delete(inv.id);
            paintCounter();
          });
          // Clicking card header strong toggles selection
          const head = card.querySelector('header');
          head?.addEventListener('dblclick', ()=>{
            box.checked = !box.checked;
            box.dispatchEvent(new Event('change', { bubbles:true }));
          });
        } else {
          box.disabled = true;
          row.querySelector('span').textContent = 'No invoice';
        }
        card.appendChild(row);
      });
      paintCounter();
    }

    function paintCounter(){
      const el = drawer.querySelector('#bulkCount');
      el.textContent = `(${sel.size} selected)`;
      el.style.color = sel.size ? 'var(--text)' : 'var(--muted)';
    }

    function syncCheckboxes(){
      grid.querySelectorAll('.pay-card').forEach(card=>{
        const roomNo = card.querySelector('header strong')?.textContent?.trim();
        const room = Store.rooms.find(r=>r.roomNo===roomNo);
        const inv = Store.invoices.find(i=>i.roomId===room?.id && i.yyyymm===monthKey());
        const box = card.querySelector('.pay-select input[type="checkbox"]');
        if (!box) return;
        if (inv){ box.checked = sel.has(inv.id); box.disabled = false; }
        else { box.checked = false; box.disabled = true; }
      });
    }

    function bulkSetStatus(status){
      if (!sel.size) return Toast.show('No selection');
      sel.forEach(id=>{
        const inv = Store.invoices.find(i=>i.id===id);
        if (inv) inv.status = status;
      });
      Toast.show(`Marked ${sel.size} as ${status}`);
      // Force re-render by navigating to same route (skeleton shim will handle)
      Router.navigate('payments');
    }

    function bulkAssignBank(bankId){
      if (!sel.size) return Toast.show('No selection');
      const month = monthKey();
      let changed = 0;
      sel.forEach(id=>{
        const inv = Store.invoices.find(i=>i.id===id && i.yyyymm===month);
        if (!inv) return;
        const room = Store.rooms.find(r=>r.id===inv.roomId);
        if (room){ room.payMethodId = bankId; changed++; }
      });
      Toast.show(`Assigned bank for ${changed} room(s)`);
      Router.navigate('payments');
    }
  }
})();

/* ---------- 2) ‚ÄúAuto from Utilities‚Äù in Invoice overlay ---------- */
(function autoFromUtilitiesInjector(){
  // Observe overlay: when an Invoice overlay opens (Part 3), inject button.
  const overlay = document.getElementById('overlay');
  if (!overlay) return;

  const mo = new MutationObserver(()=>{
    if (!overlay.classList.contains('open')) return;
    const body = overlay.querySelector('#sheetBody');
    if (!body) return;

    // Check if this is the Invoice overlay (has #liElec & #liWater inputs)
    const liElec = body.querySelector('#liElec');
    const liWater = body.querySelector('#liWater');
    const totalNode = body.querySelector('#liTotal');
    if (liElec && liWater && !body.querySelector('#autoFromUtil')){
      // Insert action row near totals
      const card = totalNode?.closest('.card') || body;
      const row = document.createElement('div');
      row.style = 'margin:8px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap';
      row.innerHTML = `
        <button class="btn sm" id="autoFromUtil" data-tip="Fill from Utilities records for this month">Auto from Utilities</button>
        <span class="chip" id="autoFromUtilInfo" aria-live="polite">Reads current month‚Äôs saved kWh/m¬≥ √ó rates</span>
      `;
      card.insertAdjacentElement('afterend', row);

      // Wire logic
      row.querySelector('#autoFromUtil').addEventListener('click', ()=>{
        // Identify room & month from overlay header content
        const monthPill = body.querySelector('.pill.gray')?.textContent?.trim() || monthKey();
        const roomLabel = body.querySelector('h3')?.textContent?.trim() || '';
        const roomNo = roomLabel.split('¬∑')[0].trim(); // "101 ¬∑ Name"
        const room = Store.rooms.find(r=>r.roomNo===roomNo);
        if (!room) { Toast.show('Room not found'); return; }

        const util = room.utilities?.find(u=>u.yyyymm===monthPill);
        if (!util){
          Toast.show(`No utility record for ${monthPill}`);
          return;
        }
        const elecCost = Number(util.elecKwh||0) * Number(Store.utilities.elecRate||0);
        const waterCost = Number(util.waterM3||0) * Number(Store.utilities.waterRate||0);

        // Populate fields
        liElec.value = String(elecCost.toFixed(0));
        liWater.value = String(waterCost.toFixed(0));
        // trigger input to recalc totals (Part 3 overlay listens for input)
        liElec.dispatchEvent(new Event('input', { bubbles:true }));
        liWater.dispatchEvent(new Event('input', { bubbles:true }));

        const info = row.querySelector('#autoFromUtilInfo');
        info.textContent = `kWh ${util.elecKwh} √ó ‡∏ø${Store.utilities.elecRate} & m¬≥ ${util.waterM3} √ó ‡∏ø${Store.utilities.waterRate}`;
        Toast.show('Auto-filled from Utilities');
      }, { once:false });
    }
  });
  mo.observe(overlay, { attributes:true, attributeFilter:['class'], childList:true, subtree:true });
})();
</script>
<!-- ==== PART 13 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 14 START ================================================== -->
<style>
  /* Compact popover style (rendered inside the main overlay shell) */
  .qb-wrap {
    display:grid; gap:8px;
    min-width: 320px; max-width: 520px;
  }
  .qb-grid {
    display:grid; gap:8px;
    grid-template-columns: 1fr 1fr;
  }
  @media (max-width: 560px){ .qb-grid { grid-template-columns: 1fr; } }
  .qb-note { font-size: 12px; color: var(--muted); }
  .qb-kv { display:flex; justify-content:space-between; gap:12px; }
  .qb-kv b { font-weight:700 }
  .qb-chip { display:inline-block; padding: 2px 8px; border:1px solid var(--border); border-radius:999px; }
  .room-card .qb-btn {
    margin-top: 6px;
    width: 100%;
  }
</style>

<script>
/* ========================= PART 14 SCRIPT ========================= */

/* High level
   - Inject a "Quick Bill" button into each Room card on the Rooms view.
   - Clicking opens a small popover (overlay) letting you:
       ‚Ä¢ pick the billing month (defaults to current)
       ‚Ä¢ include utilities (on/off)
       ‚Ä¢ open print preview automatically (on/off)
     Then it drafts line items (Room Rate, Electricity, Water) and jumps to the Builder.
*/

(function initQuickBill(){
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    if (route === 'rooms') setTimeout(attachButtons, 0);
  };

  function attachButtons(){
    const host = document.getElementById('view');
    if (!host) return;

    // Heuristic: room cards created in Part 1/2 have a button row; we just append ours if not present
    const cards = host.querySelectorAll('.room-card, [data-room-card], article.card-room, .floor .card');
    // Fallback: find by content "Room " + number
    const roomsByNo = Object.fromEntries(Store.rooms.map(r=>[r.roomNo, r]));

    // Safer selector: any card that shows a room number in a strong tag in header
    const genericCards = host.querySelectorAll('.card');
    const seen = new Set();

    cards.forEach(c=>seen.add(c));
    genericCards.forEach(c=>{
      const hdr = c.querySelector('header strong');
      if (!hdr) return;
      const no = hdr.textContent.trim();
      if (roomsByNo[no]) seen.add(c);
    });

    seen.forEach(card=>{
      if (card._qbWired) return;
      const roomNo = (card.querySelector('header strong')?.textContent || '').trim();
      const room = Store.rooms.find(r=>r.roomNo === roomNo);
      if (!room) return;

      // Append Quick Bill button
      const btn = document.createElement('button');
      btn.className = 'btn qb-btn';
      btn.textContent = 'Quick Bill';
      btn.setAttribute('data-tip','Draft invoice from room rate + utilities');
      btn.addEventListener('click', ()=> openQB(room.id));
      card.appendChild(btn);

      card._qbWired = true;
    });
  }

  /* Popover UI + logic */
  function openQB(roomId){
    const room = Store.rooms.find(r=>r.id === roomId);
    const renter = Store.renters.find(r=>r.id===room?.renterId) || Store.renters.find(r=>r.roomId===roomId);
    const month = monthKey(); // YYYY-MM

    const node = document.createElement('div');
    node.className = 'qb-wrap';
    node.innerHTML = `
      <div>
        <h3 style="margin:0 0 6px 0">Quick Bill ¬∑ Room ${room?.roomNo || '‚Äî'}</h3>
        <div class="qb-note">UI-only. Uses Utilities √ó rates to prefill Electricity/Water.</div>
      </div>
      <div class="qb-grid">
        <div class="field">
          <label>Billing Month</label>
          <input id="qbMonth" type="month" value="${month}">
        </div>
        <div class="field">
          <label>Include Utilities</label>
          <select id="qbUtil"><option value="yes">Yes</option><option value="no">No</option></select>
        </div>
      </div>
      <div class="qb-grid">
        <div class="field">
          <label>Open Print Preview</label>
          <select id="qbPrint"><option value="yes">Yes</option><option value="no">No</option></select>
        </div>
        <div class="field">
          <label>Assign Bank (optional)</label>
          <select id="qbBank">
            <option value="">‚Äî keep current ‚Äî</option>
            ${Store.bankAccounts.map(b=>`<option value="${b.id}" ${room?.payMethodId===b.id?'selected':''}>${b.bank} ‚Äî ${b.acct} (${b.name})</option>`).join('')}
          </select>
        </div>
      </div>

      <div class="card" style="padding:10px">
        <div class="qb-kv"><span>Renter</span><b>${renter?.name || '‚Äî'}</b></div>
        <div class="qb-kv"><span>Room Rate</span><b>${currency(room?.rate ?? Store.defaults.roomRate)}</b></div>
        <div class="qb-kv"><span>Utilities Rate</span><b>Elec ‡∏ø${Store.utilities.elecRate}/kWh ¬∑ Water ‡∏ø${Store.utilities.waterRate}/m¬≥</b></div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="btn" id="qbGo">Draft Invoice</button>
        <button class="btn ghost" id="qbCancel">Cancel</button>
      </div>
      <div class="qb-note">Tip: Utilities come from Room ‚Üí ‚ÄúUtilities Record‚Äù for the selected month. If none, amounts default to 0.</div>
    `;

    openOverlay('Quick Bill', node);
    node.querySelector('#qbCancel').addEventListener('click', closeOverlay);
    node.querySelector('#qbGo').addEventListener('click', ()=>{
      const yyyymm = node.querySelector('#qbMonth').value || monthKey();
      const includeUtil = node.querySelector('#qbUtil').value === 'yes';
      const autoPrint = node.querySelector('#qbPrint').value === 'yes';
      const bankId = node.querySelector('#qbBank').value;
      quickBillDraft({ roomId, yyyymm, includeUtil, autoPrint, bankId: bankId || null });
    });
  }

  function quickBillDraft({ roomId, yyyymm, includeUtil, autoPrint, bankId }){
    const room = Store.rooms.find(r=>r.id===roomId);
    if (!room){ Toast.show('Room not found'); return; }
    const renter = Store.renters.find(r=>r.id===room.renterId) || Store.renters.find(r=>r.roomId===roomId);

    // Optionally assign bank to room
    if (bankId) room.payMethodId = bankId;

    // Compute utilities for month
    const util = (room.utilities||[]).find(u=>u.yyyymm===yyyymm) || null;
    const elecCost = includeUtil ? Number((util?.elecKwh || 0) * (Store.utilities.elecRate||0)) : 0;
    const waterCost = includeUtil ? Number((util?.waterM3 || 0) * (Store.utilities.waterRate||0)) : 0;
    const rate = Number(room.rate ?? Store.defaults.roomRate ?? 0);

    // Navigate to Builder and populate its fields (DOM-driven integration with Part 4)
    Router.navigate('builder');

    // After Builder paints, set values and trigger recalcs
    setTimeout(()=>{
      // Set document type/date/room/renter/address/bank/remark
      const date = (yyyymm + '-01');
      setValue('#bdType', 'INVOICE');
      setValue('#bdDate', date);
      setValue('#bdRoom', room.id);
      if (renter) setValue('#bdRenter', renter.id);
      // address: prefer first address
      const addrId = Store.addresses[0]?.id || null;
      if (addrId) setValue('#bdAddr', addrId);
      // bank: prefer room payMethodId
      if (room.payMethodId) setValue('#bdBank', room.payMethodId);
      setValue('#bdRemark', 'Quick Bill draft (UI-only)');

      // Compose items: Room Rate, Electricity, Water
      // Click "Reset" to known 3-line baseline, then fill
      document.querySelector('#resetItems')?.click();
      // Fill rows
      const rows = document.querySelectorAll('#itemsHost [data-idx]');
      // Ensure at least 3 rows
      while (document.querySelectorAll('#itemsHost [data-idx]').length < 3){
        document.querySelector('#addItem')?.click();
      }
      const setRow = (i, name, qty, price)=>{
        const row = document.querySelector(`#itemsHost [data-idx="${i}"]`);
        if (!row) return;
        setValue('input[data-k="name"]', name, row);
        setValue('input[data-k="qty"]', String(qty), row);
        setValue('input[data-k="price"]', String(price.toFixed ? price.toFixed(0) : price), row);
      };
      setRow(0, 'Room Rate', 1, rate);
      setRow(1, 'Electricity', 1, elecCost);
      setRow(2, 'Water', 1, waterCost);

      // Zero out fees/deposit
      setValue('#bdLate', '0');
      setValue('#bdDepReturn', '0');
      const mv = document.querySelector('#bdMoveOut'); if (mv && mv.checked){ mv.click(); }

      // Trigger paints & show a chip with source utility
      const totalText = document.querySelector('#bdTotal')?.textContent?.trim() || '';
      Toast.show(util ? `Drafted from Utilities: kWh ${util.elecKwh} & m¬≥ ${util.waterM3}` : 'Drafted (no utilities for month)');
      // Optional: auto open print
      if (autoPrint){
        // ensure preview is up-to-date, then print
        setTimeout(()=> document.querySelector('#bdPreview')?.click(), 200);
      } else {
        // Focus the Print button as a hint
        document.querySelector('#bdPreview')?.focus();
      }
    }, 300); // allow skeleton + builder to render

    function setValue(selector, value, root=document){
      const el = root.querySelector(selector);
      if (!el) return;
      if (el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'){
        el.value = value;
        el.dispatchEvent(new Event('input', { bubbles:true }));
        el.dispatchEvent(new Event('change', { bubbles:true }));
      } else {
        el.textContent = value;
      }
    }
  }

})();
</script>
<!-- ==== PART 14 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 15 START ================================================== -->
<style>
  .mo-hint { font-size: 12px; color: var(--muted); }
  .mo-row  { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0; }
  .mo-total {
    display:inline-block; padding: 4px 10px; border:1px solid var(--border);
    border-radius: 999px; background: var(--panel); font-weight:700;
  }
  .bad-outline { outline: 2px solid rgba(239,68,68,.6); border-radius: 8px; }
  .good-outline{ outline: 2px solid rgba(16,185,129,.5); border-radius: 8px; }
  .btn.xs { padding:6px 10px; border-radius:10px; font-size:12px; }
</style>

<script>
/* ========================= PART 15 SCRIPT ========================= */

/* ------------------------------------------------------------------ */
/*  A) Re-open last overlay (Alt+O)                                   */
/*      - Wrap openOverlay() to remember last title + HTML snapshot.   */
/*      - Alt+O replays it (fresh DOM, handlers reattached by init).   */
/* ------------------------------------------------------------------ */
(function patchReopenOverlayHotkey(){
  const origOpen = window.openOverlay?.bind(window) || openOverlay;
  let lastOverlaySnapshot = null; // { title, html }

  window.openOverlay = function(title, node){
    // Cache snapshot (HTML only; re-initializers from other Parts will re-bind)
    try {
      const tmp = document.createElement('div');
      tmp.appendChild(node.cloneNode(true));
      lastOverlaySnapshot = { title, html: tmp.innerHTML };
    } catch { /* no-op */ }
    return origOpen(title, node);
  };

  document.addEventListener('keydown', (e)=>{
    if (e.altKey && !e.shiftKey && e.key.toLowerCase()==='o'){
      if (!lastOverlaySnapshot) { Toast?.show?.('No overlay to reopen'); return; }
      const wrap = document.createElement('div');
      wrap.innerHTML = lastOverlaySnapshot.html;
      // Note: Some overlays rely on runtime wiring (e.g., listeners). Many Parts
      // observe #overlay mutations and will re-bind when it opens.
      origOpen(lastOverlaySnapshot.title + ' (reopened)', wrap);
    }
  });
})();

/* ------------------------------------------------------------------ */
/*  B) Move-Out tab enhancer                                           */
/*      - Live calc: Return = (Advance + Deposit) ‚àí (Final + Fees).    */
/*      - Prevent negative returns (warn & disable ‚ÄúRecord Move-Out‚Äù). */
/*      - Auto Late Fee: from Settings (flat / percent of Final).      */
/* ------------------------------------------------------------------ */
(function enhanceMoveOutTab(){
  const overlay = document.getElementById('overlay');
  if (!overlay) return;

  // When any overlay opens, check if it contains a "Move-Out" section
  const mo = new MutationObserver(()=>{
    if (!overlay.classList.contains('open')) return;

    const body = overlay.querySelector('#sheetBody');
    if (!body) return;

    // Heuristic: find a section whose heading contains "Move-Out"
    const moveOutSection =
      Array.from(body.querySelectorAll('h3,h4')).find(h=>{
        return /move-?out/i.test(h.textContent || '');
      })?.closest('.card') || // most of our sections are in .card
      Array.from(body.children).find(el=>/move-?out/i.test(el.textContent||''));
    if (!moveOutSection || moveOutSection._moWired) return;

    moveOutSection._moWired = true;

    // Inject a tiny helper row (auto late fee + computed return)
    const helper = document.createElement('div');
    helper.className = 'mo-row';
    helper.innerHTML = `
      <button class="btn xs" id="moAutoLate">Auto Late Fee</button>
      <span class="mo-hint">Late fee is <b>${Store.defaults.lateFee.type}</b> ${Store.defaults.lateFee.type==='flat' ? currency(Store.defaults.lateFee.value) : (Store.defaults.lateFee.value+'% of final rent')}</span>
      <span class="mo-total" id="moReturnShow">Return: ‚Äî</span>
    `;
    moveOutSection.appendChild(helper);

    // Try to locate inputs by common ids / names / data attributes.
    const F = mapMoveOutFields(moveOutSection);

    // Wire auto-calc & validation
    const inputs = Array.from(moveOutSection.querySelectorAll('input[type="number"], input[type="date"], input[type="text"]'));
    inputs.forEach(inp=> inp.addEventListener('input', recalc));

    const autoBtn = helper.querySelector('#moAutoLate');
    autoBtn?.addEventListener('click', ()=>{
      const v = computeLateFee(F);
      if (F.late) {
        F.late.value = String(v);
        F.late.dispatchEvent(new Event('input', { bubbles:true }));
      }
      Toast.show('Late fee applied from Settings');
    });

    // Initial paint
    recalc();

    /* ---- helpers ---- */
    function n(x){ const v = Number((x && x.value) || 0); return isFinite(v) ? v : 0; }

    function recalc(){
      const advance = n(F.advance);
      const deposit = n(F.deposit);
      const final   = n(F.finalRent);
      const fees    = n(F.fee) + n(F.late);

      const ret = (advance + deposit) - (final + fees);

      const show = helper.querySelector('#moReturnShow');
      show.textContent = 'Return: ' + currency(ret);

      // Negative guard: outline and disable "Record Move-Out"
      const isBad = ret < 0;
      if (F.returnOut){
        F.returnOut.value = currency(ret);
      }
      [F.advance, F.deposit, F.finalRent, F.fee, F.late].forEach(el=>{
        if (!el) return;
        el.classList.toggle('bad-outline', isBad);
        el.classList.toggle('good-outline', !isBad);
      });

      const recordBtn = findRecordButton(moveOutSection);
      if (recordBtn){
        recordBtn.disabled = isBad;
        recordBtn.title = isBad ? 'Return amount is negative. Fix numbers to proceed.' : '';
      }
      if (isBad){
        // small, non-intrusive heads-up
        show.classList.add('bad-outline');
      } else {
        show.classList.remove('bad-outline');
      }
    }

    function computeLateFee(F){
      const t = Store.defaults.lateFee || { type:'flat', value:0 };
      const final = n(F.finalRent);
      if (t.type === 'percent'){
        return Math.max(0, Math.round((t.value/100) * final));
      }
      return Math.max(0, Number(t.value||0));
    }
  });

  mo.observe(overlay, { attributes:true, attributeFilter:['class'], childList:true, subtree:true });

  /* Try to discover fields inside the Move-Out section. This supports various
     earlier IDs/names without requiring exact matches. */
  function mapMoveOutFields(scope){
    const get = (...sels)=> sels.map(s=> scope.querySelector(s)).find(Boolean);

    const advance  = get('#moAdvance','[name="advance"]','[data-mo="advance"]','input[placeholder*="Advance"]');
    const deposit  = get('#moDeposit','[name="deposit"]','[data-mo="deposit"]','input[placeholder*="Deposit"]');
    const finalRent= get('#moFinal','[name="finalRent"]','[data-mo="final"]','input[placeholder*="Final"]');
    const fee      = get('#moFee','[name="fee"]','[data-mo="fee"]','input[placeholder*="Fee"]');
    const late     = get('#moLate','[name="lateFee"]','[data-mo="late"]','input[placeholder*="Late"]');
    const returnOut= get('#moReturn','[name="return"]','[data-mo="return"]');

    return { advance, deposit, finalRent, fee, late, returnOut };
  }

  function findRecordButton(scope){
    // common IDs or by text content
    return scope.querySelector('#moRecord, [data-mo="record"], button')
      && Array.from(scope.querySelectorAll('button')).find(b=>/record\s*move-?out/i.test(b.textContent||''));
  }
})();
</script>
<!-- ==== PART 15 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 16 START ================================================== -->
<style>
  /* ---------- Sticky tab bar for overlays ---------- */
  .tabs-sticky {
    position: sticky;
    top: 8px;
    z-index: 5;
    background: var(--panel);
    backdrop-filter: blur(8px);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 6px;
  }
  .tabs-sticky.stuck {
    box-shadow: var(--shadow);
  }

  /* ---------- Utilities Assistant panel ---------- */
  .util-assist {
    margin-top: 10px;
    border: 1px dashed var(--border);
    border-radius: var(--radius);
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.03));
    padding: 10px;
  }
  .ua-grid {
    display: grid; gap: 8px;
    grid-template-columns: 1fr 1fr 1fr;
  }
  @media (max-width: 920px){ .ua-grid { grid-template-columns: 1fr; } }
  .ua-col .field input {
    padding: 8px 10px;
  }
  .ua-note { font-size: 12px; color: var(--muted); }
  .ua-totals {
    display: grid; gap: 6px; grid-template-columns: 1fr 1fr;
  }
  .ua-chip { display:inline-block; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; }
  .ua-bad  { outline: 2px solid rgba(239,68,68,.6); border-radius: 8px; }
  .ua-good { outline: 2px solid rgba(16,185,129,.45); border-radius: 8px; }
</style>

<script>
/* ========================= PART 16 SCRIPT ========================= */

/* -------------------------------------------------------------- */
/* A) Sticky tab header for overlays                              */
/*    - Detects tabbars in #overlay and makes them sticky         */
/* -------------------------------------------------------------- */
(function makeOverlayTabsSticky(){
  const overlay = document.getElementById('overlay');
  if (!overlay) return;

  const mo = new MutationObserver(()=>{
    if (!overlay.classList.contains('open')) return;
    const body = overlay.querySelector('#sheetBody');
    if (!body) return;

    // Heuristics for tab bar: role="tablist" or element with many [role="tab"] or ul.tabs-like
    const tablist = body.querySelector('[role="tablist"]')
                  || [...body.querySelectorAll('ul,nav,div')].find(el=>{
                       const tabs = el.querySelectorAll('[role="tab"],[data-tab],.tab');
                       return tabs.length >= 3 && el.childElementCount >= 3;
                     });
    if (!tablist || tablist._stickyWired) return;

    tablist._stickyWired = true;
    tablist.classList.add('tabs-sticky');

    // Shadow only when stuck: observe a sentinel above it
    const wrapper = tablist.parentElement || body;
    const sentinel = document.createElement('div');
    sentinel.style.height = '1px';
    wrapper.insertBefore(sentinel, tablist);

    const io = new IntersectionObserver(entries=>{
      const e = entries[0];
      const stuck = !e.isIntersecting;
      tablist.classList.toggle('stuck', stuck);
    }, { root: overlay.querySelector('.sheet') || null, threshold: 1.0 });
    io.observe(sentinel);
  });
  mo.observe(overlay, { attributes:true, attributeFilter:['class'], childList:true, subtree:true });
})();

/* -------------------------------------------------------------- */
/* B) Utilities Assistant                                         */
/*    - Adds a small calculator into Room overlay ‚Üí Utilities tab */
/*    - Computes usage from meter deltas and saves to Store       */
/* -------------------------------------------------------------- */
(function utilitiesAssistant(){
  const overlay = document.getElementById('overlay');
  if (!overlay) return;

  const mo = new MutationObserver(()=>{
    if (!overlay.classList.contains('open')) return;
    const body = overlay.querySelector('#sheetBody');
    if (!body) return;

    // Find the Utilities section card by heading text
    const utilSection =
      Array.from(body.querySelectorAll('h3,h4')).find(h=>/utilities\s*record/i.test(h.textContent||''))?.closest('.card')
      || Array.from(body.children).find(el=>/utilities\s*record/i.test(el.textContent||''));
    if (!utilSection || utilSection._uaWired) return;

    utilSection._uaWired = true;

    // Find room id for this overlay (read from title "Room 101 ¬∑ Name" or data attrs)
    const headerH3 = body.querySelector('h3');
    const roomLabel = headerH3?.textContent?.trim() || '';
    const roomNo = roomLabel.split('¬∑')[0].trim();
    const room = Store.rooms.find(r=>r.roomNo === roomNo) || Store.rooms[0];

    const rates = Store.utilities || { elecRate: 8.5, waterRate: 18.0 };

    // Helper UI panel
    const panel = document.createElement('div');
    panel.className = 'util-assist';
    panel.innerHTML = `
      <h4 style="margin:0 0 6px 0">Utilities Assistant</h4>
      <div class="ua-note">Compute usage from meter deltas; save to <code>room.utilities</code> for billing. Rates: Elec ‡∏ø${rates.elecRate}/kWh, Water ‡∏ø${rates.waterRate}/m¬≥.</div>

      <div class="ua-grid" style="margin-top:8px">
        <div class="ua-col">
          <div class="field">
            <label>Month (YYYY-MM)</label>
            <input id="uaMonth" type="month" value="${monthKey()}">
          </div>
          <div class="field">
            <label>Load Existing (if any)</label>
            <button class="btn" id="uaLoad">Load</button>
          </div>
          <div class="field">
            <label>Save / Update</label>
            <button class="btn" id="uaSave">Save to Room</button>
          </div>
        </div>

        <div class="ua-col">
          <div class="field">
            <label>Electricity Meter ‚Äî Previous</label>
            <input id="uaElecPrev" type="number" step="0.01" placeholder="e.g., 12345.00">
          </div>
          <div class="field">
            <label>Electricity Meter ‚Äî Current</label>
            <input id="uaElecCurr" type="number" step="0.01" placeholder="e.g., 12412.75">
          </div>
          <div class="field">
            <label>kWh (computed)</label>
            <input id="uaElecKwh" type="number" step="0.01" readonly>
          </div>
        </div>

        <div class="ua-col">
          <div class="field">
            <label>Water Meter ‚Äî Previous</label>
            <input id="uaWaterPrev" type="number" step="0.01" placeholder="e.g., 890.00">
          </div>
          <div class="field">
            <label>Water Meter ‚Äî Current</label>
            <input id="uaWaterCurr" type="number" step="0.01" placeholder="e.g., 897.50">
          </div>
          <div class="field">
            <label>m¬≥ (computed)</label>
            <input id="uaWaterM3" type="number" step="0.01" readonly>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="ua-totals">
          <div>Electricity Cost</div> <div id="uaElecCost" class="ua-chip">‡∏ø0</div>
          <div>Water Cost</div>       <div id="uaWaterCost" class="ua-chip">‡∏ø0</div>
          <div><strong>Total</strong></div> <div id="uaTotal" class="ua-chip"><strong>‡∏ø0</strong></div>
        </div>
        <div class="ua-note" style="margin-top:6px">Tip: After saving, use Payments ‚Üí Invoice overlay ‚Üí ‚ÄúAuto from Utilities‚Äù (Part 13) to pull these values.</div>
      </div>
    `;
    utilSection.appendChild(panel);

    const els = {
      month:  panel.querySelector('#uaMonth'),
      load:   panel.querySelector('#uaLoad'),
      save:   panel.querySelector('#uaSave'),
      ePrev:  panel.querySelector('#uaElecPrev'),
      eCurr:  panel.querySelector('#uaElecCurr'),
      eKwh:   panel.querySelector('#uaElecKwh'),
      wPrev:  panel.querySelector('#uaWaterPrev'),
      wCurr:  panel.querySelector('#uaWaterCurr'),
      wM3:    panel.querySelector('#uaWaterM3'),
      eCost:  panel.querySelector('#uaElecCost'),
      wCost:  panel.querySelector('#uaWaterCost'),
      total:  panel.querySelector('#uaTotal'),
    };

    // Live recompute on input
    panel.addEventListener('input', onInput);
    els.load.addEventListener('click', onLoad);
    els.save.addEventListener('click', onSave);

    // Helpers
    function num(v){ const n = Number(v); return isFinite(n) ? n : 0; }
    function round2(x){ return Math.max(0, Math.round(x*100)/100); }

    function onInput(e){
      // Compute deltas
      const eDelta = round2(num(els.eCurr.value) - num(els.ePrev.value));
      const wDelta = round2(num(els.wCurr.value) - num(els.wPrev.value));

      // Guard negatives
      const eBad = eDelta < 0, wBad = wDelta < 0;
      [els.ePrev, els.eCurr].forEach(el=> el.classList.toggle('ua-bad', eBad));
      [els.wPrev, els.wCurr].forEach(el=> el.classList.toggle('ua-bad', wBad));

      els.eKwh.value = eBad ? '' : String(eDelta);
      els.wM3.value  = wBad ? '' : String(wDelta);

      // Costs
      const eCost = eBad ? 0 : eDelta * rates.elecRate;
      const wCost = wBad ? 0 : wDelta * rates.waterRate;
      els.eCost.textContent = currency(Math.round(eCost));
      els.wCost.textContent = currency(Math.round(wCost));
      els.total.innerHTML   = `<strong>${currency(Math.round(eCost + wCost))}</strong>`;

      // Good outline when sane
      const ok = !eBad && !wBad;
      panel.classList.toggle('ua-good', ok);
      panel.classList.toggle('ua-bad', !ok);
    }

    function onLoad(){
      const key = els.month.value || monthKey();
      const rec = (room.utilities||[]).find(u=>u.yyyymm===key);
      if (!rec){
        Toast.show(`No saved record for ${key}`);
        return;
      }
      // Load usage into computed fields; meter baselines unknown ‚Üí leave prev/curr blank
      els.eKwh.value = String(rec.elecKwh || 0);
      els.wM3.value  = String(rec.waterM3 || 0);
      // Recompute costs from usage directly
      const eCost = num(rec.elecKwh) * rates.elecRate;
      const wCost = num(rec.waterM3) * rates.waterRate;
      els.eCost.textContent = currency(Math.round(eCost));
      els.wCost.textContent = currency(Math.round(wCost));
      els.total.innerHTML   = `<strong>${currency(Math.round(eCost + wCost))}</strong>`;
      // Visual cue
      [els.ePrev, els.eCurr, els.wPrev, els.wCurr].forEach(el=> el.classList.remove('ua-bad','ua-good'));
      panel.classList.add('ua-good');
      Toast.show('Loaded usage (kWh/m¬≥) for month');
    }

    function onSave(){
      const key = els.month.value || monthKey();

      // Prefer computed usage from kWh/m¬≥ if present; else compute from meters
      let kwh  = num(els.eKwh.value);
      let m3   = num(els.wM3.value);

      if (!kwh && els.eCurr.value !== '' && els.ePrev.value !== ''){
        kwh = Math.max(0, num(els.eCurr.value) - num(els.ePrev.value));
      }
      if (!m3 && els.wCurr.value !== '' && els.wPrev.value !== ''){
        m3 = Math.max(0, num(els.wCurr.value) - num(els.wPrev.value));
      }

      if (kwh < 0 || m3 < 0){
        Toast.show('Negative usage not allowed');
        return;
      }

      room.utilities = room.utilities || [];
      const idx = room.utilities.findIndex(u=>u.yyyymm===key);
      const rec = { yyyymm: key, elecKwh: round2(kwh), waterM3: round2(m3) };
      if (idx >= 0) room.utilities[idx] = rec;
      else room.utilities.push(rec);

      Toast.show(`Saved utilities for ${room.roomNo} ‚Äî ${key}`);
      // Add subtle hint for invoice overlay users
      const hint = document.createElement('div');
      hint.className = 'ua-note';
      hint.textContent = 'You can now open Payments ‚Üí invoice and click ‚ÄúAuto from Utilities‚Äù.';
      panel.appendChild(hint);
    }

    // Bootstrap initial compute
    onInput();
  });
  mo.observe(overlay, { attributes:true, attributeFilter:['class'], childList:true, subtree:true });
})();
</script>
<!-- ==== PART 16 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 17 START ================================================== -->
<style>
  .ua-mem {
    margin-top: 8px;
    display: grid; gap: 8px;
    grid-template-columns: 1fr 1fr 1fr;
  }
  @media (max-width: 920px){ .ua-mem { grid-template-columns: 1fr; } }
  .ua-mem .field input { padding: 8px 10px; }
  .ua-inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .ua-mini { font-size: 12px; color: var(--muted); }
  .btn.slim { padding:6px 10px; border-radius:10px; font-size:12px; }
</style>

<script>
/* ========================= PART 17 SCRIPT ========================= */

/* Extends PART 16 Utilities Assistant:
   - Adds "Baselines Memory" section under the assistant.
   - Memory is stored in Store._meterMem[roomId] = { elecPrev, waterPrev, updatedAt }.
   - Buttons:
       ‚Ä¢ Prefill from Memory ‚Üí sets Prev fields from memory (keeps Curr empty)
       ‚Ä¢ Roll Prev=Curr ‚Üí copies Curr to Prev and clears Curr (fast next-month prep)
       ‚Ä¢ Save: if "Update Memory" is checked, writes new Prev from Curr
*/

(function augmentUtilitiesAssistantMemory(){
  const overlay = document.getElementById('overlay');
  if (!overlay) return;

  const mo = new MutationObserver(()=>{
    if (!overlay.classList.contains('open')) return;
    const body = overlay.querySelector('#sheetBody');
    if (!body) return;

    const utilSection =
      Array.from(body.querySelectorAll('.util-assist')).pop();
    if (!utilSection || utilSection._memWired) return;

    utilSection._memWired = true;

    // Identify room
    const headerH3 = body.querySelector('h3');
    const roomLabel = headerH3?.textContent?.trim() || '';
    const roomNo = roomLabel.split('¬∑')[0].trim();
    const room = Store.rooms.find(r=>r.roomNo===roomNo) || Store.rooms[0];
    if (!room) return;

    // Ensure memory store
    Store._meterMem = Store._meterMem || {};
    const mem = Store._meterMem[room.id] || (Store._meterMem[room.id] = { elecPrev: null, waterPrev: null, updatedAt: null });

    // Build UI
    const wrap = document.createElement('div');
    wrap.className = 'card';
    wrap.style.marginTop = '8px';
    wrap.innerHTML = `
      <h4 style="margin:0 0 6px 0">Baselines Memory</h4>
      <div class="ua-mini">Keeps last known <b>previous</b> meter baselines per room (local only).</div>

      <div class="ua-mem" style="margin-top:8px">
        <div class="field">
          <label>Electricity Prev (saved)</label>
          <input id="uaMemElec" type="number" step="0.01" placeholder="‚Äî" value="${mem.elecPrev ?? ''}">
        </div>
        <div class="field">
          <label>Water Prev (saved)</label>
          <input id="uaMemWater" type="number" step="0.01" placeholder="‚Äî" value="${mem.waterPrev ?? ''}">
        </div>
        <div class="field">
          <label>Updated</label>
          <input id="uaMemAt" readonly value="${mem.updatedAt ? new Date(mem.updatedAt).toLocaleString() : '‚Äî'}">
        </div>
      </div>

      <div class="ua-inline" style="margin-top:8px">
        <button class="btn slim" id="uaMemPrefill" data-tip="Copy saved baselines into the assistant‚Äôs Prev fields">Prefill from Memory</button>
        <button class="btn slim ghost" id="uaMemSave" data-tip="Manually save the numbers above as memory">Save Memory</button>
        <span class="ua-mini">‚Ä¢</span>
        <button class="btn slim" id="uaRollPrev" data-tip="Set Prev = Curr, then clear Curr">Roll Prev = Curr</button>
        <label class="ua-mini"><input id="uaAutoUpdate" type="checkbox" checked> Update memory on Save</label>
      </div>
    `;
    utilSection.appendChild(wrap);

    // Grab assistant fields from Part 16
    const els = {
      // Assistant I/O
      ePrev: utilSection.querySelector('#uaElecPrev'),
      eCurr: utilSection.querySelector('#uaElecCurr'),
      wPrev: utilSection.querySelector('#uaWaterPrev'),
      wCurr: utilSection.querySelector('#uaWaterCurr'),
      saveBtn: utilSection.querySelector('#uaSave'),
      // Memory fields
      mElec: wrap.querySelector('#uaMemElec'),
      mWater: wrap.querySelector('#uaMemWater'),
      mAt: wrap.querySelector('#uaMemAt'),
      prefill: wrap.querySelector('#uaMemPrefill'),
      saveMem: wrap.querySelector('#uaMemSave'),
      roll: wrap.querySelector('#uaRollPrev'),
      auto: wrap.querySelector('#uaAutoUpdate'),
    };

    function writeMem(elecPrev, waterPrev){
      Store._meterMem[room.id] = {
        elecPrev: isFiniteNum(elecPrev) ? Number(elecPrev) : null,
        waterPrev: isFiniteNum(waterPrev) ? Number(waterPrev) : null,
        updatedAt: Date.now(),
      };
      const m = Store._meterMem[room.id];
      els.mElec.value = m.elecPrev ?? '';
      els.mWater.value = m.waterPrev ?? '';
      els.mAt.value = m.updatedAt ? new Date(m.updatedAt).toLocaleString() : '‚Äî';
    }
    function isFiniteNum(v){ const n = Number(v); return Number.isFinite(n); }

    // Prefill: copy memory‚Üíassistant Prev fields (keep Curr untouched)
    els.prefill.addEventListener('click', ()=>{
      const m = Store._meterMem[room.id] || {};
      if (isFiniteNum(m.elecPrev)) els.ePrev.value = m.elecPrev;
      if (isFiniteNum(m.waterPrev)) els.wPrev.value = m.waterPrev;
      // Trigger recalculation from Part 16 (input listener)
      els.ePrev.dispatchEvent(new Event('input', { bubbles:true }));
      els.wPrev.dispatchEvent(new Event('input', { bubbles:true }));
      Toast.show('Prefilled from memory');
    });

    // Manual save for memory fields
    els.saveMem.addEventListener('click', ()=>{
      writeMem(els.mElec.value, els.mWater.value);
      Toast.show('Memory saved for room ' + (room.roomNo||''));
    });

    // Roll: set Prev = Curr, clear Curr
    els.roll.addEventListener('click', ()=>{
      if (isFiniteNum(els.eCurr.value)) els.ePrev.value = els.eCurr.value;
      if (isFiniteNum(els.wCurr.value)) els.wPrev.value = els.wCurr.value;
      els.eCurr.value = ''; els.wCurr.value = '';
      els.ePrev.dispatchEvent(new Event('input', { bubbles:true }));
      els.wPrev.dispatchEvent(new Event('input', { bubbles:true }));
      Toast.show('Rolled previous baselines');
    });

    // Hook Part 16 "Save to Room": optionally update memory
    els.saveBtn?.addEventListener('click', ()=>{
      if (!els.auto.checked) return;
      // If user entered Current meters, assume those become the new "Prev" next cycle
      const newElecPrev = isFiniteNum(els.eCurr.value) ? Number(els.eCurr.value)
                       : isFiniteNum(els.ePrev.value) ? Number(els.ePrev.value) : null;
      const newWaterPrev = isFiniteNum(els.wCurr.value) ? Number(els.wCurr.value)
                       : isFiniteNum(els.wPrev.value) ? Number(els.wPrev.value) : null;
      writeMem(newElecPrev, newWaterPrev);
      // Non-intrusive nudge
      Toast.show('Baselines memory updated');
    }, { once:false });

    // Convenience: if memory is empty, try to infer from closest month with usage
    if (!(isFiniteNum(mem.elecPrev) || isFiniteNum(mem.waterPrev))){
      const last = (room.utilities||[]).slice().sort((a,b)=> a.yyyymm.localeCompare(b.yyyymm)).pop();
      if (last){
        // We only have usage (kWh/m¬≥), not absolute meters‚Äîbest-effort: set memory to "previous + usage"
        // But without absolute previous we can't reconstruct; leave blank. Just provide a hint.
        const hint = document.createElement('div');
        hint.className = 'ua-mini';
        hint.textContent = `Last saved usage: kWh ${last.elecKwh ?? 0}, m¬≥ ${last.waterM3 ?? 0} (absolute meters unknown).`;
        wrap.appendChild(hint);
      }
    }
  });

  mo.observe(overlay, { attributes:true, attributeFilter:['class'], childList:true, subtree:true });
})();
</script>
<!-- ==== PART 17 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 18 START ================================================== -->
<style>
  /* ---------- Presets card ---------- */
  .presets-card .hint { color: var(--muted); font-size: 12px; }
  .presets-grid { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 1080px){ .presets-grid { grid-template-columns: 1fr; } }
  .preset-row { display:grid; gap:8px; grid-template-columns: 1fr 1fr auto; align-items:center; }
  .preset-row + .preset-row { margin-top: 6px; }
  .mini { font-size: 12px; color: var(--muted); }
  .diff-chip { display:inline-block; padding: 2px 8px; border:1px solid var(--border); border-radius:999px; margin-right:6px; }
  .btn.slim { padding:6px 10px; border-radius:10px; font-size:12px; }
</style>

<script>
/* ========================= PART 18 SCRIPT ========================= */

/* ------------------------------------------------------------------
   A) Settings ‚Üí Room-Rate Presets (per floor)
      - Define presets like "1xx ‚Üí 4500", "2xx ‚Üí 5000" or by prefix "1", "2"
      - Detect floors from current rooms
      - Preview matches and Apply (bulk update room.rate)
      - All in-memory; adds Store.ratePresets
------------------------------------------------------------------- */
(function injectRoomRatePresets(){
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    if (route === 'settings'){
      setTimeout(addPresetsCard, 0);
      setTimeout(wireSettingsDiffs, 0); // (B) diff toaster hooks
    }
    if (route === 'payments'){
      setTimeout(wirePaymentsDiffs, 0); // (B) diff toaster hooks
    }
  };

  function addPresetsCard(){
    const view = document.getElementById('view');
    if (!view) return;
    const grid = view.querySelector('.settings-grid');
    if (!grid || grid.querySelector('.presets-card')) return;

    Store.ratePresets = Store.ratePresets || []; // [{key:'1', rate:4500}]

    const card = document.createElement('div');
    card.className = 'card presets-card';
    card.innerHTML = `
      <h3 style="margin:0 0 6px 0">Room-Rate Presets (per floor)</h3>
      <div class="hint">Define simple floor prefixes (e.g., <b>1</b> for 1xx, <b>2</b> for 2xx) and apply rates to matching rooms. No backend; UI-only.</div>

      <div class="presets-grid" style="margin-top:10px">
        <section>
          <div class="mini" style="margin-bottom:6px">Presets</div>
          <div id="presetList"></div>
          <div class="preset-row" style="margin-top:8px">
            <div class="field"><label>Floor Prefix</label><input id="prKey" placeholder="e.g., 1"></div>
            <div class="field"><label>Rate (THB)</label><input id="prRate" type="number" step="1" min="0" placeholder="4500"></div>
            <button class="btn slim" id="prAdd">Add</button>
          </div>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn slim" id="prDetect">Detect Floors from Rooms</button>
            <button class="btn slim ghost" id="prClear">Clear Presets</button>
          </div>
        </section>

        <section>
          <div class="mini" style="margin-bottom:6px">Preview & Apply</div>
          <div class="field"><label>Dry Run Month</label><input id="prMonth" type="month" value="${monthKey()}"></div>
          <div id="prPreview" class="mini" style="margin-top:6px">No preview yet.</div>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" id="prRun">Preview Changes</button>
            <button class="btn" id="prApply">Apply to Rooms</button>
          </div>
        </section>
      </div>
    `;
    grid.appendChild(card);

    const els = {
      list: card.querySelector('#presetList'),
      key:  card.querySelector('#prKey'),
      rate: card.querySelector('#prRate'),
      add:  card.querySelector('#prAdd'),
      detect: card.querySelector('#prDetect'),
      clear: card.querySelector('#prClear'),
      month: card.querySelector('#prMonth'),
      preview: card.querySelector('#prPreview'),
      run: card.querySelector('#prRun'),
      apply: card.querySelector('#prApply'),
    };

    function renderList(){
      if (!Store.ratePresets.length){
        els.list.innerHTML = `<div class="mini">No presets yet.</div>`;
        return;
      }
      els.list.innerHTML = Store.ratePresets.map((p, i)=>`
        <div class="preset-row" data-i="${i}">
          <div class="field"><label>Prefix</label><input data-k="key" value="${p.key}"></div>
          <div class="field"><label>Rate</label><input data-k="rate" type="number" step="1" value="${p.rate}"></div>
          <button class="btn slim ghost" data-del="${i}">Delete</button>
        </div>
      `).join('');
    }
    renderList();

    els.list.addEventListener('input', (e)=>{
      const row = e.target.closest('.preset-row'); if (!row) return;
      const i = Number(row.dataset.i);
      const k = e.target.getAttribute('data-k');
      if (k==='key') Store.ratePresets[i].key = e.target.value.trim();
      if (k==='rate') Store.ratePresets[i].rate = Number(e.target.value||0);
    });
    els.list.addEventListener('click', (e)=>{
      const del = e.target.closest('[data-del]');
      if (del){
        const i = Number(del.getAttribute('data-del'));
        if (confirm('Delete this preset?')) Store.ratePresets.splice(i,1);
        renderList();
      }
    });

    els.add.addEventListener('click', ()=>{
      const key = (els.key.value||'').trim();
      const rate = Number(els.rate.value||0);
      if (!key || rate <= 0) return Toast.show('Prefix and positive rate required');
      Store.ratePresets.push({ key, rate });
      els.key.value = ''; els.rate.value = '';
      renderList(); Toast.show('Preset added');
    });

    els.detect.addEventListener('click', ()=>{
      const prefixes = new Set(Store.rooms.map(r=> String(r.roomNo||'').trim()[0]).filter(Boolean));
      const newOnes = [];
      prefixes.forEach(p=>{
        if (!Store.ratePresets.some(x=>x.key===p)){
          newOnes.push({ key:String(p), rate: Store.defaults.roomRate||0 });
        }
      });
      if (!newOnes.length) return Toast.show('All floors already present');
      Store.ratePresets.push(...newOnes);
      renderList(); Toast.show('Detected floor prefixes: ' + newOnes.map(x=>x.key).join(', '));
    });

    els.clear.addEventListener('click', ()=>{
      if (!Store.ratePresets.length) return;
      if (!confirm('Clear all presets?')) return;
      Store.ratePresets = [];
      renderList(); Toast.show('Cleared presets');
    });

    function computePreview(){
      const before = Store.rooms.map(r=>({ id:r.id, roomNo:r.roomNo, rate:r.rate }));
      const suggestions = [];
      Store.rooms.forEach(r=>{
        const floor = String(r.roomNo||'').trim()[0] || '';
        const preset = Store.ratePresets.find(p=> p.key === floor);
        if (!preset) return;
        if (Number(r.rate) !== Number(preset.rate)){
          suggestions.push({
            roomNo: r.roomNo,
            from: Number(r.rate||0),
            to: Number(preset.rate||0),
            delta: Number(preset.rate||0) - Number(r.rate||0)
          });
        }
      });
      const totalDelta = suggestions.reduce((a,b)=>a+b.delta,0);
      return { suggestions, totalDelta, count: suggestions.length, before };
    }

    els.run.addEventListener('click', ()=>{
      const pv = computePreview();
      if (!pv.count){
        els.preview.innerHTML = `<span class="diff-chip">0 rooms</span>Nothing to change.`;
        return;
      }
      const sample = pv.suggestions.slice(0, 6).map(s=>`${s.roomNo}: ${currency(s.from)} ‚Üí ${currency(s.to)}`).join(' ¬∑ ');
      els.preview.innerHTML = `
        <span class="diff-chip">${pv.count} room(s)</span>
        Total Œî ${currency(pv.totalDelta)} ¬∑ ${sample}${pv.suggestions.length>6?' ¬∑ ‚Ä¶':''}
      `;
    });

    els.apply.addEventListener('click', ()=>{
      const pv = computePreview();
      if (!pv.count) return Toast.show('Nothing to apply');
      pv.suggestions.forEach(s=>{
        const room = Store.rooms.find(r=>r.roomNo===s.roomNo);
        if (room) room.rate = s.to;
      });
      Toast.show(`Applied presets to ${pv.count} rooms ¬∑ Œî ${currency(pv.totalDelta)}`);
      els.run.click();
      // Nudge other views that display rates
      if (['rooms','payments','builder'].includes(Router.current)){
        const r = Router.current; Router.navigate(r);
      }
    });
  }

  /* ------------------------------------------------------------------
     B) Diff Toaster for bulk Payments & Settings saves
        - Track snapshot of relevant store slices
        - When user clicks bulk buttons (#bulkSent/#bulkPaid/#bulkAssignBank) or
          settings saves (#stSave1/#stSave2), show a concise diff summary
  ------------------------------------------------------------------- */
  function makeSnapshot(){
    return {
      invoices: Store.invoices.map(i=>({ id:i.id, status:i.status, roomId:i.roomId })),
      rooms: Store.rooms.map(r=>({ id:r.id, roomNo:r.roomNo, payMethodId:r.payMethodId, rate:r.rate })),
      utilities: JSON.parse(JSON.stringify(Store.utilities||{})),
      defaults: JSON.parse(JSON.stringify(Store.defaults||{})),
      terms: Store.terms, dueDays: Store.dueDays
    };
  }
  function diffInvoices(a,b){
    const byId = Object.fromEntries(a.invoices.map(x=>[x.id,x]));
    const changes = [];
    b.invoices.forEach(x=>{
      const prev = byId[x.id]; if (!prev) return;
      if (prev.status !== x.status) changes.push({ id:x.id, k:'status', from:prev.status, to:x.status });
    });
    return changes;
  }
  function diffRooms(a,b){
    const byId = Object.fromEntries(a.rooms.map(x=>[x.id,x]));
    const bank = []; const rate = [];
    b.rooms.forEach(x=>{
      const prev = byId[x.id]; if (!prev) return;
      if (prev.payMethodId !== x.payMethodId) bank.push({ roomNo:x.roomNo, from:prev.payMethodId, to:x.payMethodId });
      if (Number(prev.rate) !== Number(x.rate)) rate.push({ roomNo:x.roomNo, from:prev.rate, to:x.rate });
    });
    return { bank, rate };
  }
  function summarizeRoomBank(changes){
    if (!changes.length) return '';
    const mapIdToStr = id=> Store.bankAccounts.find(b=>b.id===id) ? (Store.bankAccounts.find(b=>b.id===id).bank+' '+Store.bankAccounts.find(b=>b.id===id).acct) : (id||'‚Äî');
    const sample = changes.slice(0,4).map(c=>`${c.roomNo}: ${mapIdToStr(c.from)} ‚Üí ${mapIdToStr(c.to)}`).join(' ¬∑ ');
    return `${changes.length} bank change(s)${changes.length>4?' ¬∑ ‚Ä¶':''}${sample? ' ¬∑ '+sample : ''}`;
  }
  function wirePaymentsDiffs(){
    const view = document.getElementById('view'); if (!view) return;
    const sent = view.querySelector('#bulkSent');
    const paid = view.querySelector('#bulkPaid');
    const assign = view.querySelector('#bulkAssignBank');
    const btns = [sent, paid, assign].filter(Boolean);
    if (!btns.length) return;

    btns.forEach(btn=>{
      if (btn._diffWired) return;
      btn._diffWired = true;
      btn.addEventListener('click', ()=>{
        const snap = makeSnapshot();
        // Wait a tick for Part 13 to mutate Store
        setTimeout(()=>{
          const now = makeSnapshot();
          const invDiffs = diffInvoices(snap, now);
          const roomDiffs = diffRooms(snap, now);
          const parts = [];
          if (invDiffs.length){
            const statusGroups = invDiffs.reduce((m,c)=>{ m[c.to]=(m[c.to]||0)+1; return m; },{});
            const msg = Object.entries(statusGroups).map(([st,n])=>`${n} ${st}`).join(', ');
            parts.push(`Invoices: ${msg}`);
          }
          const bankMsg = summarizeRoomBank(roomDiffs.bank);
          if (bankMsg) parts.push(bankMsg);
          if (roomDiffs.rate.length){
            const totalŒî = roomDiffs.rate.reduce((a,c)=>a + (Number(c.to)-Number(c.from)), 0);
            parts.push(`Rates changed: ${roomDiffs.rate.length} ¬∑ Œî ${currency(totalŒî)}`);
          }
          if (parts.length) Toast.show(parts.join(' ¬∑ '));
        }, 50);
      });
    });
  }
  function wireSettingsDiffs(){
    const view = document.getElementById('view'); if (!view) return;
    const s1 = view.querySelector('#stSave1');
    const s2 = view.querySelector('#stSave2');
    [s1,s2].forEach(btn=>{
      if (!btn) return;
      if (btn._diffWired) return;
      btn._diffWired = true;
      btn.addEventListener('click', ()=>{
        const snap = makeSnapshot();
        setTimeout(()=>{
          const now = makeSnapshot();
          const parts = [];
          // utilities changes
          const uA = snap.utilities, uB = now.utilities;
          if (uA.elecRate !== uB.elecRate) parts.push(`Elec ${uA.elecRate}‚Üí${uB.elecRate}`);
          if (uA.waterRate !== uB.waterRate) parts.push(`Water ${uA.waterRate}‚Üí${uB.waterRate}`);
          // defaults / policies
          const dA = snap.defaults, dB = now.defaults;
          if (dA.roomRate !== dB.roomRate) parts.push(`Default rate ${currency(dA.roomRate)}‚Üí${currency(dB.roomRate)}`);
          if (dA.lateFee?.type !== dB.lateFee?.type || dA.lateFee?.value !== dB.lateFee?.value){
            parts.push(`Late fee ${dA.lateFee?.type||'?'} ${dA.lateFee?.value||0} ‚Üí ${dB.lateFee?.type||'?'} ${dB.lateFee?.value||0}`);
          }
          if (snap.terms !== now.terms) parts.push(`Terms ${snap.terms}‚Üí${now.terms}`);
          if (snap.dueDays !== now.dueDays) parts.push(`DueDays ${snap.dueDays}‚Üí${now.dueDays}`);
          // room rate changes (from presets or manual)
          const { rate } = diffRooms(snap, now);
          if (rate.length){
            const totalŒî = rate.reduce((a,c)=>a + (Number(c.to)-Number(c.from)), 0);
            parts.push(`Room rates: ${rate.length} changed ¬∑ Œî ${currency(totalŒî)}`);
          }
          if (parts.length) Toast.show(parts.join(' ¬∑ '));
        }, 50);
      });
    });
  }

})();
</script>
<!-- ==== PART 18 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 19 START ================================================== -->
<style>
  /* Sidebar address switcher */
  .addr-switch {
    margin-top: 8px;
    display: grid; gap: 6px;
  }
  .addr-switch label { font-size: 12px; color: var(--muted); }
  .addr-switch select {
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--panel);
    color: var(--text);
    padding: 8px 10px;
  }

  /* Tiny ‚Äúfiltered by ‚Ä¶‚Äù chip in views */
  .addr-chip {
    display:inline-block; padding: 2px 8px;
    border: 1px solid var(--border); border-radius:999px;
    font-size: 12px; margin-left: 6px;
  }

  /* Sidebar badge for reminders */
  .nav-badge {
    display:inline-block; margin-left:auto;
    padding: 2px 8px; border-radius:999px;
    font-size: 11px; line-height: 1;
    background: rgba(239,68,68,.12);
    color: #991b1b; border: 1px solid rgba(239,68,68,.35);
  }
  .nav-badge.green {
    background: rgba(16,185,129,.12);
    color: #065f46; border-color: rgba(16,185,129,.35);
  }

  /* Hide helper */
  .hidden { display:none !important; }
</style>

<script>
/* ========================= PART 19 SCRIPT ========================= */

/* Overview
   - Adds a "Building" selector to the sidebar; persists to localStorage.
   - Ensures each room has room.addrId (defaults to first address).
   - Filters Rooms and Payments views to the selected building.
   - Smart Reminders: computes overdue for current month (based on dueDays / terms)
     and shows a badge on the sidebar "Payments" link.
*/

/* ---------- A) Bootstrapping room.addrId mapping ---------- */
(function ensureRoomAddressMapping(){
  if (!Store.addresses || !Store.addresses.length) return;
  const def = Store.addresses[0].id;
  Store.rooms.forEach(r=>{
    if (!r.addrId) r.addrId = def; // default building
  });
})();

/* ---------- B) Sidebar Address Switcher ---------- */
(function injectAddressSwitcher(){
  const sidebar = document.querySelector('.sidebar');
  if (!sidebar || sidebar.querySelector('#addrSwitch')) return;

  const wrap = document.createElement('div');
  wrap.className = 'addr-switch';
  wrap.innerHTML = `
    <label for="addrSwitch">Building</label>
    <select id="addrSwitch" aria-label="Filter by building">
      <option value="">All buildings</option>
      ${Store.addresses.map(a=>`<option value="${a.id}">${a.name}</option>`).join('')}
    </select>
  `;
  // Place just under the global search if present; else below nav
  const anchor = sidebar.querySelector('#globalSearch')?.closest('.field')
               || sidebar.querySelector('nav')
               || sidebar.firstElementChild;
  anchor.insertAdjacentElement('afterend', wrap);

  // Restore selection
  const saved = localStorage.getItem('addrFilter') || '';
  wrap.querySelector('#addrSwitch').value = saved;

  // On change -> persist and repaint
  wrap.querySelector('#addrSwitch').addEventListener('change', (e)=>{
    const val = e.target.value;
    localStorage.setItem('addrFilter', val);
    Store._addrFilter = val || '';
    repaintCurrentFiltered();
    paintRemindersBadge(); // in case counts change with filter
  });

  // Initialize Store state and first paint
  Store._addrFilter = saved || '';
  repaintCurrentFiltered();
  paintRemindersBadge();

  // Repaint on route changes & occasional heartbeat
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    setTimeout(()=>{ repaintCurrentFiltered(); paintRemindersBadge(); }, 0);
  };
  // Gentle heartbeat to keep badge fresh (once per minute)
  setInterval(paintRemindersBadge, 60_000);
})();

/* ---------- C) Apply building filter to Rooms & Payments ---------- */
function activeAddress(){
  return Store._addrFilter || localStorage.getItem('addrFilter') || '';
}
function repaintCurrentFiltered(){
  const route = Router.current;
  if (!route) return;
  if (route === 'rooms') applyFilterToRooms();
  if (route === 'payments') applyFilterToPayments();
}

function applyFilterToRooms(){
  const view = document.getElementById('view'); if (!view) return;
  const grid = view.querySelector('.floor, .rooms-grid, .rooms-list, .grid'); // heuristic
  const cards = view.querySelectorAll('.card, .room-card');

  // Chip in toolbar/top card
  paintFilterChip(view);

  const addr = activeAddress();
  if (!addr){
    // Show all
    cards.forEach(c=> c.classList.remove('hidden'));
    return;
  }
  // Hide cards whose room.addrId != addr
  cards.forEach(card=>{
    const label = card.querySelector('header strong')?.textContent?.trim();
    const room = Store.rooms.find(r=>r.roomNo===label);
    if (!room) return;
    if (room.addrId !== addr) card.classList.add('hidden');
    else card.classList.remove('hidden');
  });
}

function applyFilterToPayments(){
  const view = document.getElementById('view'); if (!view) return;
  const grid = view.querySelector('.payments-grid') || view.querySelector('.grid');
  const cards = grid ? grid.querySelectorAll('.pay-card, .card') : [];

  paintFilterChip(view);

  const addr = activeAddress();
  if (!addr){
    cards.forEach(c=> c.classList.remove('hidden'));
    return;
  }
  cards.forEach(card=>{
    const roomNo = card.querySelector('header strong')?.textContent?.trim();
    const room = Store.rooms.find(r=>r.roomNo===roomNo);
    if (!room) return;
    if (room.addrId !== addr) card.classList.add('hidden');
    else card.classList.remove('hidden');
  });
}

function paintFilterChip(view){
  // Put a ‚ÄúFiltered by ‚Ä¶‚Äù chip inside the first card/tool row if a filter is active
  const addr = activeAddress();
  const card = view.querySelector('.card'); if (!card) return;
  let chip = card.querySelector('.addr-chip');
  if (!addr){
    chip?.remove();
    return;
  }
  const a = Store.addresses.find(x=>x.id===addr);
  if (!chip){
    chip = document.createElement('span');
    chip.className = 'addr-chip';
    card.appendChild(chip);
  }
  chip.textContent = `Filtered: ${a ? a.name : '‚Äî'}`;
}

/* ---------- D) Simple Assignment Helper (optional) ----------
   Allow assigning a building to rooms from Rooms overlay ‚Üí "Payment Method" tab.
   We add a tiny dropdown if we find that tab in the room overlay.
*/
(function augmentRoomOverlayForAddress(){
  const overlay = document.getElementById('overlay');
  if (!overlay) return;
  const mo = new MutationObserver(()=>{
    if (!overlay.classList.contains('open')) return;
    const body = overlay.querySelector('#sheetBody');
    if (!body) return;

    // Heuristic: Payment Method (Per Room) tab card
    const payCard = Array.from(body.querySelectorAll('h3,h4')).find(h=>/payment method/i.test(h.textContent||''))?.closest('.card');
    if (!payCard || payCard._addrWired) return;
    payCard._addrWired = true;

    // Identify room
    const header = body.querySelector('h3')?.textContent || '';
    const roomNo = header.split('¬∑')[0].trim();
    const room = Store.rooms.find(r=>r.roomNo===roomNo); if (!room) return;

    const row = document.createElement('div');
    row.className = 'form-row';
    row.innerHTML = `
      <div class="field">
        <label>Building (for filters)</label>
        <select id="roomAddrSel">
          ${Store.addresses.map(a=>`<option value="${a.id}" ${room.addrId===a.id?'selected':''}>${a.name}</option>`).join('')}
        </select>
        <small class="subtle">Used only for UI filters & report grouping.</small>
      </div>
    `;
    payCard.appendChild(row);
    row.querySelector('#roomAddrSel').addEventListener('change', (e)=>{
      room.addrId = e.target.value;
      Toast.show(`Room ${room.roomNo} assigned to ${Store.addresses.find(a=>a.id===room.addrId)?.name || '‚Äî'}`);
      repaintCurrentFiltered();
      paintRemindersBadge();
    });
  });
  mo.observe(overlay, { attributes:true, attributeFilter:['class'], childList:true, subtree:true });
})();

/* ---------- E) Smart Reminders badge on Payments ---------- */
function paintRemindersBadge(){
  // Find Payments nav button
  const navBtn = document.querySelector('[data-route="payments"]');
  if (!navBtn) return;
  // Ensure badge exists
  let badge = navBtn.querySelector('.nav-badge');
  if (!badge){
    badge = document.createElement('span');
    badge.className = 'nav-badge';
    navBtn.appendChild(badge);
  }
  // Compute overdue for current month (filtered by building if selected)
  const overdue = computeOverdueCount();
  if (overdue.total === 0){
    badge.textContent = '0';
    badge.classList.add('green');
    badge.title = 'No overdue items';
  } else {
    badge.textContent = String(overdue.total);
    badge.classList.remove('green');
    badge.title = `Overdue: ${overdue.total} (${overdue.byBuilding})`;
  }
}

function computeOverdueCount(){
  const month = monthKey();
  const days = Number(Store.dueDays || Store.terms || 7);
  const today = new Date(Store.now || Date.now());
  const activeAddr = activeAddress();
  let total = 0;
  let byBuilding = '';

  // Helper to compute due date from invoice month + dueDays (1st + days)
  const dueDateOf = (ym)=>{
    const d = new Date(ym + '-01T00:00:00');
    d.setDate(d.getDate() + days);
    return d;
  };

  const groups = {}; // name -> count
  Store.invoices.forEach(inv=>{
    if (inv.yyyymm !== month) return;
    const room = Store.rooms.find(r=>r.id===inv.roomId);
    if (!room) return;
    if (activeAddr && room.addrId !== activeAddr) return;
    const due = dueDateOf(inv.yyyymm);
    const isOverdue = (today > due) && inv.status !== 'paid';
    if (isOverdue){
      total++;
      const aname = Store.addresses.find(a=>a.id===room.addrId)?.name || '‚Äî';
      groups[aname] = (groups[aname]||0) + 1;
    }
  });
  byBuilding = Object.entries(groups).map(([k,v])=>`${k}:${v}`).join(', ');

  return { total, byBuilding };
}
</script>
<!-- ==== PART 19 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 20 START ================================================== -->
<style>
  /* ---- Kanban layout ---- */
  .kanban {
    display:grid; gap:12px;
    grid-template-columns: repeat(3, 1fr);
  }
  @media (max-width: 1100px){ .kanban { grid-template-columns: 1fr; } }

  .kb-col {
    background: var(--panel); border:1px solid var(--border);
    border-radius: var(--radius); box-shadow: var(--shadow);
    padding: 10px; min-height: 260px;
  }
  .kb-head {
    display:flex; justify-content:space-between; align-items:center; gap:8px;
    margin-bottom: 8px;
  }
  .kb-head h3 { margin:0; font-size: 14px; letter-spacing:.02em; }
  .kb-count { font-size:12px; color: var(--muted); }
  .kb-drop {
    border:2px dashed transparent; border-radius:10px; padding:4px;
    transition: border-color .15s ease;
  }
  .kb-drop.dragover {
    border-color: var(--accent, #6366f1);
    background: rgba(99,102,241,.06);
  }

  /* ---- Cards ---- */
  .kb-card {
    background: var(--base); border:1px solid var(--border);
    border-radius: 12px; padding: 10px; margin-bottom: 8px;
    cursor: grab;
  }
  .kb-title { font-weight:700; margin:0 0 4px 0; }
  .kb-meta { display:flex; gap:6px; flex-wrap:wrap; align-items:center; font-size:12px; }
  .pill.pri-low { background: rgba(16,185,129,.12); color:#065f46; border-color: rgba(16,185,129,.35); }
  .pill.pri-med { background: rgba(245,158,11,.12); color:#92400e; border-color: rgba(245,158,11,.35); }
  .pill.pri-high{ background: rgba(239,68,68,.12);  color:#991b1b; border-color: rgba(239,68,68,.35); }
  .kb-actions { display:flex; gap:6px; margin-top:6px; }
  .btn.xs { padding:6px 10px; border-radius:10px; font-size:12px; }

  /* Toolbar */
  .kb-toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom: 10px; }
  .kb-toolbar .field input, .kb-toolbar .field select { padding: 8px 10px; }

  /* Empty state */
  .kb-empty {
    border:1px dashed var(--border); border-radius:12px; padding:20px; text-align:center; color: var(--muted);
  }
</style>

<script>
/* ========================= PART 20 SCRIPT ========================= */

/* Adds a "Maintenance" route with a Kanban board:
   Columns: todo ‚Üí doing ‚Üí done
   Task: { id, title, desc, addrId, roomId, priority: 'low'|'med'|'high', due: 'YYYY-MM-DD', assignee, status }
   Respects building filter from Part 19 (activeAddress()).
*/

/* ---------- Boot seed & nav item ---------- */
(function initMaintenanceRoute(){
  Store.maint = Store.maint || { tasks: seedMaintTasksIfEmpty() };

  // Add nav button if missing
  const nav = document.querySelector('.sidebar nav');
  if (nav && !nav.querySelector('[data-route="maintenance"]')){
    const btn = document.createElement('button');
    btn.setAttribute('data-route','maintenance');
    btn.textContent = 'üõ†Ô∏è Maintenance';
    nav.appendChild(btn);
    btn.addEventListener('click', ()=> Router.navigate('maintenance'));
  }

  // Register view
  Views.maintenance = paintMaintenanceView;

  // Keyboard: "N" creates a task on this view
  document.addEventListener('keydown', (e)=>{
    if (Router.current!=='maintenance') return;
    if (e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
    if (e.key.toLowerCase()==='n'){ e.preventDefault(); openTaskEditor(); }
  });
})();

function seedMaintTasksIfEmpty(){
  if (Store?.maint?.tasks?.length) return Store.maint.tasks;
  const addr = (Store.addresses[0]?.id)||null;
  return [
    { id: uid(), title:'Fix leaky faucet', desc:'Room 105 bathroom sink', addrId: addr, roomId: (Store.rooms.find(r=>r.roomNo==='105')?.id)||null, priority:'med', due: addDaysISO(2), assignee:'Somchai', status:'todo' },
    { id: uid(), title:'AC filter change', desc:'Room 112 quarterly filter', addrId: addr, roomId: (Store.rooms.find(r=>r.roomNo==='112')?.id)||null, priority:'low', due: addDaysISO(7), assignee:'Pin', status:'doing' },
    { id: uid(), title:'Paint touch-up', desc:'Lobby scuffs near elevator', addrId: addr, roomId: null, priority:'low', due: addDaysISO(10), assignee:'N/A', status:'todo' },
    { id: uid(), title:'Replace light', desc:'Stairwell 2F bulb out', addrId: addr, roomId: null, priority:'high', due: addDaysISO(1), assignee:'Art', status:'doing' },
  ];
}

/* ---------- View painter ---------- */
function paintMaintenanceView(){
  const host = document.getElementById('view');
  host.innerHTML = '';

  const toolbar = document.createElement('div');
  toolbar.className = 'kb-toolbar card';
  toolbar.innerHTML = `
    <div class="field"><label>Search</label><input id="kbSearch" placeholder="title, desc, room, assignee"></div>
    <div class="field">
      <label>Priority</label>
      <select id="kbPri">
        <option value="">All</option>
        <option value="low">Low</option>
        <option value="med">Medium</option>
        <option value="high">High</option>
      </select>
    </div>
    <div class="field">
      <label>Assignee</label>
      <input id="kbWho" placeholder="e.g., Somchai">
    </div>
    <button class="btn" id="kbNew" data-tip="N">New Task</button>
    <button class="btn ghost" id="kbExport">Export CSV</button>
  `;
  host.appendChild(toolbar);

  const wrap = document.createElement('div');
  wrap.className = 'kanban';
  wrap.innerHTML = `
    ${kbColumn('todo','To Do')}
    ${kbColumn('doing','In Progress')}
    ${kbColumn('done','Done')}
  `;
  host.appendChild(wrap);

  // chip for address filter, if any (from Part 19)
  const addr = (typeof activeAddress==='function') ? activeAddress() : '';
  if (addr){
    const a = Store.addresses.find(x=>x.id===addr);
    const chip = document.createElement('span');
    chip.className = 'addr-chip';
    chip.textContent = `Filtered: ${a ? a.name : '‚Äî'}`;
    toolbar.appendChild(chip);
  }

  // Wire filters
  toolbar.querySelector('#kbNew').addEventListener('click', ()=> openTaskEditor());
  toolbar.querySelector('#kbExport').addEventListener('click', ()=> downloadCSV('maintenance.csv', toCSV(Store.maint.tasks)));
  ['kbSearch','kbPri','kbWho'].forEach(id=>{
    toolbar.querySelector('#'+id).addEventListener('input', repaintBoard);
  });

  // First paint
  repaintBoard();

  /* ---- helpers ---- */
  function kbColumn(key,label){
    return `
      <section class="kb-col" data-col="${key}">
        <div class="kb-head">
          <h3>${label}</h3>
          <span class="kb-count" data-count="${key}">0</span>
        </div>
        <div class="kb-drop" data-drop="${key}" aria-label="Drop tasks here"></div>
      </section>
    `;
  }

  function matchFilters(t){
    const s = toolbar.querySelector('#kbSearch').value.toLowerCase().trim();
    const p = toolbar.querySelector('#kbPri').value;
    const w = toolbar.querySelector('#kbWho').value.toLowerCase().trim();
    const addrSel = (typeof activeAddress==='function') ? activeAddress() : '';
    if (addrSel && t.addrId !== addrSel) return false;
    if (p && t.priority!==p) return false;
    if (s){
      const roomNo = t.roomId ? (Store.rooms.find(r=>r.id===t.roomId)?.roomNo || '') : '';
      const hay = [t.title, t.desc, t.assignee, roomNo].join(' ').toLowerCase();
      if (!hay.includes(s)) return false;
    }
    if (w && !(t.assignee||'').toLowerCase().includes(w)) return false;
    return true;
  }

  function repaintBoard(){
    const drops = wrap.querySelectorAll('[data-drop]');
    drops.forEach(d=> d.innerHTML = ''); // clear
    const byCol = { todo:0, doing:0, done:0 };
    Store.maint.tasks.forEach(t=>{
      if (!matchFilters(t)) return;
      const node = renderCard(t);
      const drop = wrap.querySelector(`[data-drop="${t.status}"]`);
      if (drop){ drop.appendChild(node); byCol[t.status]++; }
    });
    ['todo','doing','done'].forEach(k=>{
      const c = wrap.querySelector(`[data-count="${k}"]`);
      if (c) c.textContent = `${byCol[k]} task${byCol[k]!==1?'s':''}`;
      const container = wrap.querySelector(`[data-drop="${k}"]`);
      if (container && !container.children.length){
        const empty = document.createElement('div');
        empty.className = 'kb-empty';
        empty.textContent = 'No tasks here.';
        container.appendChild(empty);
      }
    });
    enableDnD();
  }

  function renderCard(t){
    const roomNo = t.roomId ? (Store.rooms.find(r=>r.id===t.roomId)?.roomNo || '') : '';
    const aName = Store.addresses.find(a=>a.id===t.addrId)?.name || '‚Äî';
    const due = t.due ? new Date(t.due).toISOString().slice(0,10) : '';
    const overdue = t.due && (new Date(t.due) < new Date(new Date().toISOString().slice(0,10)));
    const card = document.createElement('article');
    card.className = 'kb-card';
    card.setAttribute('draggable','true');
    card.dataset.id = t.id;
    card.innerHTML = `
      <h4 class="kb-title">${escapeHTML(t.title)}</h4>
      <div class="kb-meta">
        ${roomNo ? `<span class="pill">${roomNo}</span>`:``}
        <span class="pill ${priClass(t.priority)}">${t.priority||'low'}</span>
        ${due ? `<span class="pill ${overdue?'red':''}">Due ${due}${overdue?' (overdue)':''}</span>`:``}
        <span class="pill">${escapeHTML(t.assignee||'Unassigned')}</span>
        <span class="pill">${escapeHTML(aName)}</span>
      </div>
      ${t.desc ? `<div class="subtle" style="margin-top:6px">${escapeHTML(t.desc)}</div>`:''}
      <div class="kb-actions">
        <button class="btn xs" data-edit>Edit</button>
        <button class="btn xs ghost" data-del>Delete</button>
        ${t.status!=='done'?`<button class="btn xs" data-done>Mark Done</button>`:''}
      </div>
    `;
    // actions
    card.querySelector('[data-edit]').addEventListener('click', ()=> openTaskEditor(t));
    card.querySelector('[data-del]').addEventListener('click', ()=>{
      if (!confirm('Delete this task?')) return;
      const i = Store.maint.tasks.findIndex(x=>x.id===t.id);
      if (i>=0){ Store.maint.tasks.splice(i,1); repaintBoard(); Toast.show('Deleted'); }
    });
    card.querySelector('[data-done]')?.addEventListener('click', ()=>{
      t.status = 'done'; repaintBoard(); Toast.show('Marked done');
    });
    return card;
  }

  function priClass(p){ return p==='high'?'pri-high': p==='med'?'pri-med':'pri-low'; }

  function enableDnD(){
    wrap.querySelectorAll('.kb-card').forEach(card=>{
      card.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', card.dataset.id);
        setTimeout(()=> card.style.opacity='.5', 0);
      });
      card.addEventListener('dragend', ()=> card.style.opacity='1');
    });
    wrap.querySelectorAll('.kb-drop').forEach(drop=>{
      drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
      drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
      drop.addEventListener('drop', e=>{
        e.preventDefault(); drop.classList.remove('dragover');
        const id = e.dataTransfer.getData('text/plain');
        const task = Store.maint.tasks.find(x=>x.id===id);
        if (task){
          task.status = drop.dataset.drop;
          repaintBoard();
          Toast.show(`Moved to ${drop.dataset.drop}`);
        }
      });
    });
  }
}

/* ---------- Task editor ---------- */
function openTaskEditor(task=null){
  const addrSel = (typeof activeAddress==='function') ? activeAddress() : '';
  const defaults = {
    title:'', desc:'', addrId: addrSel || (Store.addresses[0]?.id)||null,
    roomId: null, priority: 'med', due: new Date().toISOString().slice(0,10),
    assignee:'', status: task?.status || 'todo'
  };
  const t = task ? {...task} : defaults;

  const node = document.createElement('div');
  node.innerHTML = `
    <div class="form-row">
      <div class="field"><label>Title</label><input id="tTitle" value="${escapeHTML(t.title)}" placeholder="e.g., Replace shower head"></div>
      <div class="field"><label>Priority</label>
        <select id="tPri">
          <option value="low" ${t.priority==='low'?'selected':''}>Low</option>
          <option value="med" ${t.priority==='med'?'selected':''}>Medium</option>
          <option value="high" ${t.priority==='high'?'selected':''}>High</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="field"><label>Building</label>
        <select id="tAddr">
          ${Store.addresses.map(a=>`<option value="${a.id}" ${t.addrId===a.id?'selected':''}>${a.name}</option>`).join('')}
        </select>
      </div>
      <div class="field"><label>Room (optional)</label>
        <select id="tRoom">
          <option value="">‚Äî none ‚Äî</option>
          ${Store.rooms.map(r=>`<option value="${r.id}" ${t.roomId===r.id?'selected':''}>${r.roomNo} ${r.renterId? '¬∑ '+(Store.renters.find(x=>x.id===r.renterId)?.name||''):''}</option>`).join('')}
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="field"><label>Assignee</label><input id="tWho" value="${escapeHTML(t.assignee||'')}" placeholder="e.g., Somchai"></div>
      <div class="field"><label>Due Date</label><input id="tDue" type="date" value="${t.due||''}"></div>
    </div>
    <div class="field"><label>Description</label><textarea id="tDesc" rows="4" placeholder="Details, materials, steps‚Ä¶">${escapeHTML(t.desc||'')}</textarea></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
      <button class="btn" id="tSave">${task?'Save':'Create Task'}</button>
      ${task?'<button class="btn ghost" id="tDup">Duplicate</button>':''}
      <button class="btn ghost" id="tCancel">Cancel</button>
    </div>
  `;
  openOverlay(task?'Edit Task':'New Task', node);
  node.querySelector('#tCancel').addEventListener('click', closeOverlay);
  node.querySelector('#tDup')?.addEventListener('click', ()=>{
    const copy = {...t, id: uid(), title: t.title + ' (copy)'};
    Store.maint.tasks.push(copy);
    closeOverlay(); if (Router.current==='maintenance') Views.maintenance();
    Toast.show('Duplicated task');
  });
  node.querySelector('#tSave').addEventListener('click', ()=>{
    const fields = {
      title: val('#tTitle'), priority: val('#tPri'),
      addrId: sel('#tAddr'), roomId: sel('#tRoom')||null,
      assignee: val('#tWho'), due: val('#tDue'),
      desc: val('#tDesc')
    };
    if (!fields.title.trim()) return Toast.show('Title is required');
    if (task){
      Object.assign(task, fields);
    } else {
      Store.maint.tasks.push({ id: uid(), status:'todo', ...fields });
    }
    closeOverlay();
    if (Router.current==='maintenance') Views.maintenance();
    Toast.show(task?'Saved':'Created');
  });

  function val(s){ const el=node.querySelector(s); return el? el.value : ''; }
  function sel(s){ const el=node.querySelector(s); return el && el.value ? el.value : ''; }
}

/* ---------- CSV export ---------- */
function toCSV(tasks){
  const head = ['id','title','desc','building','roomNo','priority','due','assignee','status'];
  const rows = tasks.map(t=>{
    const roomNo = t.roomId ? (Store.rooms.find(r=>r.id===t.roomId)?.roomNo || '') : '';
    const b = Store.addresses.find(a=>a.id===t.addrId)?.name || '';
    return [t.id, t.title, t.desc||'', b, roomNo, t.priority, t.due||'', t.assignee||'', t.status];
  });
  return [head, ...rows].map(r=> r.map(v=>{
    const s = String(v ?? '');
    return (s.includes(',') || s.includes('"') || /\r|\n/.test(s)) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')).join('\n');
}
function downloadCSV(filename, csv){
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ---------- Tiny utils ---------- */
function uid(){ return 't'+Math.random().toString(36).slice(2,9); }
function addDaysISO(n){ const d=new Date(); d.setDate(d.getDate()+Number(n||0)); return d.toISOString().slice(0,10); }
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
</script>
<!-- ==== PART 20 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 21 START ================================================== -->
<style>
  /* ---- Tiny gallery inside kanban cards ---- */
  .kb-gallery {
    margin-top: 6px; display:flex; gap:6px; flex-wrap:wrap;
  }
  .kb-thumb {
    width: 48px; height: 48px; border-radius: 8px;
    border:1px solid var(--border); overflow:hidden; cursor:pointer;
    background: #0001; display:inline-flex; align-items:center; justify-content:center;
  }
  .kb-thumb img { width:100%; height:100%; object-fit: cover; display:block; }
  .kb-thumb .badge {
    position:absolute; transform: translate(26px,-10px);
    background: rgba(0,0,0,.7); color:#fff; font-size:10px; padding:1px 4px; border-radius:6px;
  }

  /* ---- Attachment manager overlay ---- */
  .att-wrap { display:grid; gap:10px; }
  .att-grid { display:grid; gap:10px; grid-template-columns: 220px 1fr; }
  @media (max-width: 900px){ .att-grid { grid-template-columns: 1fr; } }
  .att-uploader {
    border: 1px dashed var(--border); border-radius: 12px; padding: 10px;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,0.03));
  }
  .att-uploader.dragover { border-color: var(--accent, #6366f1); background: rgba(99,102,241,.06); }
  .att-list { display:grid; gap:8px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
  .att-card {
    border:1px solid var(--border); border-radius:12px; overflow:hidden; background: var(--panel);
  }
  .att-card img { width:100%; height:120px; object-fit:cover; display:block; }
  .att-meta { padding:8px; font-size:12px; display:grid; gap:4px; }
  .att-actions { display:flex; gap:6px; }
  .btn.xs { padding:6px 10px; border-radius:10px; font-size:12px; }

  /* ---- Lightbox ---- */
  .lightbox {
    position: fixed; inset:0; background: rgba(0,0,0,.75);
    display:flex; align-items:center; justify-content:center; z-index: 9999;
  }
  .lightbox img { max-width: 90vw; max-height: 85vh; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,.5); }
  .lightbox .bar {
    position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,.6); color: #fff; padding: 6px 10px; border-radius: 999px; font-size: 12px;
  }
</style>

<script>
/* ========================= PART 21 SCRIPT ========================= */

/* Summary
   - Store.files is the single source of truth for files: {id, name, dataUrl, type, tags, taskId, createdAt}
   - Maintenance tasks reference attachments by taskId. We render tiny thumbnails on each card.
   - ‚ÄúAttachments‚Äù button opens a manager overlay (drag-drop, file input, preview, delete).
   - Lightbox preview on click (Esc closes).
   - // TODO: Backend Storage ‚Äî persist files.
*/

/* ---------- A) Card gallery & ‚ÄúAttachments‚Äù button wiring ---------- */
(function attachMaintenanceGalleries(){
  const prevPaint = Views.maintenance;
  Views.maintenance = function(){
    prevPaint();               // render the board first
    paintAllCardGalleries();   // then augment with galleries & button
    wireBoardObserver();       // keep it updated on DOM changes
  };

  function paintAllCardGalleries(){
    const board = document.getElementById('view');
    if (!board) return;
    board.querySelectorAll('.kb-card').forEach(card=>{
      const id = card.dataset.id;
      const task = Store.maint.tasks.find(t=>t.id===id);
      if (!task) return;

      // Add gallery node if missing
      let g = card.querySelector('.kb-gallery');
      if (!g){
        g = document.createElement('div');
        g.className = 'kb-gallery';
        card.appendChild(g);
      }
      g.innerHTML = '';
      (Store.files||[]).filter(f=> f.taskId===task.id && /^image\//.test(f.type||'')).slice(0,6).forEach(f=>{
        const t = document.createElement('div');
        t.className = 'kb-thumb';
        t.title = f.name || 'attachment';
        t.innerHTML = `<img alt="" src="${f.dataUrl}">`;
        t.addEventListener('click', ()=> openLightbox(f));
        g.appendChild(t);
      });

      // Ensure an Attachments button exists (placed in actions row)
      const actions = card.querySelector('.kb-actions');
      if (actions && !actions.querySelector('[data-att]')){
        const btn = document.createElement('button');
        btn.className = 'btn xs';
        btn.setAttribute('data-att','1');
        btn.textContent = 'Attachments';
        btn.addEventListener('click', ()=> openAttachmentManager(task.id));
        actions.appendChild(btn);
      }
    });
  }

  function wireBoardObserver(){
    const host = document.getElementById('view');
    if (!host) return;
    const mo = new MutationObserver(()=>{
      // Re-generate galleries when cards move or board repaints
      paintAllCardGalleries();
    });
    mo.observe(host, { childList:true, subtree:true });
  }
})();

/* ---------- B) Attachment manager overlay ---------- */
function openAttachmentManager(taskId){
  const task = Store.maint.tasks.find(t=>t.id===taskId);
  if (!task) return;

  Store.files = Store.files || []; // ensure store exists

  const node = document.createElement('div');
  node.className = 'att-wrap';
  node.innerHTML = `
    <div>
      <h3 style="margin:0 0 6px 0">Attachments ¬∑ ${escapeHTML(task.title)}</h3>
      <div class="subtle">Files are stored in-memory (base64). <code>// TODO: Backend Storage ‚Äî persist files.</code></div>
    </div>

    <div class="att-grid">
      <!-- LEFT: uploader -->
      <section class="att-uploader" id="attDrop">
        <div class="field">
          <label>Upload Files</label>
          <input id="attInput" type="file" accept="image/*,.pdf" multiple>
        </div>
        <div class="subtle" style="margin-top:6px">Drag & drop images or PDFs here. Images get thumbnails; PDFs show as icon.</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="attPaste">Paste Image (Ctrl/Cmd+V)</button>
          <button class="btn ghost" id="attFromClipboard" title="Try reading from Clipboard API (if supported)">From Clipboard</button>
        </div>
      </section>

      <!-- RIGHT: list -->
      <section>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
          <div class="field" style="flex:1"><label>Search</label><input id="attSearch" placeholder="name, tag"></div>
          <button class="btn ghost" id="attExport">Export CSV</button>
        </div>
        <div id="attList" class="att-list"></div>
      </section>
    </div>
  `;
  openOverlay('Attachments', node);

  // Elements
  const els = {
    input: node.querySelector('#attInput'),
    drop: node.querySelector('#attDrop'),
    list: node.querySelector('#attList'),
    search: node.querySelector('#attSearch'),
    pasteBtn: node.querySelector('#attPaste'),
    clipBtn: node.querySelector('#attFromClipboard'),
    exportBtn: node.querySelector('#attExport'),
  };

  // Render on open
  renderList();

  // Wire search
  els.search.addEventListener('input', renderList);

  // Wire file input
  els.input.addEventListener('change', async (e)=>{
    const files = Array.from(e.target.files||[]);
    await addFiles(files);
    renderList(); refreshKanbanThumbs(); Toast.show(`Added ${files.length} file(s)`);
  });

  // Drag & drop
  ;['dragenter','dragover'].forEach(evt=> els.drop.addEventListener(evt, e=>{ e.preventDefault(); els.drop.classList.add('dragover'); }));
  ;['dragleave','drop'].forEach(evt=> els.drop.addEventListener(evt, e=>{ e.preventDefault(); els.drop.classList.remove('dragover'); }));
  els.drop.addEventListener('drop', async (e)=>{
    const dt = e.dataTransfer; if (!dt) return;
    const files = Array.from(dt.files||[]);
    if (!files.length) return;
    await addFiles(files);
    renderList(); refreshKanbanThumbs(); Toast.show(`Added ${files.length} file(s)`);
  });

  // Paste
  els.pasteBtn.addEventListener('click', ()=>{
    Toast.show('Press Ctrl/‚åò+V in this overlay to paste an image');
    node.addEventListener('paste', onPasteOnce, { once:true });
  });
  function onPasteOnce(e){
    const items = Array.from(e.clipboardData?.items||[]);
    const fileItems = items.filter(it=> it.kind==='file');
    if (!fileItems.length) return Toast.show('No image in clipboard');
    const blob = fileItems[0].getAsFile();
    addFiles([blob]).then(()=>{ renderList(); refreshKanbanThumbs(); Toast.show('Pasted image'); });
  }

  // Clipboard API (best-effort)
  els.clipBtn.addEventListener('click', async ()=>{
    try{
      // Some browsers gate this behind permissions
      const items = await navigator.clipboard.read();
      for (const it of items){
        for (const t of it.types){
          if (t.startsWith('image/')){
            const blob = await it.getType(t);
            await addFiles([blob]);
            renderList(); refreshKanbanThumbs(); Toast.show('Imported from clipboard');
            return;
          }
        }
      }
      Toast.show('No image found on clipboard');
    } catch { Toast.show('Clipboard read not supported'); }
  });

  // Export CSV
  els.exportBtn.addEventListener('click', ()=>{
    const out = toCSV((Store.files||[]).filter(f=>f.taskId===taskId));
    downloadCSV('attachments.csv', out);
  });

  /* ---- helpers ---- */
  async function addFiles(files){
    for (const file of files){
      const dataUrl = await fileToDataURL(file);
      const ext = (file.name||'').split('.').pop()?.toLowerCase() || '';
      const id = 'f'+Math.random().toString(36).slice(2,9);
      Store.files.push({
        id, name: file.name || `upload.${ext||'dat'}`,
        dataUrl, type: file.type || guessType(ext),
        tags: [], taskId, createdAt: Date.now()
      });
      // TODO: Backend Storage ‚Äî persist files
    }
  }
  function fileToDataURL(file){
    return new Promise((res,rej)=>{
      const r = new FileReader();
      r.onload = ()=> res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }
  function guessType(ext){
    if (['png','jpg','jpeg','gif','webp','avif','bmp'].includes(ext)) return 'image/'+(ext==='jpg'?'jpeg':ext);
    if (ext==='pdf') return 'application/pdf';
    return 'application/octet-stream';
  }

  function renderList(){
    const q = els.search.value.toLowerCase().trim();
    const rows = (Store.files||[]).filter(f=> f.taskId===taskId && (!q || `${f.name} ${(f.tags||[]).join(' ')}`.toLowerCase().includes(q)));
    if (!rows.length){
      els.list.innerHTML = `<div class="kb-empty">No files yet.</div>`;
      return;
    }
    els.list.innerHTML = rows.map(f=> attCardHTML(f)).join('');
    els.list.querySelectorAll('[data-open]').forEach(btn=>{
      const id = btn.getAttribute('data-open');
      btn.addEventListener('click', ()=> {
        const f = Store.files.find(x=>x.id===id); if (!f) return;
        if (/^image\//.test(f.type||'')) openLightbox(f);
        else window.open(f.dataUrl, '_blank'); // pdf/other
      });
    });
    els.list.querySelectorAll('[data-del]').forEach(btn=>{
      const id = btn.getAttribute('data-del');
      btn.addEventListener('click', ()=>{
        if (!confirm('Delete this file?')) return;
        const i = Store.files.findIndex(x=>x.id===id);
        if (i>=0) Store.files.splice(i,1);
        renderList(); refreshKanbanThumbs(); Toast.show('Deleted');
      });
    });
    els.list.querySelectorAll('[data-tag]').forEach(inp=>{
      const id = inp.getAttribute('data-tag');
      inp.addEventListener('change', ()=>{
        const f = Store.files.find(x=>x.id===id);
        if (!f) return;
        f.tags = inp.value.split(',').map(s=>s.trim()).filter(Boolean);
        Toast.show('Tags updated');
      });
    });
  }

  function attCardHTML(f){
    const isImg = /^image\//.test(f.type||'');
    const when = f.createdAt ? new Date(f.createdAt).toLocaleString() : '';
    return `
      <article class="att-card">
        ${isImg ? `<img alt="" src="${f.dataUrl}">` : fileIconBlock(f)}
        <div class="att-meta">
          <div style="display:flex;justify-content:space-between;gap:6px">
            <strong style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${escapeHTML(f.name)}">${escapeHTML(f.name)}</strong>
            <span class="pill">${isImg? 'Image' : (f.type||'file')}</span>
          </div>
          <div class="subtle">${when}</div>
          <div class="field">
            <label>Tags (comma)</label>
            <input data-tag="${f.id}" value="${(f.tags||[]).join(', ')}" placeholder="receipt, leak, slip">
          </div>
          <div class="att-actions">
            <button class="btn xs" data-open="${f.id}">Open</button>
            <button class="btn xs ghost" data-del="${f.id}">Delete</button>
          </div>
        </div>
      </article>
    `;
  }
  function fileIconBlock(f){
    const ext = (f.name||'').split('.').pop()?.toUpperCase() || 'FILE';
    return `
      <div style="display:flex;align-items:center;justify-content:center;height:120px;background:linear-gradient(180deg, rgba(0,0,0,.04), transparent)">
        <div class="pill" style="font-weight:800">${ext}</div>
      </div>
    `;
  }
}

/* ---------- C) Lightbox preview ---------- */
function openLightbox(file){
  const box = document.createElement('div');
  box.className = 'lightbox';
  box.innerHTML = `
    <div class="bar">${escapeHTML(file.name||'image')} ‚Äî Esc to close</div>
    <img alt="" src="${file.dataUrl}">
  `;
  document.body.appendChild(box);
  const close = ()=> box.remove();
  box.addEventListener('click', close);
  document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') close(); }, { once:true });
}

/* ---------- D) Keep kanban thumbnails in sync ---------- */
function refreshKanbanThumbs(){
  if (Router.current==='maintenance' && typeof Views.maintenance==='function'){
    Views.maintenance(); // cheap repaint
  }
}

/* ---------- E) Reuse CSV helpers from earlier parts ---------- */
function toCSV(files){
  const head = ['id','taskTitle','name','type','tags','createdAt'];
  const rows = (files||[]).map(f=>{
    const t = Store.maint.tasks.find(x=>x.id===f.taskId);
    return [f.id, t?.title||'', f.name||'', f.type||'', (f.tags||[]).join('|'), f.createdAt? new Date(f.createdAt).toISOString() : ''];
  });
  return [head, ...rows].map(r=> r.map(v=>{
    const s = String(v ?? '');
    return (s.includes(',') || s.includes('"') || /\r|\n/.test(s)) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(',')).join('\n');
}
function downloadCSV(filename, csv){
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
</script>
<!-- ==== PART 21 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 22 START ================================================== -->
<style>
  /* Panel in Builder controls */
  .appendix-panel{
    margin-top:10px; border:1px dashed var(--border); border-radius: var(--radius);
    padding:10px; background: linear-gradient(180deg,transparent,rgba(0,0,0,.03));
  }
  .ap-grid{ display:grid; gap:8px; grid-template-columns: 1fr; }
  .ap-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  .ap-thumbs{ display:grid; gap:8px;
    grid-template-columns: repeat(auto-fill, minmax(88px, 1fr)); max-height:220px; overflow:auto;
    border:1px solid var(--border); border-radius:12px; padding:8px; background: var(--panel);
  }
  .ap-thumb{
    position:relative; border:1px solid var(--border); border-radius:8px; overflow:hidden; cursor:pointer;
  }
  .ap-thumb input{ position:absolute; top:6px; left:6px; width:16px; height:16px }
  .ap-thumb img{ display:block; width:100%; height:80px; object-fit:cover; }
  .ap-thumb .cap{ position:absolute; bottom:0; left:0; right:0; font-size:10px; padding:2px 4px;
                  color:#fff; background:linear-gradient(180deg, transparent, rgba(0,0,0,.65)); white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

  /* Print appendix pages */
  .print-appendix{ page-break-before: always; padding:20mm 15mm; }
  .ap-title{ font-weight:700; margin:0 0 6mm 0; font-size:14pt; }
  .ap-grid-print{ display:grid; gap:6mm; grid-template-columns: repeat(3, 1fr); }
  .ap-tile{ border:1px solid #999; border-radius:6px; padding:3mm; }
  .ap-tile img{ width:100%; height:70mm; object-fit:contain; display:block; border-radius:4px; }
  .ap-caption{ font-size:9pt; margin-top:3mm; color:#333; word-break: break-all; }
  @media (max-width: 900px){
    .ap-grid-print{ grid-template-columns: 1fr; }
  }
  @media print{
    .appendix-panel{ display:none !important; }
    .print-appendix{ display:block }
  }
</style>

<script>
/* ========================= PART 22 SCRIPT ========================= */

/* Features
   - Builder gets an "Slip Appendix" panel with:
       [x] Include checkbox
       [Filter] Tag filter (e.g., "slip", "receipt")
       [Buttons] Select All / None / Auto-pick (by tag)
       [Thumb grid] choose images (from Store.files, image/*)
   - Selections persist per Doc No (extends Part 12's aptAdminDocPrefs).
   - On preview/print, we inject pages after #printSheet with tiled images.
*/

(function addSlipAppendixToBuilder(){
  const prevNav = Router.navigate.bind(Router);
  Router.navigate = function(route){
    prevNav(route);
    if (route === 'builder') setTimeout(initPanelOnce, 0);
  };

  function initPanelOnce(){
    const grid = document.querySelector('.builder-grid');
    const ctrlCard = grid ? grid.querySelector('.card') : null;
    if (!grid || !ctrlCard) return;
    if (ctrlCard.querySelector('.appendix-panel')) return;

    // Panel UI
    const panel = document.createElement('div');
    panel.className = 'appendix-panel';
    panel.innerHTML = `
      <h3 style="margin:0 0 8px 0">Slip Appendix (print)</h3>
      <div class="ap-grid">
        <div class="ap-actions">
          <label style="display:flex;align-items:center;gap:6px">
            <input id="apEnable" type="checkbox"> Include in print
          </label>
          <div class="field" style="min-width:180px">
            <label>Tag filter</label>
            <input id="apTag" placeholder="e.g., slip, receipt">
          </div>
          <button class="btn" id="apAll">Select All</button>
          <button class="btn ghost" id="apNone">None</button>
          <button class="btn" id="apAuto">Auto-pick</button>
          <span class="subtle">Selections remembered per document.</span>
        </div>
        <div id="apThumbs" class="ap-thumbs" role="listbox" aria-multiselectable="true"></div>
      </div>
    `;
    ctrlCard.appendChild(panel);

    // elements
    const els = {
      enable: panel.querySelector('#apEnable'),
      tag: panel.querySelector('#apTag'),
      thumbs: panel.querySelector('#apThumbs'),
      btnAll: panel.querySelector('#apAll'),
      btnNone: panel.querySelector('#apNone'),
      btnAuto: panel.querySelector('#apAuto'),
    };

    // restore prefs
    const prefs = getDocPrefs();
    els.enable.checked = !!prefs.apEnabled;
    els.tag.value = prefs.apTag || '';
    // render thumb list
    paintThumbs();

    // wire
    panel.addEventListener('input', ()=>{
      savePrefs({
        apEnabled: els.enable.checked,
        apTag: els.tag.value.trim(),
      });
      // live update appendix if already previewed once
      rebuildAppendix();
    });
    els.btnAll.addEventListener('click', ()=>{ bulkSelect(true); });
    els.btnNone.addEventListener('click', ()=>{ bulkSelect(false); });
    els.btnAuto.addEventListener('click', ()=>{
      const tag = (els.tag.value || 'slip').toLowerCase();
      const ids = imageFiles().filter(f=> (f.tags||[]).map(t=>t.toLowerCase()).includes(tag)).map(f=>f.id);
      const p = getDocPrefs();
      p.apSel = ids; saveAllPrefsForDoc(p);
      paintThumbs(); rebuildAppendix(); Toast.show(`Auto-picked ${ids.length} by tag "${tag}"`);
    });

    // Hook Preview button to ensure appendix is built
    const prevBtn = document.querySelector('#bdPreview');
    prevBtn?.addEventListener('click', rebuildAppendix);

    // Also rebuild when totals/items change (to keep header info in appendix)
    const printSheet = document.getElementById('printSheet');
    if (printSheet){
      const mo = new MutationObserver(()=> rebuildAppendix());
      mo.observe(printSheet, { childList:true, subtree:true });
    }

    /* ---- functions ---- */
    function paintThumbs(){
      const files = filteredFiles();
      const sel = new Set((getDocPrefs().apSel||[]));
      if (!files.length){
        els.thumbs.innerHTML = `<div class="kb-empty">No images found. Upload in <b>Files</b> or attach to Maintenance, then return.</div>`;
        return;
      }
      els.thumbs.innerHTML = '';
      files.forEach(f=>{
        const w = document.createElement('div');
        w.className = 'ap-thumb';
        w.setAttribute('role','option');
        w.setAttribute('aria-selected', sel.has(f.id) ? 'true' : 'false');
        w.innerHTML = `
          <input type="checkbox" ${sel.has(f.id)?'checked':''} aria-label="Select ${escapeHTML(f.name||'image')}">
          <img alt="" src="${f.dataUrl}">
          <div class="cap" title="${escapeHTML(f.name||'image')}">${escapeHTML((f.name||'').slice(0,28))}</div>
        `;
        const box = w.querySelector('input');
        box.addEventListener('change', ()=>{
          toggleFile(f.id, box.checked);
          w.setAttribute('aria-selected', box.checked ? 'true' : 'false');
          rebuildAppendix();
        });
        w.addEventListener('click', (e)=>{ if (e.target!==box){ box.checked = !box.checked; box.dispatchEvent(new Event('change', { bubbles:true })); }});
        els.thumbs.appendChild(w);
      });
    }

    function bulkSelect(on){
      const files = filteredFiles();
      const ids = on ? files.map(f=>f.id) : [];
      const p = getDocPrefs(); p.apSel = ids; saveAllPrefsForDoc(p);
      paintThumbs(); rebuildAppendix();
    }

    function filteredFiles(){
      const q = (els.tag.value||'').toLowerCase().trim();
      let list = imageFiles();
      if (q){
        list = list.filter(f=> (f.tags||[]).some(t=> String(t).toLowerCase().includes(q))
          || String(f.name||'').toLowerCase().includes(q));
      }
      return list;
    }

    function imageFiles(){
      const all = (Store.files||[]).filter(f=> /^image\//.test(f.type||''));
      // Optional: try to infer by building/room from Builder selection
      const roomId = document.getElementById('bdRoom')?.value || null;
      if (!roomId) return all;
      // Prefer files whose name or tags mention the room number
      const roomNo = Store.rooms.find(r=>r.id===roomId)?.roomNo || '';
      return all.sort((a,b)=>{
        const sa = score(a), sb = score(b); return sb - sa;
      });
      function score(f){
        const t = `${(f.name||'')} ${(f.tags||[]).join(' ')}`.toLowerCase();
        return t.includes(String(roomNo).toLowerCase()) ? 1 : 0;
      }
    }

    function toggleFile(id, on){
      const p = getDocPrefs();
      const set = new Set(p.apSel||[]);
      if (on) set.add(id); else set.delete(id);
      p.apSel = [...set]; saveAllPrefsForDoc(p);
    }
  }

  /* ---------- Appendix builder ---------- */
  function rebuildAppendix(){
    const prefs = getDocPrefs();
    const enabled = !!prefs.apEnabled;
    const sheet = document.getElementById('printSheet');
    if (!sheet) return;

    // Remove previous appendix
    sheet.parentElement?.querySelectorAll('.print-appendix').forEach(n=>n.remove());
    if (!enabled) return;

    const files = (Store.files||[]).filter(f=> (prefs.apSel||[]).includes(f.id) && /^image\//.test(f.type||''));
    if (!files.length) return;

    // Chunk into pages of 6 tiles (3x2)
    const pages = chunk(files, 6);
    pages.forEach((arr, i)=>{
      const page = document.createElement('section');
      page.className = 'print-appendix';
      page.innerHTML = `
        <div class="ap-title">Appendix ‚Äî ${docTitleLine()} (Page ${i+1}/${pages.length})</div>
        <div class="ap-grid-print">
          ${arr.map(renderTile).join('')}
        </div>
      `;
      sheet.parentElement.appendChild(page);
    });

    function renderTile(f){
      const when = f.createdAt ? new Date(f.createdAt).toISOString().slice(0,10) : '';
      return `
        <div class="ap-tile">
          <img alt="" src="${f.dataUrl}">
          <div class="ap-caption">${escapeHTML(f.name||'image')}${when?` ‚Äî ${when}`:''}</div>
        </div>
      `;
    }
    function docTitleLine(){
      const type = (document.getElementById('bdType')?.value || 'INVOICE').toUpperCase();
      const no   = document.getElementById('bdNo')?.value || 'DOC';
      const room = Store.rooms.find(r=> r.id === (document.getElementById('bdRoom')?.value||''))?.roomNo || '';
      return `${type} ${no}${room?` ¬∑ Room ${room}`:''}`;
    }
  }

  /* ---------- Prefs helpers (extends Part 12‚Äôs aptAdminDocPrefs) ---------- */
  function getDocKey(){ return (document.getElementById('bdNo')?.value || 'DOC').trim(); }
  function loadAllPrefs(){ try{ return JSON.parse(localStorage.getItem('aptAdminDocPrefs')||'{}'); } catch{ return {}; } }
  function saveAllPrefsForDoc(obj){
    const all = loadAllPrefs(); all[getDocKey()] = { ...(all[getDocKey()]||{}), ...obj };
    localStorage.setItem('aptAdminDocPrefs', JSON.stringify(all));
  }
  function getDocPrefs(){ const all = loadAllPrefs(); return all[getDocKey()] || {}; }
  function savePrefs(patch){ saveAllPrefsForDoc(patch); }

  /* ---------- Small utilities ---------- */
  function chunk(arr, n){ const out=[]; for(let i=0;i<arr.length;i+=n) out.push(arr.slice(i,i+n)); return out; }
  function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
})();
</script>
<!-- ==== PART 22 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 23 START ================================================== -->
<style>
  .bk-wrap { margin-top:10px; border:1px dashed var(--border); border-radius:var(--radius); padding:10px; background:linear-gradient(180deg,transparent,rgba(0,0,0,.03)); }
  .bk-grid { display:grid; gap:8px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 900px){ .bk-grid { grid-template-columns: 1fr; } }
  .bk-row  { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .mini    { font-size:12px; color:var(--muted); }
  .btn.sm  { padding:6px 10px; border-radius:10px; font-size:12px; }
</style>

<script>
/* ========================= PART 23 SCRIPT ========================= */

/* Goal
   - When the "Session Tools" overlay (Part 10) opens, inject a Backup/Restore panel:
       ‚Ä¢ Download Backup (JSON with schema version)
       ‚Ä¢ Restore from File (safe merge)
       ‚Ä¢ Autosave toggle (every N minutes & on navigation)
   - Works without editing earlier parts; we detect overlay title and enhance it.
*/

(function enhanceSessionToolsWithBackup(){
  const overlay = document.getElementById('overlay');
  if (!overlay) return;

  const SCHEMA_VER = 1; // bump if structure changes in the future
  const AUTOSAVE_KEY = 'aptAdminAutosave';
  const SNAPSHOT_KEY = 'aptAdminStore'; // same as Part 10 for compatibility

  // Observe overlay contents; if it's "Session Tools", augment it
  const mo = new MutationObserver(()=>{
    if (!overlay.classList.contains('open')) return;
    const title = overlay.querySelector('#sheetTitle')?.textContent?.trim() || '';
    if (!/session tools/i.test(title)) return;

    const body = overlay.querySelector('#sheetBody');
    if (!body || body._bkWired) return;
    body._bkWired = true;

    const panel = document.createElement('div');
    panel.className = 'bk-wrap';
    panel.innerHTML = `
      <h3 style="margin:0 0 6px 0">Backup & Restore</h3>
      <div class="bk-grid">
        <section>
          <div class="bk-row">
            <button class="btn" id="bkDownload">Download Backup</button>
            <span class="mini">Schema v${SCHEMA_VER}. Includes rooms, renters, invoices, files (base64), settings, maintenance.</span>
          </div>
          <div class="bk-row" style="margin-top:6px">
            <input type="file" id="bkFile" accept="application/json">
            <button class="btn sm" id="bkRestore">Restore from File</button>
          </div>
          <div class="mini" id="bkInfo"></div>
        </section>
        <section>
          <div class="bk-row">
            <label class="mini" style="display:flex;align-items:center;gap:8px">
              <input id="bkAutosave" type="checkbox"> Autosave to Browser
            </label>
            <select id="bkInterval" class="btn sm" title="Autosave interval">
              <option value="2">Every 2 min</option>
              <option value="5" selected>Every 5 min</option>
              <option value="10">Every 10 min</option>
            </select>
            <button class="btn sm ghost" id="bkSaveNow">Save Now</button>
          </div>
          <div class="mini">Autosave writes to your browser‚Äôs storage only. Use Download to keep a portable backup file.</div>
        </section>
      </div>
    `;
    body.appendChild(panel);

    // Wire buttons
    const els = {
      download: panel.querySelector('#bkDownload'),
      file:     panel.querySelector('#bkFile'),
      restore:  panel.querySelector('#bkRestore'),
      info:     panel.querySelector('#bkInfo'),
      auto:     panel.querySelector('#bkAutosave'),
      every:    panel.querySelector('#bkInterval'),
      saveNow:  panel.querySelector('#bkSaveNow'),
    };

    // Restore saved autosave prefs
    const savedAuto = JSON.parse(localStorage.getItem(AUTOSAVE_KEY) || 'null');
    if (savedAuto){
      els.auto.checked = !!savedAuto.on;
      if (savedAuto.every) els.every.value = String(savedAuto.every);
    }

    els.download.addEventListener('click', ()=>{
      const payload = makeBackup();
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'apt-admin-backup.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      Toast.show('Backup downloaded');
    });

    els.restore.addEventListener('click', async ()=>{
      const file = els.file.files?.[0];
      if (!file) return Toast.show('Choose a .json file first');
      try{
        const text = await file.text();
        const json = JSON.parse(text);
        const report = safeRestore(json);
        els.info.textContent = report.message;
        Toast.show(report.toast);
        // repaint current route to reflect
        const r = Router.current; Router.navigate(r);
      } catch(err){
        console.error(err);
        Toast.show('Restore failed (invalid file)');
      }
    });

    function persistAutosavePrefs(){
      const cfg = { on: !!els.auto.checked, every: Number(els.every.value||5) };
      localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(cfg));
      setupAutosaveTimer(cfg);
    }

    els.auto.addEventListener('change', persistAutosavePrefs);
    els.every.addEventListener('change', persistAutosavePrefs);
    els.saveNow.addEventListener('click', ()=> {
      try { localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(structuredCloneSafe(Store))); Toast.show('Saved to browser'); }
      catch(err){ console.error(err); Toast.show('Save failed'); }
    });

    // Start timer (or stop) according to prefs
    persistAutosavePrefs();
  });

  mo.observe(overlay, { attributes:true, attributeFilter:['class'], childList:true, subtree:true });

  /* ---- Autosave engine ---- */
  let autosaveTimer = null;
  function setupAutosaveTimer(cfg){
    if (autosaveTimer){ clearInterval(autosaveTimer); autosaveTimer = null; }
    if (!cfg.on) return;
    const ms = Math.max(1, Number(cfg.every||5)) * 60_000;
    autosaveTimer = setInterval(snapshotToLocal, ms);
    // Also snapshot on route changes (lightweight)
    patchRouteSnapshot();
  }

  function snapshotToLocal(){
    try {
      const snap = structuredCloneSafe(Store);
      localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(snap));
      // No toast ‚Äî silent autosave
    } catch(err){
      console.error('Autosave failed', err);
    }
  }

  let routePatched = false;
  function patchRouteSnapshot(){
    if (routePatched) return;
    routePatched = true;
    const prev = Router.navigate.bind(Router);
    Router.navigate = function(route){
      snapshotToLocal();
      return prev(route);
    };
    window.addEventListener('beforeunload', snapshotToLocal);
  }

  /* ---- Backup/Restore helpers ---- */
  function makeBackup(){
    // Keep only serializable slices
    const payload = {
      _schema: 'aptAdminStoreV' + SCHEMA_VER,
      _ts: Date.now(),
      store: structuredCloneSafe(Store)
    };
    return payload;
  }

  function safeRestore(json){
    // Validate schema
    if (!json || typeof json !== 'object' || !String(json._schema||'').startsWith('aptAdminStoreV')){
      return { toast:'Not a valid backup file', message:'Schema not recognized.' };
    }

    // Merge known slices
    const incoming = json.store || {};
    const keys = [
      'rooms','renters','invoices','bankAccounts','addresses','utilities',
      'defaults','files','terms','dueDays','ratePresets','maint','_meterMem'
    ];
    let merged = 0, skipped = 0;

    keys.forEach(k=>{
      if (k in incoming){
        try { Store[k] = incoming[k]; merged++; }
        catch{ skipped++; }
      }
    });

    // Mark seeded & repaint
    Store._seeded = true;

    // Persist to local as an immediate safety net
    try { localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(structuredCloneSafe(Store))); } catch{}

    return {
      toast: `Restored (${merged} key(s) merged${skipped?`, ${skipped} skipped`:''})`,
      message: `Merged: ${merged}. Skipped: ${skipped}. Timestamp: ${new Date(json._ts||Date.now()).toLocaleString()}.`
    };
  }

  function structuredCloneSafe(src){
    const seen = new WeakSet();
    return JSON.parse(JSON.stringify(src, (k,v)=>{
      if (typeof v === 'function') return undefined;
      if (typeof v === 'object' && v !== null){
        if (seen.has(v)) return undefined;
        seen.add(v);
      }
      return v;
    }));
  }
})();
</script>
<!-- ==== PART 23 END ==================================================== -->
<!-- ========================= PART MARKERS =============================== -->
<!-- ==== PART 24 START ================================================== -->
<style>
  /* Visually hidden utility for ARIA */
  .sr-only {
    position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }

  /* Skip to content link */
  .skip-link {
    position: fixed; top: 6px; left: 6px; z-index: 10000;
    background: var(--panel); border:1px solid var(--border);
    padding: 8px 10px; border-radius: 10px; box-shadow: var(--shadow);
    transform: translateY(-130%); transition: transform .15s ease;
  }
  .skip-link:focus { transform: translateY(0); outline: 2px solid var(--accent, #6366f1); }

  /* Focus ring consistency (keyboard) */
  :where(button, [role="tab"], a, input, select, textarea):focus-visible {
    outline: 2px solid var(--accent, #6366f1);
    outline-offset: 2px;
    border-radius: 10px;
  }

  /* Reduced motion friendliness */
  @media (prefers-reduced-motion: reduce) {
    * { transition-duration: 0.001ms !important; animation-duration: 0.001ms !important; }
  }
</style>

<!-- Skip link + live region (insert near top of body) -->
<a href="#view" class="skip-link">Skip to main content</a>
<div id="ariaLive" class="sr-only" aria-live="polite" aria-atomic="true"></div>

<script>
/* ========================= PART 24 SCRIPT ========================= */

/* A) Dialog semantics + focus trap for the global overlay (#overlay)
      - Adds role="dialog" and aria-modal
      - Labels via #sheetTitle, describes via #sheetBody
      - Traps focus within while open; restores focus to invoker on close
*/
(function enhanceOverlayA11y(){
  const overlay = document.getElementById('overlay');
  if (!overlay) return;

  let lastFocusBeforeOpen = null;

  function focusablesIn(root){
    return Array.from(root.querySelectorAll(
      'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
    )).filter(el => !el.hasAttribute('disabled') && el.offsetParent !== null);
  }

  function labelDialog(){
    const sheet = overlay.querySelector('.sheet'); if (!sheet) return;
    overlay.setAttribute('role','dialog');
    overlay.setAttribute('aria-modal','true');
    const title = document.getElementById('sheetTitle');
    const body  = document.getElementById('sheetBody');
    if (title){ overlay.setAttribute('aria-labelledby','sheetTitle'); }
    if (body){  overlay.setAttribute('aria-describedby','sheetBody'); }
  }

  // Open/close observer
  const mo = new MutationObserver(()=>{
    const open = overlay.classList.contains('open');
    const sheet = overlay.querySelector('.sheet');
    if (open){
      labelDialog();
      // remember last focus
      lastFocusBeforeOpen = document.activeElement;
      // move focus to close button or first focusable
      const first = overlay.querySelector('#sheetClose') || focusablesIn(sheet)[0];
      if (first) first.focus({ preventScroll:true });

      // trap focus
      overlay.addEventListener('keydown', trapper);
    } else {
      overlay.removeEventListener('keydown', trapper);
      // restore focus
      setTimeout(()=> {
        try { lastFocusBeforeOpen?.focus(); } catch { /* ignore */ }
      }, 0);
    }
  });
  mo.observe(overlay, { attributes:true, attributeFilter:['class'] });

  function trapper(e){
    if (e.key !== 'Tab') return;
    const sheet = overlay.querySelector('.sheet'); if (!sheet) return;
    const list = focusablesIn(sheet);
    if (!list.length) return;
    const first = list[0], last = list[list.length-1];
    if (e.shiftKey && document.activeElement === first){ last.focus(); e.preventDefault(); }
    else if (!e.shiftKey && document.activeElement === last){ first.focus(); e.preventDefault(); }
  }
})();

/* B) Tabs ARIA: give any tablist consistent roles and keyboard (‚Üê/‚Üí/Home/End)
      - Works on elements that already look like tabs (have [role="tablist"], or
        contain multiple [data-tab] or .tab elements).
*/
(function normalizeTabs(){
  function wireTablist(root){
    const list = root;
    const tabs = Array.from(list.querySelectorAll('[role="tab"], [data-tab], .tab'))
      .filter(Boolean).map(el=>{
        el.setAttribute('role','tab');
        if (!el.id) el.id = 'tab_' + Math.random().toString(36).slice(2,9);
        return el;
      });
    if (!tabs.length) return;

    list.setAttribute('role','tablist');
    // Find tabpanels by aria-controls or [data-panel-for]
    tabs.forEach((tab, i)=>{
      // Pick a panel: data-panel-for="#id" or aria-controls attribute, else none
      let panel = null;
      const ctrl = tab.getAttribute('aria-controls') || tab.getAttribute('data-panel-for');
      if (ctrl) panel = document.querySelector(ctrl.startsWith('#')? ctrl : ('#'+ctrl));
      if (panel){
        panel.setAttribute('role','tabpanel');
        panel.setAttribute('aria-labelledby', tab.id);
        if (i !== 0 && tab.getAttribute('aria-selected')!=='true'){ panel.hidden = true; }
      }
      // Initialize selection
      const isSelected = tab.getAttribute('aria-selected') === 'true' || i === 0;
      tab.setAttribute('aria-selected', String(isSelected));
      tab.setAttribute('tabindex', isSelected ? '0' : '-1');

      tab.addEventListener('click', ()=> activate(tab, tabs));
      tab.addEventListener('keydown', (e)=>{
        const idx = tabs.indexOf(tab);
        if (e.key === 'ArrowRight'){ e.preventDefault(); tabs[(idx+1)%tabs.length].focus(); }
        if (e.key === 'ArrowLeft'){  e.preventDefault(); tabs[(idx-1+tabs.length)%tabs.length].focus(); }
        if (e.key === 'Home'){ e.preventDefault(); tabs[0].focus(); }
        if (e.key === 'End'){  e.preventDefault(); tabs[tabs.length-1].focus(); }
        if (e.key === 'Enter' || e.key === ' '){ e.preventDefault(); activate(tab, tabs); }
      });
    });

    function activate(tab, tabs){
      tabs.forEach(t=>{
        const on = (t === tab);
        t.setAttribute('aria-selected', String(on));
        t.setAttribute('tabindex', on ? '0' : '-1');
        const ctrl = t.getAttribute('aria-controls') || t.getAttribute('data-panel-for');
        if (ctrl){
          const panel = document.querySelector(ctrl.startsWith('#')? ctrl : ('#'+ctrl));
          if (panel) panel.hidden = !on;
        }
      });
      tab.focus();
    }
  }

  // Scan initial DOM (sidebar tabs, overlay tabs, etc.)
  function scan(){
    const candidates = [
      ...document.querySelectorAll('[role="tablist"]'),
      ...document.querySelectorAll('.tabs-sticky'),
      ...document.querySelectorAll('[data-tabs]')
    ];
    candidates.forEach(el=> { if (!el._a11yTabsWired){ el._a11yTabsWired = true; wireTablist(el); } });
  }
  // initial + on route/overlay changes
  scan();
  const overlay = document.getElementById('overlay');
  const mo = new MutationObserver(scan);
  mo.observe(document.body, { childList:true, subtree:true, attributes:true, attributeFilter:['class'] });
  if (overlay) mo.observe(overlay, { childList:true, subtree:true, attributes:true, attributeFilter:['class'] });
})();

/* C) Live-region announcements: patch Toast.show to also speak updates */
(function patchToastToAria(){
  const live = document.getElementById('ariaLive');
  if (!live) return;
  const orig = window.Toast && window.Toast.show ? window.Toast.show.bind(window.Toast) : null;
  window.Toast = window.Toast || {};
  window.Toast.show = function(msg){
    // Update live region so screen readers announce it
    live.textContent = String(msg || '');
    // Also call original if present
    if (orig) orig(msg); else {
      // Fallback: tiny visual toast if original didn't exist
      console.log('[Toast]', msg);
    }
  };
})();

/* D) Theme toggle ARIA polish (label + reduced motion friendly transition) */
(function themeTogglePolish(){
  const tgl = document.getElementById('themeToggle');
  if (!tgl) return;
  tgl.setAttribute('aria-label','Toggle dark mode');
  // Respect prefers-reduced-motion on theme flips by briefly removing transitions
  tgl.addEventListener('click', ()=>{
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){
      const root = document.documentElement;
      const prev = root.style.transition;
      root.style.transition = 'none';
      requestAnimationFrame(()=> { root.style.transition = prev || ''; });
    }
  });
})();

/* E) Main content should be landmarked */
(function markLandmarks(){
  const view = document.getElementById('view');
  if (view && !view.getAttribute('role')) view.setAttribute('role','main');
})();
</script>
<!-- ==== PART 24 END ==================================================== -->
